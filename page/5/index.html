<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Cellophane&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Cellophane&#39;s blog">
<meta property="og:url" content="https://liuyuqi21.github.io/page/5/index.html">
<meta property="og:site_name" content="Cellophane&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Cellophane">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="/icon.ico">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-base16-ateliersulphurpool.light.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Cellophane&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://liuyuqi21.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-各类文章合集" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/%E5%90%84%E7%B1%BB%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/" class="article-date">
  <time datetime="2019-04-16T13:55:28.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/16/%E5%90%84%E7%B1%BB%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/">各类文章合集</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><ul>
<li><a href="https://segmentfault.com/a/1190000008131735" target="_blank" rel="noopener">MySQL 性能优化神器 Explain 使用分析</a></li>
<li><a href="https://www.jfox.info/2017/20-tiao-mysql-xing-nen-you-hua-de-zui-jia-jing-yan.html" target="_blank" rel="noopener">20+条MySQL性能优化的最佳经验</a></li>
<li><a href="https://www.jianshu.com/p/43091bfa8aa7" target="_blank" rel="noopener">MySQL慢查询&amp;分析SQL执行效率浅谈</a></li>
<li><a href="https://blog.csdn.net/xiangwanpeng/article/details/54310955" target="_blank" rel="noopener">数据库索引是怎样工作的？</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/23624390" target="_blank" rel="noopener">深入浅出数据库索引原理</a></li>
<li><a href="http://www.uml.org.cn/sjjm/201107145.asp" target="_blank" rel="noopener">MySQl 索引背后的数据结构及算法原理</a></li>
<li><a href="https://www.cnblogs.com/songwenjie/p/9409852.html" target="_blank" rel="noopener">MySQL——通过EXPLAIN分析SQL的执行计划</a></li>
<li><a href="https://www.cnblogs.com/songwenjie/p/9402295.html" target="_blank" rel="noopener">MySQL——索引优化实战</a></li>
<li><a href="https://www.jianshu.com/p/54c6d5db4fe6" target="_blank" rel="noopener">《高性能MySQL》读后感——聚簇索引</a></li>
<li><a href="http://www.fordba.com/spend-10-min-to-understand-how-mysql-use-index.html" target="_blank" rel="noopener">10分钟让你明白MySQL是如何利用索引的</a></li>
<li><a href="https://www.cnblogs.com/JetpropelledSnake/p/9094280.html#_label8" target="_blank" rel="noopener">SQL学习笔记五之MySQL索引原理与慢查询优化</a></li>
</ul>
<h2 id="计算机网络"><a href="#计算机网络" class="headerlink" title="计算机网络"></a>计算机网络</h2><ul>
<li><a href="https://www.jianshu.com/p/e7f45779008a" target="_blank" rel="noopener">tcp建立连接为什么需要三次握手</a></li>
<li><a href="https://www.jianshu.com/p/7d0f91345483" target="_blank" rel="noopener">TCP 为什么是三次握手四次挥手？</a></li>
<li><a href="https://mp.weixin.qq.com/s/NIjxgx4NPn7FC4PfkHBAAQ" target="_blank" rel="noopener">TCP 为什么是三次握手，而不是两次或四次？</a></li>
<li><a href="http://www.blogjava.net/yongboy/archive/2015/05/07/424917.html" target="_blank" rel="noopener">TCP协议缺陷不完全记录</a></li>
<li><a href="https://imququ.com/post/web-security-and-response-header.html" target="_blank" rel="noopener">一些安全相关的HTTP响应头</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25690011" target="_blank" rel="noopener">Web通信中传统轮询、长轮询和WebSocket简介</a></li>
</ul>
<h2 id="面试知识点"><a href="#面试知识点" class="headerlink" title="面试知识点"></a>面试知识点</h2><ul>
<li><a href="https://xianyunyh.gitbooks.io/php-interview/Mysql/" target="_blank" rel="noopener">php-interview</a></li>
</ul>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><ul>
<li><a href="https://www.jianshu.com/p/72c579528337" target="_blank" rel="noopener">Linux查找命令</a></li>
<li><a href="https://www.jianshu.com/p/b94644559308" target="_blank" rel="noopener">LINUX中如何查看某个端口是否被占用</a></li>
<li><a href="https://www.cnblogs.com/peida/archive/2013/03/08/2949194.html" target="_blank" rel="noopener">每天一个linux命令（56）：netstat命令</a></li>
<li><a href="https://blog.biezhi.me/2017/08/write-code-must-linux-command.html" target="_blank" rel="noopener">写代码怎能不会这些 Linux 命令？</a></li>
</ul>
<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><ul>
<li><a href="https://juejin.im/entry/592257b62f301e006b183b95" target="_blank" rel="noopener">操作系统面试重难点总结</a></li>
<li><a href="https://www.cnblogs.com/memewry/archive/2012/08/25/2656966.html" target="_blank" rel="noopener"></a></li>
<li><a href="https://www.imooc.com/article/11015" target="_blank" rel="noopener">BAT面试之操作系统内存详解</a></li>
</ul>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><ul>
<li><a href="https://www.mantis.vip/posts/2018-03-24-Nginx%E4%B8%8Ephp-fpm%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%E5%8F%8A%E5%8C%BA%E5%88%AB.html" target="_blank" rel="noopener">Nginx与php-fpm之间的通信方式及区别</a></li>
<li><a href="https://learnku.com/articles/23694" target="_blank" rel="noopener">PHP-FPM 与 Nginx 的通信机制总结</a></li>
<li><a href="https://www.cnblogs.com/wujuntian/p/5768336.html" target="_blank" rel="noopener">PHP常用配置</a></li>
<li><a href="http://www.laruence.com/2008/06/18/221.html" target="_blank" rel="noopener">深入理解PHP原理之Opcodes</a></li>
<li><a href="https://www.hoohack.me/2016/02/15/understanding-phps-internal-array-implementation-ch" target="_blank" rel="noopener">【译】理解数组在PHP内部的实现（给PHP开发者的PHP源码-第四部分）</a></li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li><a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html" target="_blank" rel="noopener">常用 Git 命令清单</a></li>
<li><a href="https://www.cnblogs.com/Sungeek/p/9152223.html#sg3" target="_blank" rel="noopener">SVN与Git比较的优缺点差异</a></li>
<li><a href="https://www.git-tower.com/learn/git/ebook/cn/command-line/introduction" target="_blank" rel="noopener">Learn Version Control with Git</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&mid=2247484609&idx=1&sn=4c053236699fde3c2db1241ab497487b&chksm=ebd745c0dca0ccd682e91938fc30fa947df1385b06d6ae9bb52514967b0736c66684db2f1ac9&token=177635168&lang=zh_CN#rd" target="_blank" rel="noopener">面试前必须要知道的Redis面试题</a></li>
<li><a href="https://juejin.im/post/5cb025fb5188251b0351ef48" target="_blank" rel="noopener">什么是消息队列？</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2016/07/yaml.html" target="_blank" rel="noopener">YAML 语言教程</a></li>
<li><a href="https://www.cnblogs.com/Anker/p/3265058.html" target="_blank" rel="noopener">select、poll、epoll之间的区别总结</a></li>
</ul>
<h2 id="Laravel-设计模式"><a href="#Laravel-设计模式" class="headerlink" title="Laravel/设计模式"></a>Laravel/设计模式</h2><ul>
<li><a href="https://segmentfault.com/a/1190000002411255" target="_blank" rel="noopener">PHP程序员如何理解IoC/DI</a></li>
<li><a href="https://www.insp.top/article/learn-laravel-container" target="_blank" rel="noopener">laravel 学习笔记 —— 神奇的服务容器</a></li>
<li><a href="https://learnku.com/laravel/t/1954/on-laravel-design-pattern#3e05a8" target="_blank" rel="noopener">浅谈 Laravel 设计模式</a></li>
<li><a href="https://github.com/cxp1539/laravel-core-learn" target="_blank" rel="noopener">laravel核心知识学习</a></li>
<li><a href="https://laravelacademy.org/post/3088.html?utm_source=tuicool&utm_medium=referral" target="_blank" rel="noopener">Laravel 中管道设计模式的使用 —— 中间件实现原理探究</a></li>
<li><a href="https://www.cnblogs.com/jade640/p/6773125.html" target="_blank" rel="noopener">laravel 管道设计模式 —— 代码理解</a></li>
<li><a href="https://juejin.im/entry/591ab0a8128fe1005cded993" target="_blank" rel="noopener">Laravel 源码分析——看一次 Http 请求到响应</a></li>
<li><a href="https://www.cnblogs.com/XiongMaoMengNan/p/6644892.html" target="_blank" rel="noopener">Laravel框架一：原理机制篇</a></li>
<li><a href="https://wwxiong.com/hexo_blog/2019/06/15/2019/2019-06-15-laravel-source-code-02/" target="_blank" rel="noopener">【Laravel 源码分析】一次请求的生命周期</a></li>
<li><a href="https://learnku.com/articles/10421/depth-mining-of-laravel-life-cycle#11bfd9" target="_blank" rel="noopener">深度挖掘 Laravel 生命周期</a></li>
</ul>
<p>计算机、软件专业自学或考研可能用到的教学课程：<br>数据结构：<a href="https://www.bilibili.com/video/av38920216/" target="_blank" rel="noopener">av38920216</a><br>计算机组成原理：<a href="https://www.bilibili.com/video/av38976462/" target="_blank" rel="noopener">av38976462</a><br>操作系统：<a href="https://www.bilibili.com/video/av59006688/" target="_blank" rel="noopener">av59006688</a>、<a href="https://www.bilibili.com/video/av59002531/" target="_blank" rel="noopener">av59002531</a><br>计算机网络：<a href="https://www.bilibili.com/video/av58999844/" target="_blank" rel="noopener">av58999844</a><br>计算机体系结构：<a href="https://www.bilibili.com/video/av19929862/" target="_blank" rel="noopener">av19929862</a><br>软件工程：<a href="https://www.bilibili.com/video/av59018769/" target="_blank" rel="noopener">av59018769</a><br>编译原理：<a href="https://www.bilibili.com/video/av59119931/" target="_blank" rel="noopener">av59119931</a><br>数据库：<a href="https://www.bilibili.com/video/av59111036/" target="_blank" rel="noopener">av59111036</a><br>汇编：<a href="https://www.bilibili.com/video/av58986670/" target="_blank" rel="noopener">av58986670</a><br>通信原理：<a href="https://www.bilibili.com/video/av58879979/" target="_blank" rel="noopener">av58879979</a><br>密码学：<a href="https://www.bilibili.com/video/av41333023/" target="_blank" rel="noopener">av41333023</a>、<a href="https://www.bilibili.com/video/av20135839/" target="_blank" rel="noopener">av20135839</a><br>微机原理：<a href="https://www.bilibili.com/video/av59112242/" target="_blank" rel="noopener">av59112242</a><br>考研机构辅导课程：<br>数据结构：<a href="https://www.bilibili.com/video/av58640456/" target="_blank" rel="noopener">av58640456</a><br>计算机组成原理：<a href="https://www.bilibili.com/video/av58627872/" target="_blank" rel="noopener">av58627872</a><br>操作系统：<a href="https://www.bilibili.com/video/av58630026/" target="_blank" rel="noopener">av58630026</a><br>计算机网络：<a href="https://www.bilibili.com/video/av58629608/" target="_blank" rel="noopener">av58629608</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/04/16/%E5%90%84%E7%B1%BB%E6%96%87%E7%AB%A0%E5%90%88%E9%9B%86/" data-id="ckd5e1wxo003g5znrf33w4v85" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PHP-面试知识点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/PHP-%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E7%82%B9/" class="article-date">
  <time datetime="2019-04-16T13:53:20.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/16/PHP-%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E7%82%B9/">PHP 面试知识点</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="引用变量"><a href="#引用变量" class="headerlink" title="引用变量"></a>引用变量</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>在 php 中意味着用不同的名字访问同一个变量内容</p>
<h2 id="定义方式"><a href="#定义方式" class="headerlink" title="定义方式"></a>定义方式</h2><p>使用 &amp; 符号 </p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>COW（Copy On Write）机制：只有在 $a 或者 $b 进行修改操作，才会新开辟一块空间</p>
<pre class="line-numbers language-php"><code class="language-php">    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//查看内存使用情况</span>
    <span class="token comment" spellcheck="true">//定义变量b，将a的值赋值给b</span>
    <span class="token comment" spellcheck="true">//COW机制 Copy On Write 只有在$a或者$b进行修改操作，才会新开辟一块空间</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//此时a,b指向同一块内存空间</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//此时修改$a也不会开辟新的空间。a，b始终指向同一块内存</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">memory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//a指向新开辟了空间</span>
    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">menory_get_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="zval-变量容器"><a href="#zval-变量容器" class="headerlink" title="zval 变量容器"></a>zval 变量容器</h2><p><code>xdebug_debug_zval(&#39;a&#39;);</code> 打印出变量a的结构</p>
<ul>
<li>refcount = 1 代表有一个对象指向这个内存空间</li>
<li>is_ref = 0 表示是不是引用，0 代表 false</li>
</ul>
<h2 id="unset-只会取消引用，不会销毁空间"><a href="#unset-只会取消引用，不会销毁空间" class="headerlink" title="unset 只会取消引用，不会销毁空间"></a>unset 只会取消引用，不会销毁空间</h2><pre class="line-numbers language-php"><code class="language-php">    <span class="token variable">$a</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//取消b的引用</span>
    <span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="对象本身就是引用传递-不会进行空间复制，如果要复制，用-clone"><a href="#对象本身就是引用传递-不会进行空间复制，如果要复制，用-clone" class="headerlink" title="对象本身就是引用传递,不会进行空间复制，如果要复制，用 clone()"></a>对象本身就是引用传递,不会进行空间复制，如果要复制，用 clone()</h2><pre class="line-numbers language-php"><code class="language-php">    <span class="token keyword">class</span> <span class="token class-name">Person</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$p1</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">;</span>
    <span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$p2</span><span class="token operator">=</span><span class="token variable">$p1</span><span class="token punctuation">;</span>
    <span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//refcount=2,if_ref=0</span>
    <span class="token variable">$p2</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">;</span>
    <span class="token function">xdebug_debug_zval</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//p1的值已经被改变为b，refcount=2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="写出如下程序运行的结果-bcc"><a href="#写出如下程序运行的结果-bcc" class="headerlink" title="写出如下程序运行的结果 bcc"></a>写出如下程序运行的结果 bcc</h2><pre class="line-numbers language-php"><code class="language-php">    <span class="token variable">$data</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$data</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$val</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="常量及数据类型"><a href="#常量及数据类型" class="headerlink" title="常量及数据类型"></a>常量及数据类型</h1><h2 id="php的字符串的定义方式及各自区别"><a href="#php的字符串的定义方式及各自区别" class="headerlink" title="php的字符串的定义方式及各自区别"></a>php的字符串的定义方式及各自区别</h2><ul>
<li>定义方式：单引号，双引号，heredoc 和 newdoc</li>
<li>单引号不能解析变量，不能解析转义字符，效率更高</li>
<li>双引号可以解析变量，变量字符用{}包含，可以解析转义字符，可以使用.连接</li>
<li>heredoc 类似双引号，newdoc 类似于单引号，用来处理大文本</li>
</ul>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><ul>
<li>三大数据类型（标量，复合，特殊）</li>
<li>浮点类型不能运用于比较运算</li>
<li>false的七种情况：0,0.0,’ ‘,’0’,false,array(),NULL,</li>
<li>超全局数组</li>
<li>NULL的三种情况：直接赋值null，未定义的变量，unset销毁的变量</li>
<li>常量：定义方式<ul>
<li>const 更快，是语言函数，可以定义类常量</li>
<li>define 是函数，不能定义类常量</li>
</ul>
</li>
</ul>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><ul>
<li>@ 错误控制符，当将其放置在一个 php 表达式之前，该表达式可能将任何错误信息都忽略掉</li>
<li>运算符的优先级 由高到低 递增递减 算数运算符 大小比较 逻辑与 逻辑或 三目 赋值 and xor or</li>
<li>比较运算符 == 和 === </li>
<li>等值判断（false 的七种情况都是相等的）</li>
<li>递增递减运算符不影响 <strong>布尔值</strong></li>
<li><strong>null</strong> 递增为1</li>
</ul>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><ul>
<li>foreach() 开始遍历时会对数组进行 reset() 操作，但是遍历结束后指针指向末尾</li>
<li>while(),list(),each()不会 reset()</li>
<li>switch 后面的控制表达式的数据类型只能是整性，浮点型，字符串</li>
</ul>
<h1 id="自定义函数及内部函数"><a href="#自定义函数及内部函数" class="headerlink" title="自定义函数及内部函数"></a>自定义函数及内部函数</h1><ul>
<li>变量的作用域即它定义的上下文背景，包含了 include 和 require 引入的文件</li>
<li>函数体内部的变量是内部变量，函数体内可以用 global 关键字来使用外部变量<pre class="line-numbers language-php"><code class="language-php">  <span class="token variable">$outer</span> <span class="token operator">=</span> <span class="token string">"str"</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">global</span> <span class="token variable">$outer</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用外部变量</span>
      <span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'outer'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>也可以用这种方式
  <span class="token keyword">echo</span> <span class="token variable">$outer</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>默认情况下函数通过值传递，如果允许函数修改它的值，必须通过引用传递</li>
<li>include/require 语句包含文件，如果没有给出路径名，就会从 include_path 来查找，如果没找到，就从调用脚本文件所在的目录和当前工作目录下寻找</li>
<li>加载过程中未找到文件 include 会发出一条警告，require 会发出致命错误</li>
</ul>
<h2 id="static关键字"><a href="#static关键字" class="headerlink" title="static关键字"></a>static关键字</h2><ol>
<li>仅初始化一次</li>
<li>初始化时需要赋值</li>
<li>每次执行函数该值会保留</li>
<li>static 修饰的变量是局部的，仅在函数内部有效</li>
<li>可以记录函数的调用次数，从而在某些条件下终止递归</li>
</ol>
<h2 id="后期静态绑定"><a href="#后期静态绑定" class="headerlink" title="后期静态绑定"></a>后期静态绑定</h2><p>使用 self 对当前类的静态引用，取决于定义当前方法所在的类</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token constant">__CLASS__</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token constant">__CLASS__</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

B<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//输出 A</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>后期静态绑定本想通过引入一个新的关键字表示运行时最初调用的类来绕过限制。简单地说，这个关键字能够让你在上述例子中调用 test() 时引用的类是 B 而不是 A。最终决定不引入新的关键字，而是使用已经预留的 static 关键字。</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token constant">__CLASS__</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 后期静态绑定从这里开始</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">who</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token constant">__CLASS__</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

B<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//输出 B</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="文件及目录处理"><a href="#文件及目录处理" class="headerlink" title="文件及目录处理"></a>文件及目录处理</h1><ul>
<li>fopen()函数 用来打开一个文件,打开时需要指定打开模式</li>
<li>写入函数 fwrite() fputs()</li>
<li>读取函数 fread() fgets() fgetc()</li>
<li>关闭函数 fclose() </li>
<li>遍历目录<pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">function</span> <span class="token function">loopDir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token variable">$handle</span><span class="token operator">=</span><span class="token function">opendit</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token operator">!==</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">=</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token operator">!=</span><span class="token string">'.'</span><span class="token operator">&amp;&amp;</span><span class="token variable">$file</span><span class="token operator">!=</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">echo</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filetype</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">'dir'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">loopDir</span><span class="token punctuation">(</span><span class="token function">filetype</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">.</span><span class="token string">'/'</span><span class="token punctuation">.</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h1 id="php-运行原理"><a href="#php-运行原理" class="headerlink" title="php 运行原理"></a>php 运行原理</h1><ul>
<li>CGI：解决 php 解释器和服务器之间通信</li>
<li>FastCGI：是一种协议每次处理完进程不会 kill 掉，而是保留，使这个进程一次处理多个请求</li>
<li>PHP-FPM：提供了FastCGI的实现，是 FastCGI 的进程管理器，有 master 进程和 worker 进程，master 进程只有一个，负责监听端口，接收来自服务器的请求，worker 进程有多个，可以在 php-fpm 配置，每个进程内部嵌入 php 解析器，worker 负责处理代码，master 监听端口。</li>
</ul>
<h1 id="会话控制技术"><a href="#会话控制技术" class="headerlink" title="会话控制技术"></a>会话控制技术</h1><h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><ul>
<li>setcookie($name,$value,$exppire,$path,$domain,$secure)</li>
<li>$_COOKIE 只读 无法unset</li>
<li>删除 cookie setcookie($name,’’,time()-1000)</li>
</ul>
<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><ul>
<li><p>session_start()</p>
</li>
<li><p>$_SESSION</p>
</li>
<li><p>删除session $_SESSION=[]</p>
</li>
<li><p>销毁session  session_destory()</p>
</li>
<li><p>配置 </p>
<pre><code>  //垃圾回收
  session.gc_probability=1
  session.gc_divisor=100
  session.gc_maxlifetime=1440

  session.save_handler//可以配置存储句柄 redis memcached</code></pre></li>
<li><p>如果cookie被禁用 <code>&lt;a href=&quot;1.php?&lt;?php echo SID;?&gt;&quot;&gt;下个页面&lt;/a&gt;</code></p>
</li>
</ul>
<h1 id="框架原理"><a href="#框架原理" class="headerlink" title="框架原理"></a>框架原理</h1><ul>
<li>Model View Controller</li>
<li>单一入口的工作原理：用一个程序文件处理所有的 HTTP 请求，根据请求时的参数的不同区分不同模块和操作的请求<br>index.php?r-user/reg =&gt; new user(); 调用 reg方法 <ul>
<li>优势：可以进行统一的安全性检查，集中处理程序</li>
<li>劣势：URL 不美观（URL 重写），处理效率稍低</li>
</ul>
</li>
<li>模板引擎的理解：PHP 是一种 HTML 内嵌式的在服务端执行的脚本语言，但是 PHP 有很多使 PHP 代码和 HTML 代码分开的模板引擎</li>
<li>模板引擎的工作原理就是一个庞大的正则表达式库</li>
<li>php 框架的差异和优缺点：Laravel 和 ThinkPHP</li>
<li>框架特性</li>
</ul>
<h2 id="php7-新特性"><a href="#php7-新特性" class="headerlink" title="php7 新特性"></a>php7 新特性</h2><ul>
<li>?? NULL 合并运算符</li>
<li>&lt;=&gt; 组合比较符</li>
<li>函数返回值类型声明</li>
<li>标量类型声明</li>
<li>try…catch 增加多条件判断，更多 Error 错误可以进行异常处理</li>
<li>增加了匿名类，现在支持通过 new class 来实例化一个匿名类，这可以用来替代一些 “用后即焚” 的完整类定义类</li>
<li>define 定义常量数组</li>
<li>Unicode codepoint 转译语法</li>
<li>为 unserialize() 提供过滤</li>
<li>Throwable 接口</li>
<li>use 批量声明</li>
</ul>
<h3 id="为什么-PHP7-比-PHP5-性能提升了"><a href="#为什么-PHP7-比-PHP5-性能提升了" class="headerlink" title="为什么 PHP7 比 PHP5 性能提升了"></a>为什么 PHP7 比 PHP5 性能提升了</h3><ul>
<li>变量存储字节减小，减少内存占用，提升变量操作速度</li>
<li>改善数据结构，数组元素和 hash 映射表被分配在同一块内存里，降低了内存占用、提升了 cpu 缓存命中率</li>
<li>改进了函数的调用机制，通过优化参数传递的环节，减少了一些指令，提高执行效率</li>
</ul>
<h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><ul>
<li>PHP7中更多的Error变为可捕获的Exception返回给开发者，如果不进行捕获则为Error，如果捕获就变为一个可在程序内处理的Exception。默认情况下，Error会直接导致程序中断，而PHP7则通过try / catch程序块捕获并且处理，让程序继续执行下去，为程序员提供更灵活的选择。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/04/16/PHP-%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86%E7%82%B9/" data-id="ckd5e1wwz00185znrhkhi4bop" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PHP-底层原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/16/PHP-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" class="article-date">
  <time datetime="2019-04-16T13:52:55.000Z" itemprop="datePublished">2019-04-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/16/PHP-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">PHP 底层原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="生命周期和-Zend-引擎"><a href="#生命周期和-Zend-引擎" class="headerlink" title="生命周期和 Zend 引擎"></a>生命周期和 Zend 引擎</h2><p>SAPI 指的是 PHP 集体应用的编程接口，脚本执行的开始都是以 SAPI 接口实现开始的</p>
<h2 id="SAPI-概述"><a href="#SAPI-概述" class="headerlink" title="SAPI 概述"></a>SAPI 概述</h2><h2 id="PHP-脚本的执行"><a href="#PHP-脚本的执行" class="headerlink" title="PHP 脚本的执行"></a>PHP 脚本的执行</h2><ul>
<li>php 虽然是一个脚本语言。但不是靠解释器解释，而是 zend 虚拟机，屏蔽了操作系统的区别。</li>
<li>php 代码编译成 opcode，用 zend 虚拟机来执行 opcode，php 脚本一结束，opcode 就清除了</li>
<li>php 本身不支持缓存，但是 apc，xcache 等加速器，实现了这样的效果</li>
</ul>
<h2 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h2><p>Opcode 是一种 php 脚本编译后的中间语言</p>
<ul>
<li>Scanning（Lexing），将 php 代码转换为语言片段（Tokens）</li>
<li>parsing，将 Tokens 转换成简单而有意义的表达式</li>
<li>Compilation，将表达式编译成 Opcodes</li>
<li>Execution，顺次执行 Opcodes，每次一条，从而实现 PHP 脚本的功能</li>
</ul>
<h2 id="变量的底层实现"><a href="#变量的底层实现" class="headerlink" title="变量的底层实现"></a>变量的底层实现</h2><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> _zval_struct<span class="token punctuation">{</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> lval<span class="token punctuation">;</span>
        <span class="token keyword">double</span> dval<span class="token punctuation">;</span>
        <span class="token keyword">struct</span><span class="token punctuation">{</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
            <span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//字符串长度</span>
        <span class="token punctuation">}</span>str<span class="token punctuation">;</span>
        HashTable <span class="token operator">*</span>ht<span class="token punctuation">;</span>
        zend_object_value obj<span class="token punctuation">;</span>
        zend_ast <span class="token operator">*</span>ast<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>value<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//变量的值，是个联合体</span>
    zend_uint refcount_gc <span class="token comment" spellcheck="true">//指向次数</span>
    zend_uchar type <span class="token comment" spellcheck="true">//变量类型</span>
    zend_uchar is_ref_gc <span class="token comment" spellcheck="true">//是否引用</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>在php中，字符串长度直接体现在其结构体中。strlen速度非常快</li>
</ul>
<h2 id="PHP-中有-8-种数据类型，为什么联合体中只有-5-种"><a href="#PHP-中有-8-种数据类型，为什么联合体中只有-5-种" class="headerlink" title="PHP 中有 8 种数据类型，为什么联合体中只有 5 种"></a>PHP 中有 8 种数据类型，为什么联合体中只有 5 种</h2><ol>
<li>NULL，直接 zval-&gt;type=IS_NULL 就可以表示，不必设置 value 的值。</li>
<li>BOOL，zval-&gt;type=IS_BOOL,再设置 lval=1/0。</li>
<li>Resource，资源型，往往是服务器上打开的一个接口，lval=服务器上打开的接口的编号。</li>
</ol>
<h2 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h2><p>符号表是一张哈希表 里面存储了变量名 -&gt; 变量的 zval 结构体的地址。</p>
<p>在传值赋值时，以 <code>$a=3;$b=$a;</code>  为例，并没有再次产生结构体，而是两个变量共用一个结构体，refcount_gc 值为 2。</p>
<p>a，b 指向同一结构体，修改其中一方时，结构体会分裂成两个，这种特点称为 cow（copy on write）。</p>
<p>引用时，if_ref_gc=1,说明这个变量是引用，共用一个结构体，修改时直接改这个结构体的值，不分裂。</p>
<p>如果 <code>$a=3;$b=$a; $c=&amp;$a;</code> 会强制分裂，b分裂一份结构体。</p>
<p>数组的 zvalue 里面存放的是指针，指向哈希表，哈希表里面就是数组的键和存放数组值的 zval</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$arr</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$tmp</span><span class="token operator">=</span><span class="token variable">$arr</span><span class="token punctuation">;</span>
<span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//$tmp[1]=1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时发生了分裂，数组的一号单元产生了一个新的结构体，但是0，2，3对应的还是同一个结构体</p>
<pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$arr</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$x</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$tmp</span><span class="token operator">=</span><span class="token variable">$arr</span><span class="token punctuation">;</span>
<span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//$tmp[1]=11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时强制分裂失效</p>
<h2 id="弱类型的实现"><a href="#弱类型的实现" class="headerlink" title="弱类型的实现"></a>弱类型的实现</h2><h2 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h2><ul>
<li>foreach 循环后，数组指针停留在数组结尾</li>
<li>foreach 操作的是 arrcopy，是 arr 的复制</li>
</ul>
<h2 id="符号表与作用域"><a href="#符号表与作用域" class="headerlink" title="符号表与作用域"></a>符号表与作用域</h2><ul>
<li>当执行函数时，会生成函数的“执行环境结构体”，包含函数名，参数，执行步骤，所在的类，以及为这个函数生成一个符号表，符号表统一放在栈上，并把active_symbol_table指向刚产生的符号表，这个结构体是_zend_execute_data{}结构体，这个结构体中，有两个重要信息</li>
<li>*op_array 是函数的执行步骤</li>
<li>*hash_table–&gt;symbol_table 这个函数对应的符号表</li>
<li>静态变量 放在op_array里，函数无论调用多少次。op_array只有一个，所以操作的是共同的变量<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2></li>
<li>define，值为对象时，会把对象转成标量来存储，需要__toString魔术方法</li>
<li>常量的符号表只有一个，所以全局有效，变量，每调用一次，生成一个独立的符号表<h2 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h2></li>
<li>对象存储在 handle 里，handle 指向 hash 表中的对象<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2>PHP 5.3 版本之前都是采用引用计数的方式管理内存，PHP 所有的变量存在一个叫 zval 的变量容器中，当变量被引用的时候，引用计数会 + 1，变量引用计数变为 0 时，PHP 将在内存中销毁这个变量。</li>
</ul>
<p>但是引用计数中的循环引用，引用计数不会消减为 0，就会导致内存泄露。<br>而php中内存对象就是zval，而计数器就是refcount__gc。</p>
<ul>
<li>循环引用问题：<pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span><span class="token variable">$a</span><span class="token punctuation">;</span>
<span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>在 5.3 版本之后，做了这些优化：</p>
<ol>
<li>并不是每次引用计数减少时都进入回收周期，只有根缓冲区满额后在开始垃圾回收；</li>
<li>可以解决循环引用问题；</li>
<li>可以总将内存泄露保持在一个阈值以下。</li>
</ol>
<p>有几个基本准则：</p>
<ol>
<li>如果一个 zval 的 refcount 增加，那么此 zval 还在使用，不属于垃圾</li>
<li>如果一个 zval 的 refcount 减少到 0，那么 zval 可以被释放掉，不属于垃圾</li>
<li>如果一个 zval 的 refcount 减少之后大于 0，那么此 zval 还不能被释放，此 zval 可能成为一个垃圾。</li>
</ol>
<p>新的GC算法目的就是防止循环引用的变量引起内存泄露问题。在PHP中GC算法，当节点缓冲区满了之后，垃圾分析算法就会启动，并且会释放掉发现的垃圾，从而回收内存。<br>首先PHP会分配一个固定大小的“根缓冲区”，这个缓冲区用于存放固定数量的zval，这个数量默认是10,000，如果需要修改则需要修改源代码Zend/zend_gc.c中的常量GC_ROOT_BUFFER_MAX_ENTRIES然后重新编译。<br>由上文我们可以知道，一个zval如果有引用，要么被全局符号表中的符号引用，要么被其它表示复杂类型的zval中的符号引用。因此在zval中存在一些可能根（root）。这里我们暂且不讨论PHP是如何发现这些可能根的，这是个很复杂的问题，总之PHP有办法发现这些可能根zval并将它们投入根缓冲区。<br>当根缓冲区满额时，PHP就会执行垃圾回收，此回收算法如下：</p>
<ol>
<li>对每个根缓冲区中的根zval按照深度优先遍历算法遍历所有能遍历到的zval，并将每个zval的refcount减1，同时为了避免对同一zval多次减1（因为可能不同的根能遍历到同一个zval），每次对某个zval减1后就对其标记为“已减”。</li>
<li>再次对每个缓冲区中的根zval深度优先遍历，如果某个zval的refcount不为0，则对其加1，否则保持其为0。</li>
<li>清空根缓冲区中的所有根（注意是把这些zval从缓冲区中清除而不是销毁它们），然后销毁所有refcount为0的zval，并收回其内存。</li>
</ol>
<h2 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h2><ul>
<li><a href="http://www.php-internals.com/book/" target="_blank" rel="noopener">TIPI 深入理解 PHP 内核</a></li>
<li><a href="http://www.laruence.com/2018/04/08/3170.html" target="_blank" rel="noopener">深入理解PHP7内核之zval</a></li>
<li><a href="https://segmentfault.com/a/1190000013893628" target="_blank" rel="noopener">内存管理与垃圾回收</a>(<a href="https://www.jianshu.com/p/63a381a7f70c" target="_blank" rel="noopener">https://www.jianshu.com/p/63a381a7f70c</a>)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/04/16/PHP-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" data-id="ckd5e1wx0001b5znr0973cufg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-春招面经" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/14/%E6%98%A5%E6%8B%9B%E9%9D%A2%E7%BB%8F/" class="article-date">
  <time datetime="2019-04-14T08:23:02.000Z" itemprop="datePublished">2019-04-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/14/%E6%98%A5%E6%8B%9B%E9%9D%A2%E7%BB%8F/">春招面经</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="地平线"><a href="#地平线" class="headerlink" title="地平线"></a>地平线</h2><ul>
<li>用过什么框架，讲一下 laravel 框架用到的设计模式，依赖注入解决的问题</li>
<li>设计一个存储几千份邮件的方案，答案是设计一个哈希表</li>
<li>问有没有了解布隆过滤器</li>
<li>手写单例模式</li>
<li>手写一个排序算法</li>
<li>数据库查询优化，索引方面的问题</li>
<li>数据库的事务如何实现</li>
<li>Redis 有哪些数据结构，应用场景</li>
<li>因为项目里写用到了 Elasticsearch，所以简单问了下用在什么地方，为什么快</li>
</ul>
<h2 id="小米"><a href="#小米" class="headerlink" title="小米"></a>小米</h2><p>准备不足很多没答出来但是面试官放我过了还让我好好加油，说二面面试官是女生不要紧张（虽然并不是女生），挺感动的。后来二面表现不错直接过了但是由于各种原因没有去没，挺遗憾的。</p>
<h3 id="一面"><a href="#一面" class="headerlink" title="一面"></a>一面</h3><ul>
<li>字符串 abcdef 怎么截取后面两位 substr()</li>
<li>查找一个字符串中字符出现的位置 strpos()，如果没有找到，返回值是什么</li>
<li>Redis 的基本操作，字符串类型，incr()，说看我用 redis 做了队列，那说说链表的基本操作</li>
<li>给了一个场景（记不清了），叫我说出sql语句，我就答到了连接，然后面试官说要用左连接，效率比较高</li>
<li>项目的商品表怎么设计的</li>
<li>数据库连接 PDO</li>
<li>算法，说思路 二叉树中序遍历 快排 判断链表是否有环</li>
</ul>
<h3 id="二面"><a href="#二面" class="headerlink" title="二面"></a>二面</h3><ul>
<li>在一个学生信息成绩表查询出单科成绩最高分和最低分<br>我说order by score limit 1,面试官说我这样要写两条sql语句，能不能用一条，max，min</li>
<li>说我这个项目查询课表的功能如果人太多的话查不出来怎么办<br>  我说缓存，用redis。问我缓存到什么数据结构里，我说字符串类型就可以了吧。然后问我有没有用过 zset，说下什么地方用到的，我想了想，说比如用户有发微博的功能，把微博存进去（之前看十八哥的微博项目视频看到了。自己也写了，但是记不太清，就随便说了）。</li>
<li>说一下 web 请求页面的过程</li>
<li>TCP三次握手</li>
<li>php 如何跟 nginx 交流，cgi,php-fpm,fasicgi</li>
<li>php 垃圾回收机制</li>
<li>说说常用的字符串函数，数组函数</li>
<li>说说常用的linux命令 </li>
<li>如果系统正在运行，日志文件不断的写，tail 输出会怎么样<br>  tail -f laravel.log 使用 -f 循环查看文件内容，可以自动刷新日志</li>
<li>看我这个项目用到了laravel框架，说一下开发的时候用到了哪些类</li>
<li>登录功能怎么实现</li>
<li>session 和 cookie 的区别，浏览器禁用 cookie，session 还能用吗</li>
</ul>
<h2 id="腾讯"><a href="#腾讯" class="headerlink" title="腾讯"></a>腾讯</h2><ul>
<li>问项目，订单的实现的过程，订单表的设计（问得很详细，一直问，然而我订单表用到的字段记不太清了，好多重要的都没想起来）</li>
<li>项目大流量怎么优化，缓存。从数据访问层优化，不怎么会（以前看过来着，给忘了）</li>
<li>项目里用到了 elasticsearch，用在什么地方，怎么用的。（又一波作死，对 elasticsearch 不是特别熟）</li>
<li>安全，xss 攻击，csrf 攻击，sql 注入</li>
<li>问项目开发流程，和前端怎么配合的，我提到用了docker，问 dockerfile 是自己写的么，不是。那有没有配置那种一条命令直接启动的，没有。</li>
<li>问项目的 nginx 是我配的么，问了一个场景，就是访问到 jpg，png 还有其他结尾的图片时进行匹配然后做处理，我说了用 location 然后给出详细配置，又问如果访问其他结尾的图片的时候要全部改成 gif 结尾来处理怎么办，我就说了正则替换什么的。。我不知道 nginx 中怎么处理（后来查了下，用 rewrite），然后就问我如果是在 php 中，要怎么进行正则替换。 </li>
</ul>
<h2 id="滴滴"><a href="#滴滴" class="headerlink" title="滴滴"></a>滴滴</h2><ul>
<li>如果两个应用在不同的服务器上怎么通信<br>  真想打死自己，想不起来怎么答。然后面试官说 api。。这么简单我都想不到，真是想死。</li>
<li>RESTFul api 了解吗，特点，状态码</li>
<li>说下单例模式怎么写的，然后说 php 都是单线程的，如果是多线程语言怎么办。emmm，加锁？</li>
<li>开发用到了 git 吧，怎么用的，多人合作 git 冲突怎么解决</li>
<li>linux 文件查找的命令有哪些，如果要查看一个日志文件，但是内容很大，怎么查看找到想要的内容</li>
<li>发一百万封邮件如何提高速度</li>
<li>项目相关的问题，异步队列怎么实现</li>
</ul>
<h2 id="阿里"><a href="#阿里" class="headerlink" title="阿里"></a>阿里</h2><p>面试体验最好的一次，虽然是电话面，但是面试官真真正正的让我感受到了那种大佬的气质，态度很温和，然而我真的是太菜了，差得远</p>
<ul>
<li>数据库有哪些索引， 索引怎么建，联合索引的问题，如果在 abc 三个字段上分别建立索引查询时用到的是哪一个，如果是 ab 和 ac 和 bc 都要用索引，索引怎么建</li>
<li>用 redis 做缓存，如何保证数据是最新的，如果几个人同时更改数据怎么办，数据库的数据更改了没有同步到 redis 里怎么办<br>  后来自己查的资料：<a href="https://www.jishuwen.com/d/2Cau" target="_blank" rel="noopener">缓存污染</a> 实时更新：MySQL binlog 增量订阅消费+消息队列+处理并把数据更新到 redis</li>
<li>项目难点，怎么分工，设计</li>
<li>linux 命令，查看 nginx 查看线程</li>
<li>nginx 的特点，为什么用 nginx，和 apache的区别，为什么 nginx 性能更好（答nginx 用的epoll，apache 用的 select），然后又问 select 和 epoll 的区别</li>
<li>近期有什么打算，学什么<br> 我说自己一直从事后端开发，学下别的语言，比如 go，但是不想学前端，问为什么，我说我比较想专注于一个领域吧，同时学很多可能学不精。。</li>
</ul>
<h2 id="借贷宝"><a href="#借贷宝" class="headerlink" title="借贷宝"></a>借贷宝</h2><p>一面面试官成为了我后来的 leader，挺好的一个人，非常认可我，说我的实力秋招可以进大厂，哈哈哈</p>
<h3 id="一面-1"><a href="#一面-1" class="headerlink" title="一面"></a>一面</h3><ul>
<li>php 获取昨天的日期</li>
<li>数组去重的函数</li>
<li>mysql 联合索引，联合索引的原理</li>
<li>浏览器输入地址后请求的过程，浏览器做了什么</li>
<li>tcp 三次握手，三次握手的原因<br>  关于这个我纠结了很久，我之前就看过这个问题，并且看到的回答是防止失效的报文到达服务器，我仔细的说了两遍，面试官说不对，是因为 tcp 是全双工通信。</li>
<li>算法（只说思路） 链表环的入口节点 二叉树两个子节点寻找最近父节点 数组中重复的数字</li>
<li>laravel 框架的原理，用到的设计模式，什么是依赖注入</li>
<li>如何让实现类的动态加载</li>
<li>如何实现框架中的路由功能</li>
<li>看什么书</li>
</ul>
<h3 id="二面-1"><a href="#二面-1" class="headerlink" title="二面"></a>二面</h3><ul>
<li>说下 php 底层原理（自己讲，知道多少讲多少）</li>
<li>Nginx 配置，upstream 的作用，location，rewrite 的作用</li>
<li>MySQL InnoDB 和 MyISAM 的区别，聚簇索引和非聚簇索引，非聚簇索引里如果有多个索引，是一个索引一个文件还是只有一个索引文件</li>
<li>如何实现单点登陆 </li>
</ul>
<h2 id="京东"><a href="#京东" class="headerlink" title="京东"></a>京东</h2><p>感觉京东面试官态度不是很好。。</p>
<ul>
<li>介绍项目</li>
<li>api 怎么设计的</li>
<li>php 怎么合并两个数组</li>
<li>分割字符串的函数</li>
<li>MySQL 外键关联有几种</li>
<li>左连接 右连接 不注明的话是什么连接</li>
<li>场景设计，京东下面有很多 app，app下有很多子模块，子模块要读取配置，怎么设计表</li>
<li>linux 怎么文件夹下查找 .php 结尾的文件<br>  find . -name *.php -ls</li>
<li>怎么在文件夹下查找包含 123 字符的 php 文件<br>  grep “123” *.php</li>
<li>问我还会啥语言 c++，java</li>
<li>c++ 和 c 有啥区别，虚函数是什么，多态是什么</li>
<li>c++ 和 java 对比有什么优缺点</li>
<li>垃圾回收机制了解吗</li>
</ul>
<h2 id="腾讯-1"><a href="#腾讯-1" class="headerlink" title="腾讯"></a>腾讯</h2><ul>
<li>将字符串格式的时间转换为标准时间格式</li>
<li>两个表，员工和部门，查询出各个部门薪水最高的</li>
<li>进程和线程的区别</li>
<li>wait() 和 sleep() 的区别</li>
<li>tcp三次握手四次挥手</li>
<li>https 加密的过程</li>
<li>设计模式 工厂模式的作用</li>
<li>项目中队列的用途</li>
<li>es 排序怎么做</li>
<li>linux 杀死进程的命令 改变文件权限的命令</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/04/14/%E6%98%A5%E6%8B%9B%E9%9D%A2%E7%BB%8F/" data-id="ckd5e1wxr003q5znr97z3a26a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E7%BB%8F/" rel="tag">面经</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-MySQL-分库分表" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/12/MySQL-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="article-date">
  <time datetime="2019-04-12T15:02:28.000Z" itemprop="datePublished">2019-04-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%9F%BA%E7%A1%80/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/12/MySQL-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">MySQL 分库分表</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h1><h2 id="分片（水平分割）"><a href="#分片（水平分割）" class="headerlink" title="分片（水平分割）"></a>分片（水平分割）</h2><p>水平切分又称为 Sharding，它是将同一个表中的记录拆分到多个结构相同的表中。<br>当一个表的数据不断增多时，Sharding 是必然的选择，它可以将数据分布到集群的不同节点上，从而缓存单个数据库的压力。</p>
<h3 id="水平切分，到底是分库还是分表"><a href="#水平切分，到底是分库还是分表" class="headerlink" title="水平切分，到底是分库还是分表"></a>水平切分，到底是分库还是分表</h3><p>建议分库</p>
<ul>
<li>分表依然公用一个数据库文件，仍然有磁盘 IO 的竞争</li>
<li>分库能够很容易的将数据迁移到不同数据库实例，甚至数据库机器上，扩展性更好</li>
</ul>
<h3 id="Sharding-策略"><a href="#Sharding-策略" class="headerlink" title="Sharding 策略"></a>Sharding 策略</h3><ul>
<li>哈希取模：hash(key) % N；<ul>
<li>没有热点问题，单扩容迁移数据痛苦</li>
</ul>
</li>
<li>范围：可以是 ID 范围也可以是时间范围；</li>
<li>不需要迁移数据，但有热点问题</li>
<li>映射表：使用单独的一个数据库来存储映射关系。</li>
</ul>
<p>Sharding 存在的问题：</p>
<ol>
<li>事务问题：使用分布式事务来解决，比如 XA 接口。</li>
<li>连接：可以将原来的连接分解成多个单表查询，然后在用户程序中进行连接。</li>
<li>ID 唯一性<ul>
<li>使用全局唯一 ID（GUID）</li>
<li>为每个分片指定一个 ID 范围</li>
<li>分布式 ID 生成器 (如 Twitter 的 Snowflake 算法)</li>
</ul>
</li>
</ol>
<h3 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h3><ul>
<li>线性提升数据库写性能，需要注意的是，分组架构是不能线性提升数据库写性能的</li>
<li>降低单库数据容量</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>给应用增加复杂度，通常查询时需要多个表名，查询所有数据都需要 UNION 操作</p>
<h2 id="垂直切分"><a href="#垂直切分" class="headerlink" title="垂直切分"></a>垂直切分</h2><p>垂直切分是将一张表按列切分成多个表，通常是按照列的关系密集程度进行切分，也可以利用垂直切分将经常被使用的列和不经常被使用的列切分到不同的表中。</p>
<p>在数据库的层面使用垂直切分将按数据库中表的密集程度部署到不同的库中，例如将原来的电商数据库垂直切分成商品数据库、用户数据库等。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>一个表中某些列常用，有些不常用</li>
<li>可以使数据行变小，一个数据页能存储更多数据，查询时减少 I/O 次数</li>
</ul>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><p>管理冗余咧，查询所有数据需要 JOIN 操作</p>
<h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><p>所有数据，逻辑上还在一个表中，但物理上，可以根据一定的规则放在不同的文件中。这是 MySQL5.1 之后支持的功能，业务代码无需改动。</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>创建表时使用 partition by 子句定义每个分区存放的数据，执行查询时，优化器会根据分区定义过滤那些没有我们需要数据的分区，这样查询只需要查询所需要数据在的分区即可</p>
<h3 id="分区的使用场景"><a href="#分区的使用场景" class="headerlink" title="分区的使用场景"></a>分区的使用场景</h3><ul>
<li>表非常大，无法全部存在内存，或者只在表的最后有热点数据，其他都是历史数据</li>
<li>分区表的数据更易维护，可以对独立的分区进行独立的操作</li>
<li>分区表的数据可以分布在不同的机器上，从而高效利用资源</li>
<li>可以备份和恢复独立的分区</li>
</ul>
<h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><ul>
<li>一个表最多有 1024 个分区</li>
<li>5.1 版本中，分区表表达式必须是整数，5.5 可以使用列分区</li>
<li>分区字段中如果有主键和唯一索引列，那么主键和唯一索引列必须包含进来</li>
<li>分区表中无法使用<strong>外键</strong>索引</li>
</ul>
<h1 id="分布式ID生成方案"><a href="#分布式ID生成方案" class="headerlink" title="分布式ID生成方案"></a>分布式ID生成方案</h1><p>分库分表后，使用自增字段无法保证 ID 的全局唯一性。</p>
<p>UUID 虽然可以实现全局唯一性，但是生成的 ID 需要有序，因为 ID 可能成为排序的字段。</p>
<ol>
<li>数据库自增ID：用一个数据库建立一张表来生成 ID，使用主主模式，设置初始值和步长（MySQL1：1357，MySQL：2468）</li>
<li>号段模式</li>
<li>Redis 生成 ID：incr 和 incrBy 自增原子命令</li>
<li>雪花算法</li>
<li></li>
</ol>
<p>可以基于 Snowflake 算法搭建发号器，Snowflake 满足 ID 所需的全局唯一性，单调递增性，还包含一定的业务上的意义。</p>
<p>能让负责生成分布式 ID 的每台机器在每毫秒内生成不一样的 ID。</p>
<p><img src="https://gitee.com/cellophane/image/raw/master/20200412232622.png" alt=""></p>
<h1 id="什么是分布式中间件"><a href="#什么是分布式中间件" class="headerlink" title="什么是分布式中间件"></a>什么是分布式中间件</h1><p>数据库分布式中间件是一款专门针对分布式数据库集群而设计的中间件软件，它是以 MySQL 为底层存储来实现关系型数据的统一管理与访问的平台。分布式中间件可将应用发起的 SQL 语句经过解析、转换、再根据路由算法下推到集群系统中的各个MySQL数据库节点上，MySQL 数据库节点获得了正确且能够有效执行的分段 SQL 语句，执行之后将结果返还到中间件，由中间件对查询结果进行汇总、计算、合并成应用服务所需的执行结果。</p>
<p>从最终用户的角度，分布式中间件可以认为就是一个传统的关系型数据库，支持通过标准的 SQL 语句进行数据操作，对前端业务系统来说，可以大幅降低开发难度，提升开发速度。用户可以将表定义为任何一种中间件支持的存储方式，比如Innodb。</p>
<h1 id="分布式中间件"><a href="#分布式中间件" class="headerlink" title="分布式中间件"></a>分布式中间件</h1><p>引入分布式中间件的目的是为了解决高并发+海量数据存储的问题。</p>
<h2 id="直连数据库模式"><a href="#直连数据库模式" class="headerlink" title="直连数据库模式"></a>直连数据库模式</h2><p><img src="https://gitee.com/cellophane/image/raw/master/db-1.png" alt=""><br>优点：</p>
<ul>
<li>中间消耗最低，对于低并发，少量存储来说，请求响应时间极短。</li>
<li>由于调用链简单，排障比较容易。</li>
</ul>
<p>缺点：</p>
<ul>
<li>无法承载高并发访问</li>
<li>无法承载海量数据</li>
</ul>
<h2 id="读写分离模式"><a href="#读写分离模式" class="headerlink" title="读写分离模式"></a>读写分离模式</h2><p><img src="https://gitee.com/cellophane/image/raw/master/db-2.png" alt=""><br>优点：解决了高并发问题</p>
<p>缺点：</p>
<ul>
<li>增大了应用到存储之间的距离，无法获取最优的请求响应时间</li>
<li>无法解决海量数据存储问题</li>
</ul>
<h2 id="数据分片模式"><a href="#数据分片模式" class="headerlink" title="数据分片模式"></a>数据分片模式</h2><p><img src="https://gitee.com/cellophane/image/raw/master/db-3.png" alt=""><br>优点：</p>
<ul>
<li>解决了高并发的问题</li>
<li>解决了海量存储的问题</li>
</ul>
<p>缺点：</p>
<ul>
<li>增大了应用到存储之间的距离，无法获取最优的请求响应时间</li>
<li>加大运维难度</li>
<li>分布式事务管理难度增加</li>
</ul>
<h3 id="分库分表后的问题"><a href="#分库分表后的问题" class="headerlink" title="分库分表后的问题"></a>分库分表后的问题</h3><ul>
<li>分布式事务问题</li>
<li>表关联问题</li>
<li>分页、排序比较复杂</li>
<li>需要生产全局唯一主键，叫做分布式 ID。</li>
</ul>
<h1 id="是否分库分表"><a href="#是否分库分表" class="headerlink" title="是否分库分表"></a>是否分库分表</h1><p>如何计算当前表的理论上分表的最大值</p>
<p>在开始这一块之前，我们需要了解以下几个信息：</p>
<ol>
<li>每一个节点在数据库中都是一个页，页是 innodb 磁盘管理最小的单位，innodb 每个页的大小是 16K，且不可更改。常见的类型有：数据页 B-tree Node；undo 页 Undo Log Page；系统页 System Page；事务数据页 Transaction system Page；插入缓冲位图页 Insert Buffer Bitmap；插入缓冲空闲列表页 Insert Buffer freeBitmap；未压缩的二进制大对象页Uncompressed BLOB Page；压缩的二进制大对象页 Compressed BLOB Page。</li>
<li>每个key后有个页号4B，还有6B的其他数据（参考《MySQL技术内幕：InnoDB存储引擎》P193的页面数据）</li>
<li>装载因子（InnoDB 默认为15/16）</li>
</ol>
<p>以下是针对单行数据在 300bit 大小的数据计算步骤：</p>
<ol>
<li>索引节点：<code>(16000/(8+4+6))*15/16=833.33</code>个</li>
<li>叶子节点：假设单行数据<code>1218byte</code>,计算为<code>(16000/（1218*8+8+4+6）)*15/16=1.54</code></li>
<li>总共三层B+树可存储数据量为：<code>833.33*833.33*1.54=1067054</code>条数据</li>
</ol>
<p>所以一个表的数据在 1067054 条时，B+ 树会膨胀到四层，影响 sql 的性能（可能数据库有会压缩数据之类的优化操作，但是数量级应该不会差很多）</p>
<h1 id="手动分表的方式"><a href="#手动分表的方式" class="headerlink" title="手动分表的方式"></a>手动分表的方式</h1><h2 id="根据取值范围"><a href="#根据取值范围" class="headerlink" title="根据取值范围"></a>根据取值范围</h2><p>可以根据时间区间或者 ID 区间来切分。</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>单表数据量可控</li>
<li>水平扩展只需要增加节点即可，无需对其他分片的数据进行迁移</li>
</ul>
<h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><p>由于连续分片可能存在数据热点，如果按时间字段分片，有些分片存储最近时间段内的数据，可能会被频繁的读写，而有些分片存储的历史数据，则很少被查询。</p>
<h2 id="哈希取模"><a href="#哈希取模" class="headerlink" title="哈希取模"></a>哈希取模</h2><p>数据分片相对比较均匀，不易出现某个库并发访问的问题。</p>
<p>例如：以 messageEntry 表的 to_uid 字段为依据，除 1024 取余作为后缀。<br><code>$tableName = &quot;messageEntry&quot;. messageEntry[&#39;to_uid&#39;]% 1024;</code><br>消息模块 messageEntry_ 表根据 user_id 手动将表分为 1024 张表，使用表前自己根据计算规则<code>(user_id % 1024)</code>计算得到需要访问的表名。</p>
<h1 id="使用中间件分表"><a href="#使用中间件分表" class="headerlink" title="使用中间件分表"></a>使用中间件分表</h1><ol>
<li>sql 解析</li>
<li>路由：提前配置分库分表规则，给业务方提供一个虚 ip:port, 业务方不再感知分库分表规则。</li>
<li>组装数据：将返回结果根据需求组装后返回给业务方。</li>
</ol>
<h2 id="从手动分表改造成中间件分表的步骤"><a href="#从手动分表改造成中间件分表的步骤" class="headerlink" title="从手动分表改造成中间件分表的步骤"></a>从手动分表改造成中间件分表的步骤</h2><ol>
<li>DBA 配置中间件</li>
<li>表 messageEntry 按照原有分表方式(按照 user_id 分表标准)、表总数(仍 1024 张)等不变,</li>
<li>给业务方一个虚 ip，业务方使用虚 ip 统一访问 messageEntry 表，不再直接操作具体一张表(messageEntry_xx).</li>
<li>中间过渡(支持两种连接方式，既可以根据规则计算得到表名，也可以通过中间件方式路由到真实访问的表)</li>
<li>业务方修改读写的 table: 将原来的使用的 messageEntry_xxx 统一替换为 messageEntry。此后，业务方不再感知分表分库等细节。</li>
</ol>
<p>sharding-JDBC 在后端将数据量较大的数据表水平拆分到后端的每个 MySQL 数据库中，这些拆分到 MySQL 中的数据库被称为分库，分库中的表称为分表。</p>
<p>拆分后，每个分库负责每一份数据的读写操作，从而有效的分散了整体访问压力。在系统扩容时，只需要水平增加分库的数量，并且迁移相关数据，就可以提高 MySQL 系统的总体容量。</p>
<h1 id="Sharding-JDBC简介"><a href="#Sharding-JDBC简介" class="headerlink" title="Sharding-JDBC简介"></a>Sharding-JDBC简介</h1><p>Sharding-JDBC 是当当应用框架 ddframe 中，从关系型数据库模块 dd-rdb 中分离出来的数据库水平分片框架，实现透明化数据库分库分表访问。Sharding-JDBC 是继 dubbox 和 elastic-job 之后，ddframe 系列开源的第3个项目。</p>
<p><strong>Sharding-JDBC 直接封装 JDBC API，可以理解为增强版的 JDBC 驱动，旧代码迁移成本几乎为零</strong>。</p>
<p>可适用于任何基于 Java 的 ORM 框架，如 JPA、Hibernate、Mybatis、Spring JDBC Template 或直接使用 JDBC。<br>可基于任何第三方的数据库连接池，如 DBCP、C3P0、 BoneCP、Druid 等。<br>Sharding-JDBC 定位为轻量 Java 框架，使用客户端直连数据库，以 jar 包形式提供服务，无 proxy 代理层，无需额外部署，无其他依赖，DBA 也无需改变原有的运维方式。</p>
<p>Sharding-JDBC 分片策略灵活，可支持等号、between、in 等多维度分片，也可支持多分片键。</p>
<p>SQL解析功能完善，支持聚合、分组、排序、limit、or 等查询，并支持 Binding Table 以及笛卡尔积表查询。</p>
<h2 id="与常见开源产品对比"><a href="#与常见开源产品对比" class="headerlink" title="与常见开源产品对比"></a>与常见开源产品对比</h2><p>Cobar 属于中间层方案，在应用程序和 MySQL 之间搭建一层 Proxy。中间层介于应用程序与数据库间，需要做一次转发，而基于JDBC协议并无额外转发，直接由应用程序连接数据库，性能上有些许优势。这里并非说明中间层一定不如客户端直连，除了性能，需要考虑的因素还有很多，中间层更便于实现监控、数据迁移、连接管理等功能。</p>
<p>Cobar-Client、TDDL 和 Sharding-JDBC 均属于客户端直连方案。此方案的优势在于轻便、兼容性、性能以及对 DBA 影响小。其中 Cobar-Client 的实现方式基于 ORM（Mybatis）框架，其兼容性与扩展性不如基于 JDBC 协议的后两者。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>前文已介绍了 Sharding-JDBC 是实现了 JDBC 协议的 jar 文件。基于 JDBC 协议的实现与基于 MySQL 等数据库协议实现的中间层略有差别。</p>
<p>无论使用哪种架构，核心逻辑均极为相似，除了协议实现层不同（JDBC或数据库协议），都会分为分片规则配置、SQL 解析、SQL 改写、SQL 路由、SQL 执行以及结果归并等模块。</p>
<p><img src="https://gitee.com/cellophane/image/raw/master/sharding.png" alt=""></p>
<h2 id="分片规则配置"><a href="#分片规则配置" class="headerlink" title="分片规则配置"></a>分片规则配置</h2><p>Sharding-JDBC 的分片逻辑非常灵活，支持分片策略自定义、复数分片键、多运算符分片等功能。</p>
<p>如：根据用户 ID 分库，根据订单 ID 分表这种分库分表结合的分片策略；或根据年分库，月份 + 用户区域 ID 分表这样的多片键分片。</p>
<p>Sharding-JDBC 除了支持等号运算符进行分片，还支持 in/between 运算符分片，提供了更加强大的分片功能。</p>
<h2 id="SQL-解析"><a href="#SQL-解析" class="headerlink" title="SQL 解析"></a>SQL 解析</h2><p>SQL 解析作为分库分表类产品的核心，性能和兼容性是最重要的衡量指标。目前常见的SQL解析器主要有 fdb/jsqlparser 和 Druid。Sharding-JDBC 使用 Druid 作为 SQL 解析器，经实际测试，Druid 解析速度是另外两个解析器的几十倍。</p>
<p>目前 Sharding-JDBC 支持 join、aggregation（包括avg）、order by、 group by、limit 甚至 or 查询等复杂 SQL 的解析。目前不支持 union、部分子查询、函数内分片等不太应在分片场景中出现的 SQL 解析。</p>
<h2 id="SQL改写"><a href="#SQL改写" class="headerlink" title="SQL改写"></a>SQL改写</h2><p>SQL改写分为两部分，一部分是将分表的逻辑表名称替换为真实表名称。另一部分是根据 SQL 解析结果替换一些在分片环境中不正确的功能。这里具两个例子：</p>
<ol>
<li>avg计算。在分片的环境中，以 <code>avg1 +avg2+avg3/3</code> 计算平均值并不正确，需要改写为<code>(sum1+sum2+sum3)/(count1+count2+ count3)</code>。这就需要将包含 <code>avg</code> 的 <code>SQL</code> 改写为 <code>sum</code> 和 <code>count</code>，然后再结果归并时重新计算平均值。</li>
<li>分页。假设每 10 条数据为一页，取第 2 页数据。在分片环境下获取 <code>limit 10, 10</code>，归并之后再根据排序条件取出前 10 条数据是不正确的结果。正确的做法是将分条件改写为 <code>limit 0, 20</code>，取出所有前 2 页数据，再结合排序条件算出正确的数据。可以看到越是靠后的 Limit 分页效率就会越低，也越浪费内存。有很多方法可避免使用 limit 进行分页，比如构建记录行记录数和行偏移量的二级索引，或使用上次分页数据结尾 ID 作为下次查询条件的分页方式。</li>
</ol>
<h2 id="SQL路由"><a href="#SQL路由" class="headerlink" title="SQL路由"></a>SQL路由</h2><p>SQL 路由是根据分片规则配置，将 SQL 定位至真正的数据源。主要分为单表路由、Binding 表路由和笛卡尔积路由。</p>
<p>单表路由最为简单，但路由结果不一定落入唯一库（表），因为支持根据 between 和 in 这样的操作符进行分片，所以最终结果仍然可能落入多个库（表）。</p>
<p>Binding 表可理解为分库分表规则完全一致的主从表。举例说明：订单表和订单详情表都根据订单 ID 作为分片键，任意时刻分片逻辑均相同。这样的关联查询和单表查询难度和性能相当。</p>
<p>笛卡尔积查询最为复杂，因为无法根据 Binding 关系定位分片规则的一致性，所以非 Binding 表的关联查询需要拆解为笛卡尔积组合执行。查询性能较低，而且数据库连接数较高，需谨慎使用。</p>
<h2 id="SQL执行"><a href="#SQL执行" class="headerlink" title="SQL执行"></a>SQL执行</h2><p>路由至真实数据源后，Sharding-JDBC 将采用多线程并发执行 SQL，并完成对 addBatch 等批量方法的处理。</p>
<h2 id="结果归并"><a href="#结果归并" class="headerlink" title="结果归并"></a>结果归并</h2><p>结果归并包括 4 类：普通遍历类、排序类、聚合类和分组类。每种类型都会先根据分页结果跳过不需要的数据。</p>
<p>普通遍历类最为简单，只需按顺序遍历 ResultSet 的集合即可。</p>
<p>排序类结果将结果先排序再输出，因为各分片结果均按照各自条件完成排序，所以采用归并排序算法整合最终结果。</p>
<p>聚合类分为3种类型，比较型、累加型和平均值型。比较型包括 max 和 min，只返回最大（小）结果。累加型包括 sum 和 count，需要将结果累加后返回。平均值则是通过 SQL 改写的 sum 和 count 计算，相关内容已在 SQL 改写涵盖，不再赘述。</p>
<p>分组类最为复杂，需要将所有的 ResultSet 结果放入内存，使用 map-reduce 算法分组，最后根据排序和聚合条件做相关处理。最消耗内存，最损失性能的部分即是此，可以考虑使用 limit 合理的限制分组数据大小。</p>
<p>结果归并部分目前并未采用管道解析的方式，之后会针对这里做更多改进。 </p>
<h2 id="Sharding-JDBC-具体使用"><a href="#Sharding-JDBC-具体使用" class="headerlink" title="Sharding-JDBC 具体使用"></a>Sharding-JDBC 具体使用</h2><p>先做一个最简单的试用，不做分库，仅做分表。选择数据表 operate_history，这个数据表记录所有的操作历史，是整个系统中数据量最大的一个数据表。</p>
<p>希望将这个表拆分为四个数据表，分别是 operate_history_0、operate_history_1、operate_history_2 、operate_history_3。数据能够分配保存到四个数据表中，降低单表的数据量。同时，为了尽量减少跨表的查询操作，决定使用字段 entity_key 为分表依据，这样同一个 entity 对象的所有操作，将会记录在同一个数据表中。</p>
<p>以下是针对JPA项目的修改过程。其他项目请参考官方网站的文档。</p>
<ol>
<li>修改 pom.xml 增加 dependency，需要添加两个 jar，sharding-jdbc-core 和 sharding-jdbc-config-spring。</li>
</ol>
<pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.dangdang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-jdbc-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.dangdang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sharding-jdbc-config-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>修改 Spring 中 Database 部分的配置</li>
</ol>
<p>原 Database 配置</p>
<pre class="line-numbers language-xml"><code class="language-xml">&lt;bean id="dataSource"class="org.apache.tomcat.jdbc.pool.DataSource"destroy-method="close">

  &lt;propertyname="driverClassName"value="com.mysql.jdbc.Driver"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

  &lt;propertyname="url" value="jdbc:mysql://localhost:3306/sharding"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

  &lt;propertyname="username" value="root"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

  &lt;propertyname="password" value="sharding"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改后的配置</p>
<pre class="line-numbers language-xml"><code class="language-xml">&lt;beanid="db-node-0"class="org.apache.tomcat.jdbc.pool.DataSource"destroy-method="close">

 &lt;property name="driverClassName"value="com.mysql.jdbc.Driver"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

 &lt;property name="url"value="jdbc:mysql://localhost:3306/sharding"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

 &lt;property name="username"value="root"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

 &lt;property name="password"value="sharding"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

&lt;rdb:strategyid="historyTableStrategy"

 sharding-columns="entity_key"

 algorithm-class="cn.codestory.sharding.SingleKeyTableShardingAlgorithm"/>

&lt;rdb:data-sourceid="dataSource">

 &lt;rdb:sharding-ruledata-sources="db-node-0"default-data-source="db-node-0">

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">rdb:</span>table-rules</span><span class="token punctuation">></span></span>

   &lt;rdb:table-rulelogic-table="operate_history"

   actual-tables="operate_history_0,operate_history_1,operate_history_2,operate_history_3"

   table-strategy="historyTableStrategy" />

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rdb:</span>table-rules</span><span class="token punctuation">></span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rdb:</span>sharding-rule</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">rdb:</span>data-source</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>编写类 SingleKeyTableShardingAlgorithm，这个类用来根据 entity_key 值确定使用的分表名。参考 sharding 提供的示例代码进行修改。核心代码如下</li>
</ol>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">doInSharding</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> availableTargetNames<span class="token punctuation">,</span> ShardingValue<span class="token operator">&lt;</span>Long<span class="token operator">></span> shardingValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//这是一个简单的实现，对 entity_key 进行求模，用余数确定数据表名。</span>
    <span class="token keyword">int</span> targetCount <span class="token operator">=</span> availableTargetNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Collection<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> newLinkedHashSet <span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>targetCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Collection<span class="token operator">&lt;</span>Long<span class="token operator">></span> values <span class="token operator">=</span> shardingValue<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Long value <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String tableNames <span class="token operator">:</span> availableTargetNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tableNames<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>value <span class="token operator">%</span> targetCount <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>修改主键生成方法：因为数据分表保存，不能使用 identify 方式生成数据表主键。如果主键是 String 类型，可以考虑使用 uuid 生成方法，但它查询效率会相对比较低。如果使用 long 型主键，可以使用其他方式，一定要确保各个子表中的主键不重复。</li>
<li>历史数据的处理：根据数据分表的规则，需要对原有数据包的数据进行迁移，分别移动到四个数据表中。如果不做这一步，或者数据迁移到了错误的数据表，后续将会查询不到这些数据。</li>
<li>至此，对项目的修改基本完成，重新启动项目并增加 operate_history 数据，就会看到新添加的数据，已经根据我们的分表规则，插入到了某一个数据表中。查询的时候，能够同时查询到多个实际数据表中的数据。</li>
</ol>
<h2 id="数据分表规则的一些考虑"><a href="#数据分表规则的一些考虑" class="headerlink" title="数据分表规则的一些考虑"></a>数据分表规则的一些考虑</h2><p>前面的例子，演示的是根据 entity_key 进行分表，也可以使用其他字段如主键进行分表。</p>
<ul>
<li>根据主键进行分配：这种方式能够实现最平均的分配方法，每生成一条新数据，会依次保存到下一个数据表中。</li>
<li>根据用户ID进行分配：这种方式能够确保同一个用户的所有数据保存在同一个数据表中。如果经常按用户id查询数据，这是比较经济的一种做法。</li>
<li>根据某一个外键的值进行分配：前面的例子采用的就是这种方法，因为这个数据可能会经常根据这个外键进行查询。</li>
<li>根据时间进行分配：适用于一些经常按时间段进行查询的数据，将一个时间段内的数据保存在同一个数据表中。比如订单系统，缺省查询一个月之内的数据。</li>
</ul>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://juejin.im/entry/5905ac37a22b9d0065e1199c" target="_blank" rel="noopener">深度认识 Sharding-JDBC：做最轻量级的数据库中间层</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651963031&idx=1&sn=f52b724ff33ef008668ef9165c51d39b&chksm=bd2d0b4b8a5a825df41252dd381d0206e141f6a54f253086030113f14584bb11612308ce8e16&scene=21#wechat_redirect" target="_blank" rel="noopener">数据库架构设计中，最重要的“基概”！！！</a></li>
<li><a href="https://juejin.im/post/5d6fc8eff265da03ef7a324b" target="_blank" rel="noopener">分布式id生成方案总结</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/04/12/MySQL-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" data-id="ckd5e1wwr000n5znr11p20nm1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PHP-基础知识" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/10/PHP-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="article-date">
  <time datetime="2019-04-10T12:36:32.000Z" itemprop="datePublished">2019-04-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/10/PHP-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">PHP 基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><ul>
<li>strlen 获取字符串的长度</li>
<li>strtoupper 将字符串中的小写字符转变为大写的字符， strtolower 将字符串中大写的字符转变为小写的字符</li>
<li>ucfirst 首字符大写，ucwords 单词首字母大写</li>
<li>trim 去空格 ltrim | rtrim 删除字符串 开头 | 结尾 的空白字符（或其他字符）</li>
<li>strpos 查找字符串首次出现的位置，查找失败返回 false，应使用 === 来判断，</li>
<li>strstr 查找字符串的首次出现，返回字符串(大小写敏感) stristr 查找字符串的首次出现，返回字符串(大小写不敏感)</li>
<li>str_replace 替换字符串中的某个字符</li>
<li>str_repeat 重复一个字符串</li>
<li>str_pad 使用另一个字符串填充字符串为指定长度</li>
<li>split 用正则表达式将字符串分割成数组</li>
<li>implode 将数组组合成一个字符串，explode 使用一个字符串分割字符串成数组 join 是 implode 的别名</li>
<li>strrev 字符串的反转，ps:汉字不能反转</li>
<li>number_format 数字格式化</li>
<li>wordwrap 打断字符串为指定数量的字串</li>
<li>iconv 字符串按要求的字符编码来转换</li>
<li>substr  字符串的截取函数，substr_compare 字符串的截取比较</li>
</ul>
<h3 id="时间日期函数"><a href="#时间日期函数" class="headerlink" title="时间日期函数"></a>时间日期函数</h3><ul>
<li>date() 格式化时间戳</li>
<li>strtotime() 将任何英文文本的日期时间描述解析为 Unix 时间戳</li>
<li>mktime() 取得一个日期的 Unix 时间戳</li>
<li>time() 返回当前的 Unix 时间戳</li>
<li>microtime() 返回当前 Unix 时间戳和微秒数</li>
<li>data_default_timezone_set() 设定用于一个脚本中所有日期时间函数的默认时区</li>
</ul>
<h3 id="打印处理函数"><a href="#打印处理函数" class="headerlink" title="打印处理函数"></a>打印处理函数</h3><ul>
<li>print()</li>
<li>printf()</li>
<li>print_r()</li>
<li>sprintf()</li>
<li>var_dump()</li>
<li>var_export()</li>
<li>echo</li>
</ul>
<h3 id="HTML函数"><a href="#HTML函数" class="headerlink" title="HTML函数"></a>HTML函数</h3><ul>
<li>htmlspecialchars() 将html标签转换为html实体</li>
<li>htmlspecialchars_decode()将html实体转换为html标签</li>
<li>strip_tags() 从字符串中去除 HTML 和 PHP 标记</li>
<li>stripslashes()去除字符串中转义斜杠</li>
</ul>
<h3 id="数组处理函数"><a href="#数组处理函数" class="headerlink" title="数组处理函数"></a>数组处理函数</h3><ul>
<li>array_search() 在数组中搜索给定的值 用来查找数组元素查找数据在数组中的位置，如果该数组有该数据，返回的是该数据在数组中的数组元素的下标或者键名；</li>
<li>in_array() 判断某个数组元素值是否存在</li>
<li>array_key_exists() 判断某个数组元素的标识符是否存在</li>
<li>array_values() 从数组中取得所有的数组元素值，组成一个新的索引数组，如果正确，返回的是组成的索引数组，不正确则返回false</li>
<li>array_keys() 从数组中取出所有的数组元素的标识符，组成一个新的索引数组</li>
<li>extract() 将关联数组映射到一张变量表中，以键名当作变量名，以数组元素值当作变量值,如果对变量的值做了修改（重定义），那么他不会影响数组中的数组元素值</li>
<li>list() 将数组中的元素值赋给不同的变量 结构：list(变量1,变量2,变量3…)=array(…);注意：只能对索引数组进行操作</li>
<li>each() 返回数组当前元素的键值对，并将指针移动到下一个元素位置</li>
<li>array_push(数组名，参数1，参数2，参数3…) 入栈：从堆栈结构的顶部压入数据的操作 array_pop(数组名) 出栈：从堆栈结构的顶部弹出（删除）数据的过程</li>
<li>array_unshift(数组名，参数1，参数2，参数3…) 入队：从队列的头部压入一些数据，这种操作叫做入队 array_shift(数组名) 出队：从队列的头部删除一些数据，这种操作叫做出队</li>
<li>array_merge($arr1,$arr2) 将参数列表中的数组进行合并</li>
<li>array_slice(数组名，切割的起始位置，切掉的长度)切割数组中的连续的几个数组元素，切割后返回的是切割掉的数组元素组成的新数组，切割不成功返回空数组</li>
<li>array_splice()去掉数组中的某一部分并用其它值取代</li>
<li>sort() 本函数对数组进行排序。当本函数结束时数组单元将被从最低到最高重新安排 rsort()本函数对数组进行逆向排序（最高到最低）。</li>
<li>ksort()对数组按照键名排序 krsort() 对数组按照键名逆向排序</li>
<li>array_unique() 去除重复的数组元素值，返回去除重复元素值之后的数组</li>
<li>array_count_values() 返回的数组，统计数组中所有的值出现的次数</li>
<li>array_rand() 从数组中取出一个或多个随机的单元，并返回随机条目的一个或多个标识符</li>
<li>array_sum() 将数组中的所有值的和以整数或浮点数的结果返回</li>
<li>array_product() 计算乘积</li>
<li>array_diff() 用来求数组的差集，用第一个数组减去第二个数组</li>
<li>array_diff_key()</li>
<li>arraydiffassoc()</li>
<li>array_intersect()</li>
<li>arrayintersectkey()</li>
</ul>
<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><ul>
<li>ip2long() 将 IPV4 的字符串互联网协议转换成长整型数字</li>
<li>long2ip() 将长整型转化为字符串形式带点的互联网标准格式地址（IPV4）</li>
<li>serilize 类的属性可以序列化后保存到 session 中，从而以后可以恢复整个类</li>
<li>unserilize()</li>
<li>isset()检测一个变量是否有设置 empty()检测一个变量是否为空</li>
<li>is_bool() 检测变量是否为布尔类型</li>
<li>is_float() 检测变量是否是浮点型</li>
<li>is_int() 检测变量是否是整数</li>
<li>is_string() 检测变量是否是字符串</li>
<li>is_null() 检测变量是否是空类型</li>
<li>ceil()进一 floor()舍去 round()四舍五入</li>
</ul>
<h3 id="防止SQL注入漏洞可以用哪些函数？"><a href="#防止SQL注入漏洞可以用哪些函数？" class="headerlink" title="防止SQL注入漏洞可以用哪些函数？"></a>防止SQL注入漏洞可以用哪些函数？</h3><p>ddslashes()<br>mysql_escape_string()</p>
<h3 id="超全局数组（预定义变量）"><a href="#超全局数组（预定义变量）" class="headerlink" title="超全局数组（预定义变量）"></a>超全局数组（预定义变量）</h3><ul>
<li><code>$_SESSION</code></li>
<li><code>$_COOKIE</code></li>
<li><code>$_SERVER</code><ul>
<li>‘GATEWAY_INTERFACE’ 服务器使用的 CGI 规范的版本；例如，“CGI/1.1”。</li>
<li>‘SERVER_PORT’ Web 服务器使用的端口。默认值为 “80”。如果使用 SSL 安全连接，则这个值为用户设置的 HTTP 端口。</li>
<li>‘SERVER_ADDR’ 当前运行脚本所在的服务器的 IP 地址。</li>
<li>‘SERVER_NAME’ 当前运行脚本所在的服务器的主机名。如果脚本运行于虚拟主机中，该名称是由那个虚拟主机所设置的值决定。</li>
<li>‘REQUEST_METHOD’ 访问页面使用的请求方法；例如，“GET”, “HEAD”，“POST”，“PUT”。</li>
<li>‘REQUEST_TIME’ 请求开始时的时间戳。从 PHP 5.1.0 起可用。</li>
<li>‘QUERY_STRING’ query string（查询字符串），如果有的话，通过它进行页面访问。</li>
<li>‘DOCUMENT_ROOT’ 当前运行脚本所在的文档根目录。在服务器配置文件中定义。</li>
<li>‘HTTP_HOST’ 当前请求头中 Host: 项的内容，如果存在的话。</li>
<li>‘HTTP_REFERER’ 引导用户代理到当前页的前一页的地址（如果存在）。由 user agent 设置决定。并不是所有的用户代理都会设置该项，有的还提供了修改 HTTP_REFERER 的功能。简言之，该值并不可信。</li>
<li>‘HTTP_USER_AGENT’ 当前请求头中 User-Agent: 项的内容，如果存在的话。该字符串表明了访问该页面的用户代理的信息。一个典型的例子是：Mozilla/4.5 [en] (X11; U; Linux 2.2.9 i586)。除此之外，你可以通过 get_browser() 来使用该值，从而定制页面输出以便适应用户代理的性能。</li>
<li>‘REMOTE_ADDR’ 浏览当前页面的用户的 IP 地址。</li>
<li>‘REMOTE_HOST’ 浏览当前页面的用户的主机名。DNS 反向解析不依赖于用户的 REMOTE_ADDR。</li>
<li>‘REMOTE_PORT’ 用户机器上连接到 Web 服务器所使用的端口号。</li>
<li>‘SCRIPT_FILENAME’ 当前执行脚本的绝对路径。</li>
<li>‘SCRIPT_NAME’ 包含当前脚本的路径。这在页面需要指向自己时非常有用。<code>__FILE__</code> 常量包含当前脚本(例如包含文件)的完整路径和文件名。</li>
<li>‘REQUEST_URI’ URI 用来指定要访问的页面。例如 “/index.html”。</li>
<li>‘PATH_INFO’ 包含由客户端提供的、跟在真实脚本名称之后并且在查询语句（query string）之前的路径信息，如果存在的话。例如，如果当前脚本是通过 URL <code>http://www.example.com/php/path_info.php/some/stuff?foo=bar</code> 被访问，那么 <code>$_SERVER[&#39;PATH_INFO&#39;]</code> 将包含 <code>/some/stuff</code>。</li>
</ul>
</li>
<li><code>$_GET</code></li>
<li><code>$_POST</code></li>
<li><code>$_REQUEST</code> 默认情况下包含了 <code>$_GET</code>，<code>$_POST</code> 和 <code>$_COOKIE</code> 的数组。</li>
<li><code>$_FILES</code></li>
<li><code>$_ENV</code></li>
<li><code>$GLOBALS</code></li>
</ul>
<h3 id="预定义常量"><a href="#预定义常量" class="headerlink" title="预定义常量"></a>预定义常量</h3><ul>
<li><code>__LINE__</code>  文件中的当前行号。</li>
<li><code>__FILE__</code>  文件的完整路径和文件名。如果用在被包含文件中，则返回被包含的文件名。自 PHP 4.0.2 起，<code>__FILE__</code>  总是包含一个绝对路径（如果是符号连接，则是解析后的绝对路径），而在此之前的版本有时会包含一个相对路径。</li>
<li><code>__DIR__</code> 文件所在的目录。如果用在被包括文件中，则返回被包括的文件所在的目录。它等价于 dirname(<code>__FILE__</code>)。除非是根目录，否则目录中名不包括末尾的斜杠。（PHP 5.3.0中新增） =</li>
<li><code>__FUNCTION__</code>  函数名称（PHP 4.3.0 新加）。自 PHP 5 起本常量返回该函数被定义时的名字（区分大小写）。在 PHP 4 中该值总是小写字母的。</li>
<li><code>__CLASS__</code>   类的名称（PHP 4.3.0 新加）。自 PHP 5 起本常量返回该类被定义时的名字（区分大小写）。在 PHP 4 中该值总是小写字母的。类名包括其被声明的作用区域（例如 Foo\Bar）。注意自 PHP 5.4 起 <code>__CLASS__</code> 对 trait 也起作用。当用在 trait 方法中时，<code>__CLASS__</code> 是调用 trait 方法的类的名字。</li>
<li><code>__TRAIT__</code>  Trait 的名字（PHP 5.4.0 新加）。自 PHP 5.4 起此常量返回 trait 被定义时的名字（区分大小写）。Trait 名包括其被声明的作用区域（例如 Foo\Bar）。</li>
<li><code>__METHOD__</code>  类的方法名（PHP 5.0.0 新加）。返回该方法被定义时的名字（区分大小写）。</li>
<li><code>__NAMESPACE__</code>   当前命名空间的名称（区分大小写）。此常量是在编译时定义的（PHP 5.3.0 新增）。</li>
</ul>
<h3 id="OOP"><a href="#OOP" class="headerlink" title="OOP"></a>OOP</h3><ul>
<li>static 静态，类名可以访问</li>
<li>public 表示全局，类内部外部子类都可以访问</li>
<li>private 表示私有的，只有本类内部可以使用</li>
<li>protected 表示受保护的，只有本类或子类或父类中可以访问</li>
<li><code>__call()</code> 当调用不存在的方法时会自动调用的方法</li>
</ul>
<h4 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h4><ul>
<li><code>__autoload()</code> 在实例化一个尚未被定义的类是会自动调用次方法来加载类文件</li>
<li><code>__set()</code> 当给未定义的变量赋值时会自动调用的方法</li>
<li><code>__get()</code> 当获取未定义变量的值时会自动调用的方法</li>
<li><code>__construct()</code> 构造方法，实例化类时自动调用的方法</li>
<li><code>__destroy()</code> 销毁对象时自动调用的方法</li>
<li><code>__unset()</code> 当对一个未定义变量调用unset()时自动调用的方法</li>
<li><code>__isset()</code> 当对一个未定义变量调用isset()方法时自动调用的方法</li>
<li><code>__clone()</code> 克隆一个对象</li>
<li><code>__tostring()</code> 当输出一个对象时自动调用的方法</li>
</ul>
<h4 id="面向对象6个基本原则"><a href="#面向对象6个基本原则" class="headerlink" title="面向对象6个基本原则"></a>面向对象6个基本原则</h4><ol>
<li>单一职责原则</li>
<li>开闭原则</li>
<li>里氏替换原则</li>
<li>依赖倒置原则</li>
<li>接口隔离原则</li>
<li>合成复用原则</li>
<li>迪米特法则</li>
</ol>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><ul>
<li>自己实现字符串反转</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">strrev</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$len</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$newstr</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token variable">$len</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$newstr</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$str</span><span class="token punctuation">{</span><span class="token variable">$i</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$newstr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>用PHP打印出前一天的时间，打印格式是2007年5月10日22:21:21 <code>echo date(&#39;Y-m-d H:i:s&#39;,strtotime(&#39;-1 day&#39;));</code></li>
<li>写出一个函数,尽可能的高效,从一个标准的URL里取出文件的扩展名例如:<a href="http://www.baidu.com/abc/de/fg.php/?id=1,需要取出" target="_blank" rel="noopener">http://www.baidu.com/abc/de/fg.php/?id=1,需要取出</a> php 或者.php</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">//方法一</span>
<span class="token variable">$url</span> <span class="token operator">=</span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.baidu.com/abc/de/fg.php/?id=1";</span>
<span class="token comment" spellcheck="true">//获得文件目录名字,http://www.baidu.com/abc/de/fg.php</span>
<span class="token keyword">echo</span> <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_DIRNAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//获得文件的扩展名,php</span>
<span class="token variable">$path</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$path</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//方法二</span>
<span class="token variable">$arr</span>  <span class="token operator">=</span>  <span class="token function">parse_url</span><span class="token punctuation">(</span>'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.sina.com.cn/abc/de/fg.php?id=1');</span>
result <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>写一个函数，可以遍历文件夹下的所有文件和文件夹。</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">get_dir_info</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$handle</span> <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//打开目录返回句柄</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$new_dir</span> <span class="token operator">=</span> <span class="token variable">$path</span> <span class="token punctuation">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token punctuation">.</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$content</span> <span class="token operator">==</span> <span class="token string">'..'</span> <span class="token operator">||</span> <span class="token variable">$content</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$new_dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">"&lt;br>目录："</span> <span class="token punctuation">.</span> <span class="token variable">$new_dir</span> <span class="token punctuation">.</span> <span class="token string">'&lt;br>'</span><span class="token punctuation">;</span>
            <span class="token function">get_dir_info</span><span class="token punctuation">(</span><span class="token variable">$new_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">"文件："</span> <span class="token punctuation">.</span> <span class="token variable">$path</span> <span class="token punctuation">.</span> <span class="token string">':'</span> <span class="token punctuation">.</span> <span class="token variable">$content</span> <span class="token punctuation">.</span> <span class="token string">'&lt;br>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">et_dir_info</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>不用新变量直接交换现有两个变量的值</li>
</ul>
<pre class="line-numbers language-php"><code class="language-php"><span class="token function">list</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>CGI 通用网关接口</li>
<li>FastCGI 是一个协议，它是应用程序和WEB服务器连接的桥梁。Nginx并不能直接与PHP-FPM通信，而是将请求通过FastCGI交给PHP-FPM处理 用来提高cgi程序性能，启动一个master，在启动多个worker</li>
<li>php-fpm是FastCGI的进程管理器，可以在启动的时候预先生成多个进程</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/04/10/PHP-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" data-id="ckd5e1www00145znr1v1h0xis" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-RocketMQ-处理分布式事务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/17/RocketMQ-%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" class="article-date">
  <time datetime="2019-02-17T06:03:29.000Z" itemprop="datePublished">2019-02-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/02/17/RocketMQ-%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">RocketMQ 处理分布式事务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在 RocketMQ 中生产者有三种角色 NormalProducer(普通)、OrderProducer(顺序)、TransactionProducer(事务)。</p>
<p>RocketMQ 是一种<strong>最终一致性</strong>的分布式事务。</p>
<p>分布式事务中，如果使用消息中间件来实现最终一致性的分布式事务，是先更新数据库再发消息还是先发消息再更新数据库，这两个操作不是原子的，无论谁先谁后都是有问题的。为了解决该问题，RocketMQ 提出了“事务消息的概念”。</p>
<h2 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h2><p><img src="https://gitee.com/cellophane/image/raw/master/200226.jpg" alt="">发送消息时涉及两个操作：</p>
<ol>
<li>上游服务处理本地事务</li>
<li>发送消息到消息队列<br>当这两个操作有一个失败的而情况下就会出现数据不一致。所以可靠消息要将消息的状态存进数据库，后台会有一个定时运行的线程不停的检查各个消息的状态。如果一直是“待确认”状态，就可以回调上游服务提供的一个接口来查询上游服务是否执行成功。</li>
</ol>
<h3 id="为什么不能把业务处理和发送消息到-MQ-放到一个本地事务？"><a href="#为什么不能把业务处理和发送消息到-MQ-放到一个本地事务？" class="headerlink" title="为什么不能把业务处理和发送消息到 MQ 放到一个本地事务？"></a>为什么不能把业务处理和发送消息到 MQ 放到一个本地事务？</h3><p>如果本地事务处理成功，消息存储成功，MQ 处理超时，ACK 确认失败，会导致本地事务回滚。然而消息却已经发出去，下游就会消费这条消息，就会导致数据不一致。</p>
<p>RocketMQ 的事务消息，就实现了可靠消息服务的所有功能，核心思想跟上面类似。</p>
<h2 id="Half-Message-半消息"><a href="#Half-Message-半消息" class="headerlink" title="Half Message 半消息"></a>Half Message 半消息</h2><p>指暂不能被 Consumer 消费的消息。Producer 已经把消息成功发送到了 Broker 端，但此消息被标记为暂不能投递状态，处于该种状态下的消息称为半消息。需要 Producer</p>
<p>对消息的<strong>二次确认</strong>后，Consumer才能去消费它。</p>
<h3 id="为什么要先发送-Half-Message"><a href="#为什么要先发送-Half-Message" class="headerlink" title="为什么要先发送 Half Message"></a>为什么要先发送 Half Message</h3><ol>
<li>可以先确认 Brock 服务器是否正常，如果半消息都发送失败了，说明 Brock 挂了。</li>
<li>可以通过半消息来回查事务，如果半消息发送成功后一直没有被二次确认，那么就会回查事务状态。</li>
</ol>
<h2 id="消息回查"><a href="#消息回查" class="headerlink" title="消息回查"></a>消息回查</h2><p>Brock 服务器会定时扫描长期处于半消息的消息，会主动询问 Producer 端 该消息的最终状态(Commit 或者 Rollback),该消息即为消息回查。</p>
<h3 id="什么情况会会查"><a href="#什么情况会会查" class="headerlink" title="什么情况会会查"></a>什么情况会会查</h3><ol>
<li>执行本地事务的时候，由于突然网络等原因一直没有返回执行事务的结果(commit 或者 rollback)导致最终返回 UNKNOW，那么就会回查。</li>
<li>本地事务执行成功后，返回 Commit 进行消息二次确认的时候的服务挂了，在重启服务那么这个时候在 brock 端，它还是个 Half Message(半消息)，这也会回查。</li>
</ol>
<h2 id="分布式事务交互流程"><a href="#分布式事务交互流程" class="headerlink" title="分布式事务交互流程"></a>分布式事务交互流程</h2><p><img src="https://gitee.com/cellophane/image/raw/master/0217.jpg" alt="整体交互流程图"></p>
<ol>
<li>A 服务先发送个 Half Message 给 Brock 端，消息中携带 B 服务 即将要 +100 元的信息。 </li>
<li>当 A 服务知道 Half Message 发送成功后，那么开始第 3 步执行本地事务。 </li>
<li>执行本地事务(会有三种情况 1、执行成功。2、执行失败。3、网络等原因导致没有响应) </li>
<li>如果本地事务成功，那么 Product 像 Brock 服务器发送 Commit，这样 B 服务就可以消费该 message。 </li>
<li>如果本地事务失败，那么 Product 像 Brock 服务器发送 Rollback,那么就会直接删除上面这条半消息。</li>
<li>如果因为网络等原因迟迟没有返回失败还是成功，那么会执行 RocketMQ 的回调接口,来进行事务的回查。</li>
</ol>
<p>只有 A 服务本地事务执行成功，B 服务才能消费该 message。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="为什么不在业务成功之后再发送消息？"><a href="#为什么不在业务成功之后再发送消息？" class="headerlink" title="为什么不在业务成功之后再发送消息？"></a>为什么不在业务成功之后再发送消息？</h3><p>如果业务成功，再去发消息，还没来得及发送消息，业务系统就宕机了，根本没有记录之前是否发送过消息，这样就会导致业务执行成功，消息最终没发出去的情况。</p>
<h3 id="如果-consumer-消费失败，是否需要-producer-做回滚呢？"><a href="#如果-consumer-消费失败，是否需要-producer-做回滚呢？" class="headerlink" title="如果 consumer 消费失败，是否需要 producer 做回滚呢？"></a>如果 consumer 消费失败，是否需要 producer 做回滚呢？</h3><p>这里的事务消息，producer 不会因为 consumer 消费失败而做回滚，采用事务消息的应用，其所追求的是高可用和最终一致性，消息消费失败的话，MQ 自己会负责重推消息，直到消费成功。因此，事务消息是针对生产端而言的，而消费端的一致性是通过MQ的重试机制来完成的。</p>
<h3 id="如何保证下游服务的可靠接收"><a href="#如何保证下游服务的可靠接收" class="headerlink" title="如何保证下游服务的可靠接收"></a>如何保证下游服务的可靠接收</h3><ol>
<li>在可靠消息服务里开发一个后台线程，不断的检查消息状态。</li>
<li>如果消息状态一直是“已发送”，始终没有变成“已完成”，那么就说明下游服务始终没有处理成功。</li>
<li>此时可靠消息服务就可以再次尝试重新投递消息到 MQ，让下游服务来再次处理。</li>
<li>只要下游服务的接口逻辑实现<strong>幂等性</strong>，保证多次处理一个消息，不会插入重复数据即可。</li>
</ol>
<h3 id="下游服务如果处理完成后但是通知-Brocker-的过程中挂掉了怎么办"><a href="#下游服务如果处理完成后但是通知-Brocker-的过程中挂掉了怎么办" class="headerlink" title="下游服务如果处理完成后但是通知 Brocker 的过程中挂掉了怎么办"></a>下游服务如果处理完成后但是通知 Brocker 的过程中挂掉了怎么办</h3><p>可靠消息服务会启动相应的后台线程，轮询一直处于“已发送”状态的消息，判断状态持续时间是否超过了规定时间，如果超时，可靠消息服务就会再次向 MQ 服务投递此消息，从而确保消息能被再次消费处理。（注意，也可能出现下游服务处理成功，但是通知消息发送失败的情况，所以为了确保幂等，下游服务也需要在业务逻辑上做好相应的防重处理）。</p>
<h3 id="当-MQ-故障时怎么办"><a href="#当-MQ-故障时怎么办" class="headerlink" title="当 MQ 故障时怎么办"></a>当 MQ 故障时怎么办</h3><p>使用基于 KV 存储的队列支持高可用降级方案。</p>
<ol>
<li>封装 MQ 客户端组件与故障感知，连续 n 次重试尝试投递消息到 MQ 都报错，说明 MQ 故障，此时可以自动感知记忆自动触发降级开关。</li>
<li>通过 zookeeper 触发降级开关。</li>
<li>当 MQ 挂掉之后，使用 redis 的队列来代替。</li>
<li>redis 中要根据实际场景划分 n 个队列，然后通过 hash 算法，均匀写入固定好 n 个 key 对应的 kv 存储队列中。（因为只往一个 key 中写入消息会导致负载过大）</li>
<li>降级开关打开后，需要开启一个线程，每隔一段时间尝试给 MQ 投递一个消息看是否恢复了。</li>
<li>如果恢复了，zk 就可以关闭降级开关，继续往 MQ 投递消息，下游服务在确认 kv 存储的各个队列中已经没有数据之后，就可以重新切换为从 MQ 消费消息。</li>
</ol>
<h3 id="如何保证不被重复消费"><a href="#如何保证不被重复消费" class="headerlink" title="如何保证不被重复消费"></a>如何保证不被重复消费</h3><p>强校验：将 <code>id + 业务场景</code> 的唯一标识写入数据库中，将这个操作和业务操作放到同一个事务里，先用唯一标识去数据库查这条消息有没有被消费，如果没有被消费，就执行事务，被消费了就直接返回。<br>弱校验：将唯一标识作为 Redis 的 key 写入 Redis 里，就算 kv 丢了可能这样的场景也没关系，比如短信通知。</p>
<h3 id="如何保证消费的可靠性传输"><a href="#如何保证消费的可靠性传输" class="headerlink" title="如何保证消费的可靠性传输"></a>如何保证消费的可靠性传输</h3><ol>
<li>生产者丢数据</li>
<li>消息队列丢数据：开启持久化磁盘配置</li>
<li>消费者丢数据</li>
</ol>
<h3 id="如何保证顺序消费"><a href="#如何保证顺序消费" class="headerlink" title="如何保证顺序消费"></a>如何保证顺序消费</h3><p>场景：数据库主从同步，数据量过大，写入消息队列。而增删改的操作一定要是顺序的，比如增改删，变成了改删增，这样本应该被删掉的数据就还在。<br>RocketMQ 中的实现：一个 topic 下面有多个队列，为了保证发送有序，RocketMQ 提供了 MessageQueueSelector 队列选择机制。RocketMQ 的 topic内的队列机制,可以保证存储满足FIFO（First Input First Output 简单说就是指先进先出）,剩下的只需要消费者顺序消费即可。RocketMQ仅保证顺序发送，顺序消费由消费者业务保证。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a href="https://www.cnblogs.com/qdhxhz/p/11191399.html" target="_blank" rel="noopener">分布式事务(3)—RocketMQ实现分布式事务原理</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzU3NDY4NzQwNQ==&mid=2247484545&idx=1&sn=107192bd8e5ce3e40cf01c2c598cdf67&chksm=fd2fd543ca585c55efc7032e49bedfc28abd59753b42fc99f1307561739e8ed887d9ef207261&mpshare=1&scene=1&srcid=0310aB2Xzg0FJP4newiZ0Fp0&sharer_sharetime=1583774285457&sharer_shareid=da3c4e6d38e0827ddba7900a4fab3cd4#rd" target="_blank" rel="noopener">分布式事务之如何基于RocketMQ的事务消息特性实现分布式系统的最终一致性？</a></li>
<li><a href="http://www.tianshouzhi.com/api/tutorials/distributed_transaction/389" target="_blank" rel="noopener">7.0 柔性事务：可靠消息最终一致性</a></li>
<li><a href="https://juejin.im/post/5bf2c6b6e51d456693549af4" target="_blank" rel="noopener">【坑爹呀！】最终一致性分布式事务如何保障实际生产中99.99%高可用？</a></li>
<li><a href="https://juejin.im/post/5d8882bdf265da03c9273821#heading-5" target="_blank" rel="noopener">MQ消息最终一致性解决方案</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25933039" target="_blank" rel="noopener">分布式事务？No, 最终一致性</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2019/02/17/RocketMQ-%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" data-id="ckd5e1wx7001r5znrbjg82qek" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="tag">分布式事务</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-laravel" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/13/laravel/" class="article-date">
  <time datetime="2018-11-13T14:15:49.000Z" itemprop="datePublished">2018-11-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/13/laravel/">laravel 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><ul>
<li>基本路由<pre class="line-numbers language-php"><code class="language-php">Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'基本路由'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li>带必选参数的路由<pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">//路由里的参数不需要和闭包里的参数同名</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test1/{id}'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">"必选参数的路由$id"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>带可选参数的路由<pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">//给参数设置默认值</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test1/{id?}'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">"可选参数的路由$id"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>参数的正则约束<pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">//正则约束的是路由参数，跟路由参数保持一致</span>
Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/testrule/{$id}'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'参数的正则约束'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'\d+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>//多参数的正则约束<br>Route::get(‘/testrule/{name}/{age}’, function ($n, $a) {</p>
<p>})-&gt;where([‘name’ =&gt; ‘w+’, ‘age’ =&gt; ‘\d+’]);</p>
<pre><code>## 控制器
- 
```php
public function show(User $user)
    {
        return view(&#39;users.show&#39;, compact(&#39;user&#39;));
    }</code></pre><p>Laravel 会自动解析定义在控制器方法（变量名匹配路由片段）中的 Eloquent 模型类型声明。在上面代码中，由于 show() 方法传参时声明了类型 —— Eloquent 模型 User，对应的变量名 $user 会匹配路由片段中的 {user}，这样，Laravel 会自动注入与请求 URI 中传入的 ID 对应的用户模型实例。<br>此功能称为 『隐性路由模型绑定』，是『约定优于配置』设计范式的体现，同时满足以下两种情况，此功能即会自动启用：</p>
<ol>
<li>路由声明时必须使用Eloquent模型的单数小写格式来作为路由片段参数</li>
<li>控制器方法传参中必须包含对应的Eloquent模型类型提示，并且是有序的</li>
</ol>
<h2 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h2><pre class="line-numbers language-php"><code class="language-php"><span class="token comment" spellcheck="true">//基本响应</span>
<span class="token function">response</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span><span class="token string">'text/html;charset=utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置Cookie</span>
<span class="token function">response</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">withCookie</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'value'</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">dd</span><span class="token punctuation">(</span>Cookie<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Cookie门面</span>
<span class="token comment" spellcheck="true">//ajax</span>
<span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'aaa'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="原生sql语句"><a href="#原生sql语句" class="headerlink" title="原生sql语句"></a>原生sql语句</h3><ul>
<li>插入返回true或者false</li>
<li>查询返回一个数组，其中每个元素是一个对象</li>
<li>更新操作返回受影响行数，判断失败要用===false判断</li>
<li>删除操作返回受影响行数<h3 id="查询构造器"><a href="#查询构造器" class="headerlink" title="查询构造器"></a>查询构造器</h3></li>
<li>DB::table(‘user’)//用不带表前缀的表名</li>
<li>insert返回true或者false，insertGetId返回自增主键<h3 id="设置查询监听"><a href="#设置查询监听" class="headerlink" title="设置查询监听"></a>设置查询监听</h3></li>
<li>在Providers\AppServiceProviders.php的boot函数中添加<pre class="line-numbers language-php"><code class="language-php">  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      \<span class="token package">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">bindings</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">echo</span> <span class="token string">'&lt;br>'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="监听事件-观察者模式"><a href="#监听事件-观察者模式" class="headerlink" title="监听事件/观察者模式"></a>监听事件/观察者模式</h2>使用 <code>php artisan make:event</code> 事件名称，在 app/Evnent 中就会自动生成一个文件，一个事件可以被一个或多个监听器监听，也就是观察者模式，在 EventServiceProvider 中的 $listen 中可以定义时间和监听器 <pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">protected</span> <span class="token variable">$listen</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'App\Events\UserLogin'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>
      <span class="token string">'App\Listeners\DoSomething1'</span><span class="token punctuation">,</span>
      <span class="token string">'App\Listeners\Dosomething2'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
执行 <code>php artisan event:generate</code>,就可以在 app/Listener 目录生成监听器。<h2 id="安装组件"><a href="#安装组件" class="headerlink" title="安装组件"></a>安装组件</h2></li>
<li>下载</li>
<li>注册到laravel中，先修改config/app.php文件中的providers，然后注册别名，修改aliases<h2 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h2></li>
<li>在模型里面要实现接口，App\User已经实现了所以直接继承</li>
<li>trait是实现接口的方法，在类里面可以直接use<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2></li>
<li>文件存储在storage/public里面，无法访问，所以要添加软链接 php artisan storage:link<h2 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h2></li>
<li>在模型里面引入SoftDeletes</li>
<li>包含trait use SoftDeletes;</li>
<li>定义属性代表软删除字段 $dates=[‘deleted_at’];</li>
</ul>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><ul>
<li>$user-&gt;topics 返回的是数据集合， $user-&gt;topics()返回的是数据库查询语句。$user-&gt;topics == $user-&gt;topics()-&gt;get()。</li>
<li>使用hash_equals()比较两个字符串，无论它们是否相等，本函数的时间消耗是恒定的。本函数可以用在需要防止时序攻击的字符串比较场景中， 例如，可以用在比较 crypt() 密码哈希值的场景。</li>
<li>N+1问题</li>
<li>方法 with() 提前加载了我们后面需要用到的关联属性 user 和 category，并做了缓存。后面即使是在遍历数据时使用到这两个关联属性，数据已经被预加载并缓存，因此不会再产生多余的 SQL 查询</li>
<li>XSS 也称跨站脚本攻击 (Cross Site Scripting)，恶意攻击者往 Web 页面里插入恶意 JavaScript 代码，当用户浏览该页之时，嵌入其中 Web 里面的 JavaScript 代码会被执行，从而达到恶意攻击用户的目的。有两种方法可以避免 XSS 攻击：</li>
</ul>
<p>第一种，对用户提交的数据进行过滤；<br>第二种，Web 网页显示时对数据进行特殊处理，一般使用 htmlspecialchars() 输出</p>
<h1 id="Laravel-源码"><a href="#Laravel-源码" class="headerlink" title="Laravel 源码"></a>Laravel 源码</h1><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><ol>
<li>请求 index.php</li>
<li>注册 composer 自动加载</li>
<li>创建服务容器实例</li>
<li>通过服务容器去解析内核实例，将 HTTP 内核定义的中间件组注册到路由器</li>
<li>将 HTTP 请求实例注册到服务容器，并且通过启动引导程序来加载环境变量、全局配置、异常处理、注册门面、注册服务提供者、启动服务等，随后请求被分发到匹配的路由，在路由中执行中间件以过滤不满足校验规则的请求，只有通过中间件处理的请求才最终处理实际的控制器或匿名函数生成响应结果</li>
<li>获取到响应结果后发送给请求的客户端</li>
<li>运行程序 $kernel-&gt;terminate() 做一些善后清理工作，并最终退出脚本</li>
</ol>
<h2 id="依赖注入，控制反转"><a href="#依赖注入，控制反转" class="headerlink" title="依赖注入，控制反转"></a>依赖注入，控制反转</h2><p>依赖注入模式：不需要自己修改内容，改成由外部传递。<br>laravel 中的依赖注入用反射机制实现</p>
<h2 id="非入侵性-No-instrusive"><a href="#非入侵性-No-instrusive" class="headerlink" title="非入侵性 No instrusive"></a>非入侵性 No instrusive</h2><ul>
<li>框架的目标之一是非侵入性（No intrusive）</li>
<li>组件可以直接拿到另一个应用或框架之中使用</li>
<li>增加组件的可重用性（Reusability）</li>
</ul>
<h2 id="容器-Container"><a href="#容器-Container" class="headerlink" title="容器 Container"></a>容器 Container</h2><ul>
<li>管理对象的生成，资源取得，销毁等生命周期</li>
<li>件里对象与对象之间的依赖关系</li>
<li>启动容器后，所有对象直接取用，不用编写一行代码来产生对象，或是建立对象之间的依赖关系</li>
</ul>
<h2 id="IoC-控制反转-Inversion-of-Control"><a href="#IoC-控制反转-Inversion-of-Control" class="headerlink" title="IoC 控制反转 Inversion of Control"></a>IoC 控制反转 Inversion of Control</h2><ul>
<li>依赖关系的转移</li>
<li>依赖抽象而非实践</li>
</ul>
<h2 id="DI-依赖注入-Dependency-Injection"><a href="#DI-依赖注入-Dependency-Injection" class="headerlink" title="DI 依赖注入 Dependency Injection"></a>DI 依赖注入 Dependency Injection</h2><ul>
<li>不必自己在代码中维护对象的依赖</li>
<li>容器自动根据配置，将依赖注入指定对象<h3 id="依赖注入的三种方式"><a href="#依赖注入的三种方式" class="headerlink" title="依赖注入的三种方式"></a>依赖注入的三种方式</h3></li>
<li>Setter injection 使用setter方法</li>
<li>Constructor injection 使用构造函数</li>
<li>Property Injection 直接设置属性</li>
</ul>
<h2 id="AOP-面向切片编程-Aspect-oriented-programming"><a href="#AOP-面向切片编程-Aspect-oriented-programming" class="headerlink" title="AOP 面向切片编程 Aspect-oriented programming"></a>AOP 面向切片编程 Aspect-oriented programming</h2><ul>
<li>无需修改任何一行程序代码，将功能加入至原先的应用程序中，也可以在不修改任何程序的情况下移除。</li>
</ul>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://segmentfault.com/a/1190000002411255" target="_blank" rel="noopener">PHP程序员如何理解IoC/DI</a></li>
<li><a href="https://www.insp.top/article/learn-laravel-container" target="_blank" rel="noopener">laravel 学习笔记 —— 神奇的服务容器</a></li>
<li><a href="https://learnku.com/laravel/t/1954/on-laravel-design-pattern#3e05a8" target="_blank" rel="noopener">浅谈 Laravel 设计模式</a></li>
<li><a href="https://github.com/cxp1539/laravel-core-learn" target="_blank" rel="noopener">laravel核心知识学习</a></li>
<li><a href="https://laravelacademy.org/post/3088.html?utm_source=tuicool&utm_medium=referral" target="_blank" rel="noopener">Laravel 中管道设计模式的使用 —— 中间件实现原理探究</a></li>
<li><a href="https://www.cnblogs.com/jade640/p/6773125.html" target="_blank" rel="noopener">laravel 管道设计模式 —— 代码理解</a></li>
<li><a href="https://juejin.im/entry/591ab0a8128fe1005cded993" target="_blank" rel="noopener">Laravel 源码分析——看一次 Http 请求到响应</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2018/11/13/laravel/" data-id="ckd5e1wxc00275znr7p2m3tti" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-jwt" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/14/jwt/" class="article-date">
  <time datetime="2018-10-14T07:55:17.000Z" itemprop="datePublished">2018-10-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/14/jwt/">JWT 相关设计</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Token-认证的优势"><a href="#Token-认证的优势" class="headerlink" title="Token 认证的优势"></a>Token 认证的优势</h2><ul>
<li>无状态，可以在多个服务间共享</li>
<li>有效避免了 CSRF 攻击</li>
<li>单点登录友好</li>
</ul>
<h2 id="有效期"><a href="#有效期" class="headerlink" title="有效期"></a>有效期</h2><ul>
<li>方案一：在服务端保存 Token 状态，用户每次操作都会自动刷新 Token。在前后端分离、单页 App 这些情况下，每秒种可能发起很多次请求，每次都去刷新过期时间会产生非常大的代价。</li>
<li>方案二：使用 Refresh Token，一旦 Token 过期，就反馈给前端，前端使用 Refresh Token 申请一个全新 Token 继续使用。当然 Refresh Token 也是有有效期的，但是这个有效期就可以长一点了，比如，以天为单位的时间。Refresh Token 过期用户就要重新登录。</li>
</ul>
<h2 id="并发请求，过期的时候同一个页面发来两个请求"><a href="#并发请求，过期的时候同一个页面发来两个请求" class="headerlink" title="并发请求，过期的时候同一个页面发来两个请求"></a>并发请求，过期的时候同一个页面发来两个请求</h2><p>用 Redis，将旧token作为键，新token作为值，设置一个30秒过期的时间。当第二个请求来的时候，已经知道token在backlist中了，我们可以去redis查询下是否存在这么个旧token，存在的话给他新的 Token。</p>
<h2 id="jWT"><a href="#jWT" class="headerlink" title="jWT"></a>jWT</h2><ul>
<li>Token 有三部分组成，中间用.隔开，并使用 Base64 编码<ul>
<li>header：Token 的类型，苏使用的加密算法<pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>
<span class="token property">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
<span class="token property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>payload</li>
<li>signature：用 Base64 对 header.payload 进行编码，然后用 Secret 对编码后的内容进行加密，加密后的内容即为 Signature<h2 id="OAuth-2-0"><a href="#OAuth-2-0" class="headerlink" title="OAuth 2.0"></a>OAuth 2.0</h2></li>
</ul>
</li>
<li>Third-party applicaton：第三方应用程序，客户端</li>
<li>HTTP service：HTTP 服务提供商</li>
<li>Resource Owner：资源所有者</li>
<li>User Agent：用户代理</li>
<li>Authorization server：认证服务器，即服务提供商专门用来处理认证的服务器。</li>
<li>Resource server：资源服务器，即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。<h2 id="运行流程"><a href="#运行流程" class="headerlink" title="运行流程"></a>运行流程</h2>（A）用户打开客户端以后，客户端要求用户给予授权。</li>
</ul>
<p>（B）用户同意给予客户端授权。</p>
<p>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</p>
<p>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</p>
<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p>
<p>（F）资源服务器确认令牌无误，同意向客户端开放资源。<br><strong>B（客户端授权）是关键</strong></p>
<h3 id="客户端的授权模式"><a href="#客户端的授权模式" class="headerlink" title="客户端的授权模式"></a>客户端的授权模式</h3><ul>
<li>授权码模式</li>
<li>简化模式</li>
<li>密码模式</li>
<li>客户端模式</li>
<li>put 替换某个资源，需提供完整的资源信息</li>
<li>patch 部分修改资源，提供部分资源信息</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">理解 OAuth 2.0</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2018/10/14/jwt/" data-id="ckd5e1wxa00235znrctp23uyb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Nginx-笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/17/Nginx-%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2018-09-17T08:24:00.000Z" itemprop="datePublished">2018-09-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/17/Nginx-%E7%AC%94%E8%AE%B0/">Nginx 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Nginx (“engine x”) 是一个高性能的 HTTP 和 反向代理 服务器，也是一个 IMAP/POP3/SMTP 代理服务器。Nginx 是由 Igor Sysoev 为俄罗斯访问量第二的 Rambler.ru 站点开发的。</p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><ul>
<li>conf 配置文件</li>
<li>html 网页文件</li>
<li>logs 日志文件</li>
<li>sbin 主要二进制程序</li>
</ul>
<h1 id="信号控制与进程控制"><a href="#信号控制与进程控制" class="headerlink" title="信号控制与进程控制"></a>信号控制与进程控制</h1><ul>
<li>kill 信号量 进程号</li>
</ul>
<table>
<thead>
<tr>
<th>信号量</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>TERM，INT</td>
<td>立刻停止</td>
</tr>
<tr>
<td>QUIT</td>
<td>优雅停止</td>
</tr>
<tr>
<td>HUP</td>
<td>改变配置文件，平滑的加载配置文件</td>
</tr>
<tr>
<td>USR1</td>
<td>重读日志文件，在日志按月/日分割时有用</td>
</tr>
<tr>
<td>USR2</td>
<td>平滑升级</td>
</tr>
<tr>
<td>WINCH</td>
<td>优雅关闭旧的进程(配合 USR2 来进行升级)</td>
</tr>
</tbody></table>
<p>如何获得进程号：</p>
<ol>
<li>通过  <code>ps aux|grep nginx</code></li>
<li>通过 nginx  配置文件查看 pid 写在哪个文件 （如 <code>cat /run/nginx.pid</code>） </li>
</ol>
<h2 id="控制命令"><a href="#控制命令" class="headerlink" title="控制命令"></a>控制命令</h2><p>s 代表 signal（信号量）</p>
<ul>
<li>nginx -s stop 立刻停止（INT）</li>
<li>nginx -s quit 优雅停止（QUIT）</li>
<li>nginx -s reload 平滑的加载配置文件（HUP）</li>
<li>nginx -s reopen 重读日志文件（USR1）</li>
<li>nginx -t 测试配置文件是否出错</li>
</ul>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true"># 定义 Nginx 运行的用户和用户组</span>
<span class="token keyword">user</span> www www<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true"># 指有一个工作的子进程，可以自行修改,一般设置为 CPU 数*核数</span>
<span class="token keyword">worker_processes</span> <span class="token number">1</span><span class="token punctuation">;</span> 
Event<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># 单个进程最大连接数（最大连接数=连接数+进程数）</span>
    <span class="token keyword">worker_connections</span> <span class="token number">1024</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true"># 配置 http 服务器</span>
<span class="token keyword">http</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># 虚拟主机配置</span>
    <span class="token keyword">server</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true"># 监听端口</span>
           <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true"># 监听的域名或者 ip</span>
        <span class="token keyword">server_name</span> xxx<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true"># 文件路径，相对于 nginx 根路径</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">access_log</span> logs<span class="token operator">/</span>host<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h2><p>location 有“定位” 的意思，根据 URI 来进行不同的定位。</p>
<p>在虚拟主机的配置中，location 可以把网站的不同部分定位到不同的处理方式上。</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">|</span><span class="token operator">~</span><span class="token operator">|</span><span class="token operator">~</span><span class="token operator">*</span><span class="token operator">|</span><span class="token operator">^</span><span class="token operator">~</span><span class="token punctuation">]</span> patt <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p><code>location = patt{}</code> 精准匹配</p>
</li>
<li><p><code>location patt{}</code> 一般匹配</p>
</li>
<li><p><code>location ~ patt{}</code> 正则匹配</p>
</li>
</ul>
<p>首先看看有没有精准匹配，如果有停止匹配过程。</p>
<h2 id="Rewrite"><a href="#Rewrite" class="headerlink" title="Rewrite"></a>Rewrite</h2><p>rewrite 用来实现 URL 重写，让网站中的 URL 达到某种状态时则定向/跳转到某个规则，但是服务器内部的 rewrite 和 302 跳转不一样，内部的 rewrite 上下文没变。</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true"># 注意 if 后要加空格</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># 重写模式</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>条件的写法：</p>
<ul>
<li><code>=</code>来判断是否相等，用于字符串比较</li>
<li><code>~</code>用来判断正则匹配（区分大小写），<code>~*</code> 不区分大小写</li>
<li><code>-f -d -e</code> 来判断是否为文件，为目录，是否存在</li>
</ul>
<p>正则里如果有{}，正则要用 “” 包括。</p>
<p>例子：</p>
<h3 id="根据方法重写"><a href="#根据方法重写" class="headerlink" title="根据方法重写"></a>根据方法重写</h3><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_mothed</span><span class="token operator">=</span>POST<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="根据浏览器重写"><a href="#根据浏览器重写" class="headerlink" title="根据浏览器重写"></a>根据浏览器重写</h3><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> msie<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ ie<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"># 防止循环重定向</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="访问不存在的路径"><a href="#访问不存在的路径" class="headerlink" title="访问不存在的路径"></a>访问不存在的路径</h3><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">*</span>$ <span class="token number">404</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"># 仍然要加 break</span>
    <span class="token comment" spellcheck="true"># 或者 rewrite ^.*$ 404.html break;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="set-使用示例"><a href="#set-使用示例" class="headerlink" title="set 使用示例"></a>set 使用示例</h3><p>set 是设置变量用的,可以用来达到多条件判断时作标志用。达到 apache 下的 rewrite_condition 的效果</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> msie<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$isie</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fastcgi_scrip_name</span> <span class="token operator">=</span> ie<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">set</span> <span class="token variable">$isie</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$isie</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># 如果是ie浏览器且访问的不是 ie.html 则重定向，作用同上面的 break</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">*</span>$ ie<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="url-重写"><a href="#url-重写" class="headerlink" title="url 重写"></a>url 重写</h3><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>ecshop<span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token string">"goods-(\d{1,7})\.html"</span> <span class="token operator">/</span>ecshop<span class="token operator">/</span>goods<span class="token punctuation">.</span>php<span class="token operator">?</span>id<span class="token operator">=</span>$<span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="将其他图片格式结尾的全部变成gif"><a href="#将其他图片格式结尾的全部变成gif" class="headerlink" title="将其他图片格式结尾的全部变成gif"></a>将其他图片格式结尾的全部变成gif</h3><pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token punctuation">)</span>$<span class="token punctuation">{</span>
<span class="token keyword">rewrite</span> <span class="token string">'(.*?).(jpg|jpeg|png)$'</span> $<span class="token number">1</span><span class="token punctuation">.</span>gif
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="整合-PHP"><a href="#整合-PHP" class="headerlink" title="整合 PHP"></a>整合 PHP</h1><p>Apache 一般是把 PHP 当作自己的模块来启动。<br>而 Nginx 则是把 HTTP 请求变量（如 get，user_agent 等）转发给 php 进程，与 Nginx 进行通信，称为 fastcgi 运行方式。<br>编译后的 php 以 fpm（fastcgi）方式运行<br>把请求的信息转发给 9000 端口的 PHP 进程，让 PHP 处理，指定目录下的 PHP 文件。</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">{</span>
    <span class="token keyword">root</span> html<span class="token punctuation">;</span>
    <span class="token keyword">fastcgi_pass</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
    <span class="token keyword">fastcgi_index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>php
    <span class="token keyword">fastcgi_param</span> SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span> fastcgi_params<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请求过程：</p>
<ol>
<li>遇到 php 结尾的文件</li>
<li>把根目录定位到 html</li>
<li>把请求上下文转交给 php 进程</li>
<li>并告诉 php 进程，当前的脚本是 $document_root$fastcgi_script_name，php 就会去找这个脚本并处理</li>
</ol>
<h2 id="支持-pathinfo"><a href="#支持-pathinfo" class="headerlink" title="支持 pathinfo"></a>支持 pathinfo</h2><ul>
<li>方法一</li>
</ul>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true"># 当请求的文件不存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$request_filename</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>$<span class="token number">1</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>方法二</li>
</ul>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token operator">?</span><span class="token variable">$uri</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>方法三</li>
</ul>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span><span class="token function">php</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">fastcgi_param</span> PATH_INFO $<span class="token number">1</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"># 后向引用</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="传输速度优化"><a href="#传输速度优化" class="headerlink" title="传输速度优化"></a>传输速度优化</h1><h2 id="gzip-压缩"><a href="#gzip-压缩" class="headerlink" title="gzip 压缩"></a>gzip 压缩</h2><p>常用参数</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">gzip</span> on<span class="token operator">|</span>off<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 是否开启gzip</span>
<span class="token keyword">gzip_buffers</span> <span class="token number">32</span> 4K<span class="token operator">|</span> <span class="token number">16</span> 8K <span class="token comment" spellcheck="true"># 缓冲(压缩在内存中缓冲几块? 每块多大?)</span>
<span class="token keyword">gzip_comp_level</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 推荐 6 压缩级别(级别越高,压的越小,越浪费 CPU 计算资源)</span>
<span class="token keyword">gzip_disable</span> <span class="token comment" spellcheck="true"># 正则匹配 UA 什么样的 Uri 不进行 gzip</span>
<span class="token keyword">gzip_min_length</span> <span class="token number">4000</span> <span class="token comment" spellcheck="true"># 开始压缩的最小长度(再小就不要压缩了,意义不在)</span>
<span class="token keyword">gzip_http_version</span> <span class="token number">1.0</span><span class="token operator">|</span><span class="token number">1.1</span> <span class="token comment" spellcheck="true"># 开始压缩的http协议版本(可以不设置,目前几乎全是1.1协议)</span>
<span class="token keyword">gzip_proxied</span> <span class="token comment" spellcheck="true"># 设置请求者代理服务器,该如何缓存内容</span>
<span class="token keyword">gzip_types</span> text<span class="token operator">/</span>plain application<span class="token operator">/</span>xml <span class="token comment" spellcheck="true"># 对哪些类型的文件用压缩 如txt,xml,html ,css</span>
<span class="token keyword">gzip_vary</span> on<span class="token operator">|</span>off <span class="token comment" spellcheck="true"># 是否传输gzip压缩标志</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以写在 http，server，location 里。<br>ps：图片，MP3 这样的二进制文件不必压缩，因为压缩比较小。</p>
<h2 id="expire-缓存"><a href="#expire-缓存" class="headerlink" title="expire 缓存"></a>expire 缓存</h2><p>写在 location 或 if 里面。<br>格式：<code>expires 30s(30m,2h,30d);</code></p>
<pre class="line-numbers language-nginx"><code class="language-nginx">locaion <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>gif<span class="token operator">|</span>png<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">root</span> html<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"># 图片在两天内缓存在浏览器中</span>
    expire 2d<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>服务器的日期要准确，如果服务器的日期落后于实际日期，可能导致缓存失效。</strong></p>
<h1 id="反向代理和负载均衡"><a href="#反向代理和负载均衡" class="headerlink" title="反向代理和负载均衡"></a>反向代理和负载均衡</h1><h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>用 Nginx 做反向代理用 <code>proxy_pass</code>。比如，Nginx 不自己处理图片相关的请求，而是把图片的请求转发给 Apache 来处理。</p>
<p>反向代理反导致后端服务器接收到的客户端 IP为前端服务器的 IP，而不是客户真正的 IP，可以通过设置 <code>X-Forwarded-For</code> 头信息将用户 IP 传到后台服务器。</p>
<p>配置：</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>IP<span class="token punctuation">:</span>port<span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>把多台服务器用 upstream 加入到一个组。</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">upstream</span> imgserver<span class="token punctuation">{</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">81</span> weight<span class="token operator">=</span><span class="token number">1</span> max_fails<span class="token operator">=</span><span class="token number">2</span> fail_timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">82</span> weight<span class="token operator">=</span><span class="token number">1</span> max_fails<span class="token operator">=</span><span class="token number">2</span> fail_timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">upstream</span> <span class="token comment" spellcheck="true"># 做负载均衡不可以用 localhost</span>
<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>png<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>imgserver<span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认地负载均衡算法就是针对后端服务器的顺序，逐个请求。也有其他负载均衡算法，如一致性哈希，需要安装第三方模块。</p>
<h4 id="使用第三方模块实现一致性哈希"><a href="#使用第三方模块实现一致性哈希" class="headerlink" title="使用第三方模块实现一致性哈希"></a>使用第三方模块实现一致性哈希</h4><p>如 <a href="http://wiki.nginx.org/NginxHttpUpstreamConsistentHash" target="_blank" rel="noopener">http://wiki.nginx.org/NginxHttpUpstreamConsistentHash</a><br>这个模块就是用一致性 hash 来请求后端节点，并且其算法与 PHP 中的 memcache 模块的一致性hash算法兼容。<br>安装后</p>
<pre class="line-numbers language-nginx"><code class="language-nginx"><span class="token keyword">upstream</span> memserver <span class="token punctuation">{</span>
    consistent_hash <span class="token variable">$request_uri</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">11211</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">11212</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 PHP.ini 中，如下配置</p>
<pre class="line-numbers language-ini"><code class="language-ini"><span class="token constant">inimemcache.hash_strategy</span> <span class="token attr-value"><span class="token punctuation">=</span> consistent</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="定时任务实现日志按日期存储"><a href="#定时任务实现日志按日期存储" class="headerlink" title="定时任务实现日志按日期存储"></a>定时任务实现日志按日期存储</h1><p>凌晨00:00:01，把昨天的日志重命名，放在相应的目录下。<br>再用 USR1 信息号控制 nginx 重新生成新的日志文件。</p>
<pre class="line-numbers language-shell"><code class="language-shell">#!/bin/bash
base_path='/usr/local/nginx/logs'
log_path=$(date -d yesterday +"%Y%m")
day=$(date -d yesterday +"%d")
mkdir -p $base_path/$log_path
mv $base_path/access.log $base_path/$log_path/access_$day.log
kill -USR1 `cat /usr/local/nginx/logs/nginx.pid`
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Crontab 编辑定时任务</p>
<pre class="line-numbers language-shell"><code class="language-shell">01 00 * * * /xxx/path/b.sh # 每天 0 时 1 分(建议在 02-04 点之间,系统负载小)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://www.jianshu.com/p/bed000e1830b" target="_blank" rel="noopener">WEB请求处理二：Nginx请求反向代理</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://liuyuqi21.github.io/2018/09/17/Nginx-%E7%AC%94%E8%AE%B0/" data-id="ckd5e1wwv00125znr8n823c1t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80/">基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%97%AE%E9%A2%98/">问题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/" rel="tag">Elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JAVA/" rel="tag">JAVA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ZooKeeper/" rel="tag">ZooKeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redisson/" rel="tag">redisson</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typora/" rel="tag">typora</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B9%90%E8%A7%82%E9%94%81/" rel="tag">乐观锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="tag">分布式事务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%91%E6%8C%87Offer/" rel="tag">剑指Offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E7%82%B9/" rel="tag">知识点</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" rel="tag">负载均衡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E7%BB%8F/" rel="tag">面经</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A2%98%E7%9B%AE/" rel="tag">题目</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" rel="tag">高并发</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/Elasticsearch/" style="font-size: 10px;">Elasticsearch</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/JAVA/" style="font-size: 10px;">JAVA</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 12.5px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 20px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/PHP/" style="font-size: 17.5px;">PHP</a> <a href="/tags/Redis/" style="font-size: 17.5px;">Redis</a> <a href="/tags/RocketMQ/" style="font-size: 12.5px;">RocketMQ</a> <a href="/tags/ZooKeeper/" style="font-size: 10px;">ZooKeeper</a> <a href="/tags/leetcode/" style="font-size: 12.5px;">leetcode</a> <a href="/tags/redisson/" style="font-size: 10px;">redisson</a> <a href="/tags/spring/" style="font-size: 10px;">spring</a> <a href="/tags/typora/" style="font-size: 10px;">typora</a> <a href="/tags/%E4%B9%90%E8%A7%82%E9%94%81/" style="font-size: 10px;">乐观锁</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">分布式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" style="font-size: 12.5px;">分布式事务</a> <a href="/tags/%E5%89%91%E6%8C%87Offer/" style="font-size: 20px;">剑指Offer</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">排序</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 12.5px;">操作系统</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 10px;">消息队列</a> <a href="/tags/%E7%9F%A5%E8%AF%86%E7%82%B9/" style="font-size: 10px;">知识点</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 10px;">缓存</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 12.5px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 15px;">设计模式</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">读书笔记</a> <a href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 10px;">负载均衡</a> <a href="/tags/%E9%9D%A2%E7%BB%8F/" style="font-size: 12.5px;">面经</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 10px;">面试</a> <a href="/tags/%E9%A2%98%E7%9B%AE/" style="font-size: 15px;">题目</a> <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">高并发</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/04/11/leetcode-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">leetcode 数据结构</a>
          </li>
        
          <li>
            <a href="/2020/04/01/%E9%9D%A2%E8%AF%95%E8%8C%83%E5%9B%B4/">面试范围</a>
          </li>
        
          <li>
            <a href="/2020/03/23/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a>
          </li>
        
          <li>
            <a href="/2020/03/20/JAVA%20%E5%B9%B6%E5%8F%91/">Java 并发</a>
          </li>
        
          <li>
            <a href="/2020/03/10/typora%E5%BF%AB%E6%8D%B7%E9%94%AE/">typora 快捷键</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Cellophane<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>