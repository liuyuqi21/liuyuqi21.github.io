






<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="author" content="Cellophane">
  
  
  
  
    <meta name="description" content="大型网站架构演化发展历程
应用服务和数据服务分离
使用缓存改善网站性能
使用应用服务器集群改善网站的并发处理能力
数据库读写分离
使用反向代理和 CDN 加速网站响应
使用分布式文件系统和分布式数据库系统
使用 NoSQL 和搜索引擎
业务拆分
分布式服务

高并发系统设计的三大目标高性能性能的度量指标
平均值：把这段时间所有请求的响应时间数据相加，再除以总请求数。
最大值：这段时间内所有请...">
  
  <title>高并发大流量设计思路 [ Cellophane's blog ]</title>
  
  
    <link rel="shortcut icon" href="/icon.ico">
  
  
  
<link rel="stylesheet" href="/css/random.css">
<link rel="stylesheet" href="/css/vegas.min.css">
<link rel="stylesheet" href="/css/highlight-railscasts.css">
<link rel="stylesheet" href="/css/jquery.fancybox.css">
<link rel="stylesheet" href="/css/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css">
<link rel="stylesheet" href="/css/plyr.css">

  
<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism-coy.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>
<div class="side-navigate hide-area">
  
    <div class="item prev">
      <a href="/2019/06/22/Linux-%E5%91%BD%E4%BB%A4/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        linux 命令
      </div>
    </div>
  
  
    <div class="item next">
      <a href="/2019/06/10/%E5%89%91%E6%8C%87Offer-%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%81%E6%95%B0%E7%BB%84/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        剑指Offer-字符串、数组相关
      </div>
    </div>
  
</div>
<div id="outer-container" class="hide-area">
<div id="container">
  <div id="menu-outer" class="slide-down">
    <div id="menu-inner">
      <div id="brand">
        
        <a onClick="openUserCard()">
          <img id="avatar" src="https://i.loli.net/2020/07/27/qrXwW2ghKUdkG9x.png"/>
          <div id="homelink">Cellophane's blog</div>
        </a>
      </div>
      <div id="menu-list">
        <ul>
        
        
          
            <li>
          
            <a href="/index.html">Home</a>
            
          </li>
        
          
            <li>
          
            <a href="/archives">Archives</a>
            
          </li>
        
          
            <li>
          
            <a href="/tags">Tags</a>
            
          </li>
        
          
            <li>
          
            <a href="/categories">Categories</a>
            
          </li>
        
          
            <li>
          
            <a href="/about">About</a>
            
          </li>
        
        </ul>
      </div>
      <div id="show-menu">
        <button>Menu</button>
      </div>
    </div>
  </div>

  <div id="content-outer">
    <div id="content-inner">
      
      
  

  <article id="post">
    <h1>高并发大流量设计思路</h1>
    <p class="page-title-sub">
      <span id = "post-title-date">Created at 2019-06-10</span>
      
        <span id = "post-title-updated">Updated at 2020-07-02</span>
      
      
      <span id = "post-title-categories">Category
      
      
        
        
        <a href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a>
      
      </span>
      
      
        <span id = "post-title-tags">
          Tag
          
          
            
            
            <a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/">高并发</a>
          
        </span>
      
      <span id="/2019/06/10/高并发大流量解决方案/" class="leancloud-visitors" data-flag-title="高并发大流量设计思路">
        <i class="leancloud-visitors-count"></i>
        <em class="post-meta-item-text"> views </em>
      </span>
    </p>
    
    <h2 id="大型网站架构演化发展历程"><a href="#大型网站架构演化发展历程" class="headerlink" title="大型网站架构演化发展历程"></a>大型网站架构演化发展历程</h2><ul>
<li>应用服务和数据服务分离</li>
<li>使用缓存改善网站性能</li>
<li>使用应用服务器集群改善网站的并发处理能力</li>
<li>数据库读写分离</li>
<li>使用反向代理和 CDN 加速网站响应</li>
<li>使用分布式文件系统和分布式数据库系统</li>
<li>使用 NoSQL 和搜索引擎</li>
<li>业务拆分</li>
<li>分布式服务</li>
</ul>
<h1 id="高并发系统设计的三大目标"><a href="#高并发系统设计的三大目标" class="headerlink" title="高并发系统设计的三大目标"></a>高并发系统设计的三大目标</h1><h2 id="高性能"><a href="#高性能" class="headerlink" title="高性能"></a>高性能</h2><h3 id="性能的度量指标"><a href="#性能的度量指标" class="headerlink" title="性能的度量指标"></a>性能的度量指标</h3><ul>
<li>平均值：把这段时间所有请求的响应时间数据相加，再除以总请求数。</li>
<li>最大值：这段时间内所有请求响应时间最长的值。</li>
<li>分位值：</li>
</ul>
<h3 id="高并发下的优化"><a href="#高并发下的优化" class="headerlink" title="高并发下的优化"></a>高并发下的优化</h3><ul>
<li>提高系统的处理核心数</li>
<li>减少单次任务的响应时间</li>
</ul>
<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><h3 id="可用性的度量"><a href="#可用性的度量" class="headerlink" title="可用性的度量"></a>可用性的度量</h3><ul>
<li>MTBF：平均故障间隔</li>
<li>MTTR：故障的平均恢复时间<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 系统设计</span><br><span class="line">- 故障转移</span><br><span class="line">- 超时控制</span><br><span class="line">- 降级</span><br><span class="line">- 限流</span><br><span class="line"></span><br><span class="line">### 系统运维</span><br><span class="line">- 灰度发布</span><br><span class="line">- 故障演练</span><br><span class="line"></span><br><span class="line">## 可扩展</span><br><span class="line"></span><br><span class="line">- 并发：在某个时间点，有多个访问同时到来</span><br><span class="line">- 高并发：如果一个系统日PV在千万以上，有可能是一个高并发系统</span><br><span class="line">- QPS：每秒钟请求或者查询的数量，在互联网领域，指每秒请求数（HTTP请求）</span><br><span class="line">- 吞吐量：单位时间内处理的请求数量（通常由QPS并发数决定）</span><br><span class="line">- 响应时间：从请求发出到响应花费的时间</span><br><span class="line">- PV：综合浏览量（Page View），一个访客在24小时内访问的页面数量，同一个人浏览你的网站同一页面，只记作一次PV</span><br><span class="line">- UV：独立访客（Unique Visitor），一定时间范围内相同访客多次访问网站，只计算为1个独立访客</span><br><span class="line">- 带宽：峰值流量和页面平均大小 </span><br><span class="line">- 日网站带宽&#x3D;PV&#x2F;统计时间（换算到秒）* 平均页面大小（单位kb）* 8 峰值一般是平均值的倍数</span><br><span class="line">- 峰值QPS&#x3D;（总PV数 * 80%）&#x2F;（6个小时秒数 * 20%）</span><br><span class="line">- 压力测试 测试能承受的最大并发 最大承受的QPS值</span><br><span class="line">- 常用性能测试工具</span><br><span class="line">- apache benchmark </span><br><span class="line">    - yum -y install http-tools</span><br><span class="line">    - ab -c100 -n 5000 待测试网站 并发请求100次 总共请求5000次</span><br><span class="line">    - 测试机器与被测试机器分开</span><br><span class="line">- QPS达到100时，数据库缓存，数据库负载均衡 达到800，CDN加速，负载均衡 1000，静态html缓存 2000 业务分离，分布式存储</span><br><span class="line">- 流量优化 防盗链处理</span><br><span class="line">- 前端优化：减少http请求 添加异步请求 启用浏览器缓存和文件压缩 CDN加速 动静分离，静态资源独立部署 独立图片服务器 反向代理</span><br><span class="line">- 服务端优化：页面静态化 并发处理 队列处理 负载均衡 业务拆分</span><br><span class="line">- 数据库优化：数据库缓存 分库分表 分区 读写分离 负载均衡</span><br><span class="line">- web服务器优化：负载均衡  </span><br><span class="line"></span><br><span class="line"># 网站架构模式</span><br><span class="line"></span><br><span class="line">## 分层</span><br><span class="line">- 应用层</span><br><span class="line">- 服务层</span><br><span class="line">- 数据层</span><br><span class="line"></span><br><span class="line">## 分割</span><br><span class="line"></span><br><span class="line">## 分布式</span><br><span class="line">- 分布式应用和服务</span><br><span class="line">- 分布式静态资源</span><br><span class="line">- 分布式数据和存储</span><br><span class="line">- 分布式计算</span><br><span class="line"></span><br><span class="line">## 集群</span><br><span class="line"></span><br><span class="line">## 缓存</span><br><span class="line">- CDN</span><br><span class="line">- 反向代理</span><br><span class="line">- 本地缓存</span><br><span class="line">- 分布式缓存</span><br><span class="line"></span><br><span class="line">## 异步</span><br><span class="line">- 提高系统可用性</span><br><span class="line">- 加快网站响应速度</span><br><span class="line">- 消除并发访问高峰</span><br><span class="line"></span><br><span class="line">## 冗余</span><br><span class="line"></span><br><span class="line">## 自动化</span><br><span class="line"></span><br><span class="line">## 架构在新浪微博的应用</span><br><span class="line">早期架构中，微博发布使用同步推模式，当粉丝多的时候，会引起大量的数据库写操作，超出数据库负载，系统性能急剧下降。后来改用 **异步** 推拉结合模式，用户发表微博后系统将微博写入消息队列后立即返回，消息队列消费者任务将微博推送给左右当前在线粉丝的订阅列表中，非在线用户登陆后再根据关注粉丝列表拉取微博订阅列表</span><br><span class="line"></span><br><span class="line"># 大型网站核心架构要素</span><br><span class="line"></span><br><span class="line">## 性能</span><br><span class="line"></span><br><span class="line">## 可用性</span><br><span class="line"></span><br><span class="line">## 伸缩性</span><br><span class="line"></span><br><span class="line">## 扩展性</span><br><span class="line"></span><br><span class="line">## 安全性</span><br><span class="line"></span><br><span class="line"># 高性能</span><br><span class="line"></span><br><span class="line">- 响应时间</span><br><span class="line">- 并发数</span><br><span class="line">- 吞吐量</span><br><span class="line">- 性能计数器</span><br><span class="line"></span><br><span class="line">## Web 前端性能优化</span><br><span class="line"></span><br><span class="line">一般 Web 前端指网站业务逻辑之前的部分，包括浏览器加载、网站视图模型、图片服务、CDN 服务等，主要优化手段有优化浏览器访问、使用反向代理、CDN 等。</span><br><span class="line"></span><br><span class="line">### 浏览器访问优化</span><br><span class="line">- 减少 http 请求：合并 css，js，图片。</span><br><span class="line">- 使用浏览器缓存：通过设置 HTTP头中 Cache-Control 和 Expires 的属性，可设定浏览器缓存。</span><br><span class="line">- 启用压缩：对 HTML、CSS、JavaScript 文件启用 GZip 压缩可达到较好的效果。</span><br><span class="line">- CSS放页面最上面，JavaScript  放页面最下面。</span><br><span class="line">- 减少 Cookie 传输</span><br><span class="line"></span><br><span class="line">### CDN 加速</span><br><span class="line">CDN（内容分发网络）的本质仍然是一个缓存，并且将数据缓存在离用户最近的地方，是用户以最快速度获取数据，即所谓网络访问第一跳。CDN 能够缓存的一般是静态资源。</span><br><span class="line"></span><br><span class="line">### 反向代理</span><br><span class="line">传统代理服务器位于浏览器一侧，代理浏览器将 HTTP 请求发到互联网上，而反向代理服务器位于网络机房一侧，代理网站 Web 服务器接收 HTTP 请求。</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;Fp8dKB_0fsFQ8n7hJtxKr982AiQF)</span><br><span class="line"></span><br><span class="line">反向代理的作用：</span><br><span class="line"></span><br><span class="line">- 保护网站安全</span><br><span class="line">- 配置缓存加速 Web 请求</span><br><span class="line">- 负载均衡</span><br><span class="line"></span><br><span class="line">## 应用服务器性能优化</span><br><span class="line"></span><br><span class="line">应用服务器就是处理网站业务的服务器，网站的业务代码都部署在这里。优化手段主要有缓存、集群、异步等。</span><br><span class="line"></span><br><span class="line">### 分布式缓存</span><br><span class="line"></span><br><span class="line">当网站遇到性能瓶颈时，第一个想到的解决方案就是使用缓存。缓存即存在于浏览器，也存在于应用服务器和数据库服务器；既可以对数据缓存，也可以对文件缓存，还可以对页面片段缓存。</span><br><span class="line"></span><br><span class="line">&gt; 网站优化第一定律：优先考虑使用缓存优化性能。</span><br><span class="line"></span><br><span class="line">### 异步操作</span><br><span class="line"></span><br><span class="line">使用消息队列将调用异步化，可改善网站的的性能和扩展性。</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;FiGYqtyrGv4BUNdDv6j317FxYwwn)</span><br><span class="line"></span><br><span class="line">在不使用消息队列的情况下，用户的请求数据直接写入数据库，在高并发的情况下，会对数据库造成巨大的压力，同时也使得响应延迟加剧。在使用消息队列后，用户请求的数据发送给消息队列后立即返回，再用消息队列的消费者进程从消息队列中获取数据，异步写入数据库。</span><br><span class="line"></span><br><span class="line">### 使用集群</span><br><span class="line"></span><br><span class="line">在网站高并发访问的场景下，使用负载均衡技术为一个应用构建一个由多台服务器组成的服务器集群，将并发访问请求分发到多台服务器上处理，避免单一服务器因负载压力过大而响应缓慢，使用户请求具有更好的响应延迟特性。</span><br><span class="line"></span><br><span class="line">### 代码优化</span><br><span class="line"></span><br><span class="line">- 多线程</span><br><span class="line">- 资源复用：单例模式、对象池</span><br><span class="line"></span><br><span class="line"># 高可用</span><br><span class="line"></span><br><span class="line">应用层主要处理网站应用的业务逻辑，因此有时也称作业务逻辑层，应用的一个显著特点是应用的无状态性。无状态的应用是指应用服务器不保存业务的上下文信息，而仅根据每次请求提交的数据进行相应的业务逻辑处理，多个服务实例之间完全对等，请求提交到任意服务器，处理结果都是完全一样的。</span><br><span class="line"></span><br><span class="line">## 负载均衡</span><br><span class="line"></span><br><span class="line">负载均衡会把用户发送的访问请求分发到任意一台服务器上处理，当其中一台服务器宕机时，负载均衡服务器通过心跳检测机制发现该服务失去响应，就是把它从服务器列表中删除，而将请求发送到其他服务器上。</span><br><span class="line"></span><br><span class="line">## 集群的 Session 管理</span><br><span class="line"></span><br><span class="line">应用层服务器的高可用架构设计主要基于服务无状态这一特性，但是事实上，业务总是有状态的。Web 应用中将这些多次请求修改使用的上下文对象称作会话（Session），单机情况下，Session 可由部署在服务器上的 Web 容器。在使用负载均衡的集群环境中，要保证每次请求能够获得正确的 Session 比单机时要复杂的多。以下是几种 Session 管理手段。</span><br><span class="line"></span><br><span class="line">### Session 复制</span><br><span class="line"></span><br><span class="line">应用服务器开启 Web 容器的 Session 复制功能，在集群中的几台服务器之间同步 Session 对象，使得每台服务器上都保存所有用户的 Session 信息。</span><br><span class="line"></span><br><span class="line">这种方式需要大量的通信进行 Session 复制，占用服务器和网络大量资源，而且由于所有用户的 Session 信息在每台服务器上都有备份，在大量用户访问的情况下，甚至会出现服务器内存不够的情况。</span><br><span class="line"></span><br><span class="line">### Session 绑定</span><br><span class="line">Session 绑定可以利用负载均衡的源地址 Hash 算法实现，负载均衡服务器总是将来源于同一 IP 的请求分发到同一台服务器上。（也可以根据 Cookie 信息将同一个用户的请求总是分发到同一台服务器上，这时负载均衡服务器必须工作在 HTTP 协议层上。这种方法又叫会话黏滞）。</span><br><span class="line"></span><br><span class="line">这种方法不符合对系统高可用的需求，一旦一台服务器宕机，就无法完成业务处理。</span><br><span class="line"></span><br><span class="line">### 利用 Cookie 记录 Session</span><br><span class="line"></span><br><span class="line">将 Session 记录在客户端，每次请求服务器的时候，将 Session 放在请求中发送给服务器，服务器处理完请求后再将修改过的 Session 响应给客户端。</span><br><span class="line"></span><br><span class="line">利用 Cookie 记录 Session 也有一些缺点，比如受 Cookie 大小限制，每次请求响应都要传输 Cookie，影响性能。如果用户关闭 Cookie，访问就会不正常。</span><br><span class="line"></span><br><span class="line">### Session 服务器</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;FmPftMWCO3lnbpXIq0tYOZkJHrXO)</span><br><span class="line"></span><br><span class="line">利用独立部署的 Session 服务器（集群）统一管理 Session，应用服务器每次读写 Session 时，都访问 Session 服务器。</span><br><span class="line"></span><br><span class="line">这种解决方案事实上是将应用服务器的状态分离，分为无状态的应用服务器和有状态的 Session 服务器，然后针对这两种服务器的不同特性分别设计其架构。</span><br><span class="line"></span><br><span class="line">对于有状态的 Session 服务器，一种比较简单的方法是利用分布式缓存，数据库等，在这些产品的基础上进行包装，使其符合 Session 的存储和访问要求。</span><br><span class="line"></span><br><span class="line">## 高可用的服务</span><br><span class="line"></span><br><span class="line">### 分级管理</span><br><span class="line"></span><br><span class="line">运维上将服务进行分级管理，核心应用和服务优先使用更好的硬件。</span><br><span class="line"></span><br><span class="line">服务部署上进行必要的隔离，避免故障的连锁反应。低优先级的服务通过启动不同的线程或者部署在不同的虚拟机上进行隔离，而高优先级的服务则需要部署在不同的物理机上，核心服务和数据甚至需要部署在不同地域的数据中心。</span><br><span class="line"></span><br><span class="line">### 超时设置</span><br><span class="line"></span><br><span class="line">在应用程序中设置服务调用超时时间，一旦超时，同i性能框架就抛出异常，应用程序根据服务调度策略，可选择重试或将请求转移到提供相同服务的其他服务器上。</span><br><span class="line"></span><br><span class="line">### 异步调用</span><br><span class="line"></span><br><span class="line">通过消息队列等异步方式完成，避免一个服务失败导致整个应用请求失败的情况。</span><br><span class="line"></span><br><span class="line">### 服务降级</span><br><span class="line"></span><br><span class="line">在网站访问高峰期，服务可能因为大量的并发调用而性能下降，严重时可能会导致服务宕机。为了保证核心应用和功能的正常运行，需要对服务进行降级。降级有两种手段：拒绝服务及关闭服务。</span><br><span class="line"></span><br><span class="line">- 拒绝服务：拒绝低优先级应用的调用，减少服务调用并发数，确保核心应用正常使用。或者随即拒绝部分请求应用，节约资源，让另一部分请求得以成功。</span><br><span class="line">- 关闭服务：关闭部分不重要的服务，以节约系统开销，为重要的服务和功能让出资源。</span><br><span class="line"></span><br><span class="line">### 幂等性设计</span><br><span class="line"></span><br><span class="line">应用调用服务失败后，会将调用请求重新发送到其他服务器，但是这个失败可能是虚假的失败。比如服务已经处理成功，但因为网络故障应用没有收到响应，这时应用重新提交请求就导致服务重复调用。</span><br><span class="line"></span><br><span class="line">服务重复调用是无法避免的，因此必须在服务处保证服务重复调用和调用一次产生的结果相同，即服务具有幂等性。</span><br><span class="line"></span><br><span class="line">## 高可用的数据</span><br><span class="line"></span><br><span class="line">保证数据存储高可用的手段主要是数据备份和失效状态转移机制。</span><br><span class="line"></span><br><span class="line">### CAP 原理</span><br><span class="line"></span><br><span class="line">CAP 原理认为，一个提供数据服务的存储系统无法同时满足一致性（Consistency）、数据可用性（Availability）、分区容错性（Partition Tolerance）。</span><br><span class="line"></span><br><span class="line">- 一致性：所用应用程序都能访问得到相同的数据</span><br><span class="line">- 可用性：任何时候，任何应用程序都可以读写访问</span><br><span class="line">- 分区容错性：系统可以跨网络分区线性伸缩</span><br><span class="line"></span><br><span class="line">为了保证数据的高可用，网站通常会牺牲数据一致性。</span><br><span class="line"></span><br><span class="line">数据一致性又可分为：强一致、用户一致、最终一致。</span><br><span class="line"></span><br><span class="line">### 数据备份</span><br><span class="line">- 冷备</span><br><span class="line">- 异步热备</span><br><span class="line">- 同步热备</span><br><span class="line"></span><br><span class="line">### 失效转移</span><br><span class="line"></span><br><span class="line">失效转移操作由三部分组成：</span><br><span class="line"></span><br><span class="line">- 失效确认：系统确认一台服务器是否宕机的手段有两种：**心跳检测和应用程序访问失败报告**。对于应用程序访问失败报告，控制中心还需要再一次发送心跳检测进确认，以免错误判断服务器宕机。</span><br><span class="line">- 访问转移：将数据读写访问重新路由到其他服务器上。</span><br><span class="line">- 数据恢复</span><br><span class="line"></span><br><span class="line"># 伸缩性</span><br><span class="line"></span><br><span class="line">负载均衡不但可以实现网站的伸缩性，同时还可以改善网站的可用性。</span><br><span class="line"></span><br><span class="line">## 负载均衡的实现技术</span><br><span class="line"></span><br><span class="line">### HTTP 重定向</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;FpABIO0yaE4qvUlnw9l_ETBRkNwL)</span><br><span class="line"></span><br><span class="line">HTTP 重定向服务器就是一台普通的应用服务器，其唯一功能就是根据用户的 HTTP 请求计算一台真是的 Web 服务器地址，并将该 Web 服务器地址写入 HTTP 重定向响应（ 302）中返回给用户浏览器。</span><br><span class="line"></span><br><span class="line">- 优点：实现比较简单</span><br><span class="line">- 缺点：是浏览器需要请求两次服务器才能完成一次访问，性能较差。</span><br><span class="line"></span><br><span class="line">### DNS 域名解析</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;FsLQ4rXQzzCQKPN5orpI90dA0tr6)</span><br><span class="line"></span><br><span class="line">在 DNS 服务器中配置多个 A 记录，每次域名解析请求都会根据负载均衡算法计算一个不同的 IP 地址返回。这样 A 记录中配置的多个服务器就会构成一个集群，并实现负载均衡。</span><br><span class="line"></span><br><span class="line">- 优点：是将负载均衡的工作转交给 DNS，同时许多 NDS 还支持基于地理位置的域名解析，会将域名解析成距离用户地理最近的一个服务器，加快用户访问速度。</span><br><span class="line">- 缺点：DNS 是多级解析，每一级 DNS 都可能缓存 A 记录，当下线某台服务器修改了 A 记录后，使其生效也需要较长时间，这段时间 DNS 依然会将域名解析到已经下线的服务器，导致用户访问失败。</span><br><span class="line"></span><br><span class="line">### 反向代理</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;Fi4JNF39iL0S4VTm5SiWzPmT6VW9)</span><br><span class="line"></span><br><span class="line">反向代理服务器将请求根据负载均衡算法转发到不同 Web 服务器上。Web 服务器处理完成的响应也需要反向代理服务器返回给用户，由于 Web 服务器不直接对外提供访问，因此需不要使用外部 IP 地址，而反向代理服务器需要配置内外网 IP。</span><br><span class="line"></span><br><span class="line">反向代理服务器转发请求在 HTTP 协议层面，因此也叫应用层负载均衡。</span><br><span class="line"></span><br><span class="line">- 优点：和反向代理服务器功能集成在一起，部署简单。</span><br><span class="line">- 缺点：反向代理服务器是所有请求和相应的中转站，其性能可能会成为瓶颈。</span><br><span class="line"></span><br><span class="line">### IP 负载均衡</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;Fnrymkqn1-ouoAJjOKpOtLYKAG0Q)</span><br><span class="line"></span><br><span class="line">在**网络层**通过修改请求目标地址进行负载均衡。</span><br><span class="line"></span><br><span class="line">- 优点：在内核进程内完成数据分发，较反向代理有更好的处理性能。</span><br><span class="line">- 缺点：集群的最大响应数据吞吐量受限于负载均衡服务器网卡带宽。</span><br><span class="line"></span><br><span class="line">### 直接路由</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;q6z2k96rl.bkt.clouddn.com&#x2F;FnAOZ6qilLNMoGZ_3NeFXpIp7cmO)</span><br><span class="line"></span><br><span class="line">是指在通信协议的数据链路层修改 mac 地址进行负载均衡，这种传输方式又称三角传输模式。实际请求的正是物理服务器 IP 和数据请求目的 IP 一致，不需要通过负载均衡服务器进行地址转换。</span><br><span class="line"></span><br><span class="line">这种三角传输模式的链路层负载均衡是目前大型网站使用最广的一种负载均衡手段。在 Linux 平台上最好的链路层负载均衡开源产品是 LVS（Linux Virtual Server）。</span><br><span class="line"></span><br><span class="line">- 优点：避免负载均衡服务器网卡带宽称为瓶颈。</span><br><span class="line"></span><br><span class="line">## 负载均衡算法</span><br><span class="line"></span><br><span class="line">### 轮询（ Round Robin，RR）</span><br><span class="line"></span><br><span class="line">所有请求被依次分发到每台应用服务器上，即每台服务器需要处理的请求数目都相同，适合于所有服务器硬件都相同的场景。</span><br><span class="line"></span><br><span class="line">### 随机（ Random）</span><br><span class="line"></span><br><span class="line">请求被随机分配到各个应用服务器。如果应用服务器硬件配置不同，也可以使用加权随机算法。</span><br><span class="line"></span><br><span class="line">### 最少连接（ Least Connections）</span><br><span class="line"></span><br><span class="line">记录每个应用服务器正在处理的连接数，将新的请求分发到最少链接的服务器上。最少连接算法也可以实现加权最少连接。</span><br><span class="line"></span><br><span class="line">### 源地址散列（ Source Hashing）</span><br><span class="line"></span><br><span class="line">根据请求来源的 IP 地址进行 Hash 计算，得到应用服务器。这样来自同一个 IP 渎职的请求总在同一个服务器上处理，该请求的上下文信息可以存储在这台服务器上，在一个绘画周期重复使用，从而实现会话粘滞。</span><br><span class="line"></span><br><span class="line"># 网站的安全架构</span><br><span class="line"></span><br><span class="line">## XSS（跨站脚本攻击）</span><br><span class="line"></span><br><span class="line">黑客通过篡改网页，注入恶意 HTML 脚本，在用户浏览网页时，控制用户浏览器进行恶意操作的一种方式。</span><br><span class="line"></span><br><span class="line">常见的 XSS 攻击类型有两种。</span><br><span class="line"></span><br><span class="line">- 反射型：攻击者诱使用户点击一个嵌入恶意脚本的链接，达到攻击目的。</span><br><span class="line">- 持久性：黑客提交含有恶意脚本的请求，保存至被攻击的 Web 站点的数据库中，用户浏览网页时，恶意脚本被包含在正常页面中，达到攻击目的。</span><br><span class="line"></span><br><span class="line">### 防范手段</span><br><span class="line"></span><br><span class="line">- 过滤特殊字符</span><br><span class="line">- HttpOnly</span><br><span class="line"></span><br><span class="line">### 危害</span><br><span class="line">- 窃取用户的 Cookie</span><br><span class="line">- 伪造虚假的输入表单片区个人信息</span><br><span class="line">- 显示伪造的文章或者图片</span><br><span class="line"></span><br><span class="line">### 防范手段</span><br><span class="line">- 过滤特殊字符</span><br><span class="line">- HttpOnly：防止窃取 Cookie</span><br><span class="line"></span><br><span class="line">## CSRF （跨站请求伪造）</span><br><span class="line"></span><br><span class="line">### 防范手段</span><br><span class="line">- 检查 Refer 首部字段</span><br><span class="line">- 添加校验 Token</span><br><span class="line">- 输入验证码</span><br><span class="line"></span><br><span class="line">## SQL 注入</span><br><span class="line"></span><br><span class="line">### 防范手段</span><br><span class="line">- 使用参数化查询 preparedStatement</span><br><span class="line">- 单引号转换</span><br><span class="line"></span><br><span class="line">## 拒绝服务攻击（洪水攻击）</span><br><span class="line">其目的在于使目标电脑的网络或系统资源耗尽，使服务暂时中断或停止，导致其正常用户无法访问。</span><br><span class="line"></span><br><span class="line">分布式拒绝服务攻击（distributed denial-of-service attack，DDoS），指攻击者使用两个或以上被攻陷的电脑作为“僵尸”向特定的目标发动“拒绝服务”式攻击。</span><br><span class="line"></span><br><span class="line">### 防范手段</span><br><span class="line">- 防火墙：防火墙可以设置规则，例如允许或拒绝特定通讯协议，端口或IP地址。当攻击从少数不正常的IP地址发出时，可以简单的使用拒绝规则阻止一切从攻击源IP发出的通信。</span><br><span class="line"></span><br><span class="line"># 对于大流量的网站,您采用什么样的方法来解决访问量问题?</span><br><span class="line">优化程序，优化数据库，如果程序和数据库已经最优化，使用以下解决方法：</span><br><span class="line">1. 确定当前服务器设备是否满足流量需求。</span><br><span class="line">1. 使用Memcache缓存技术，把动态内容缓存到文件中，动态网页直接调用这些文件，而不必再访问数据库。</span><br><span class="line">1. 禁止外部盗链，图片和文件外部盗链会给服务器带来大量的负载压力，可以通过refer来禁止外部盗链，或者使用apache来配置禁止盗链。</span><br><span class="line">1. 控制大文件的下载，大文件的下载对于非SCSI硬盘来说会占用大量的资源，导致服务器的响应能力下降。</span><br><span class="line">1. 使用不同的主机分流主要流量，使服务器均衡负载。</span><br><span class="line">1. 使用流量统计软件统计分析网站流量，可以知道哪些地方耗费了大量的流量，哪些页面需要再进行优化。</span><br><span class="line"></span><br><span class="line">## 系统如何支持高并发</span><br><span class="line">1. 系统集群化部署</span><br><span class="line">1. 数据库分库分表 + 读写分离</span><br><span class="line">1. 缓存集群的引入</span><br><span class="line">1. 引入消息中间件集群</span><br><span class="line"></span><br><span class="line">## web资源防盗链</span><br><span class="line">- 概念：在自己的页面上战视一些并不在自己服务器上的内容</span><br><span class="line">- 工作原理：</span><br><span class="line">    1. 通过Referer或者签名，检测目标网页访问的来源网页，如果是资源文件，则可以追踪到显示他的网址，一旦检测到来源不是本站即进行阻止或返回指定的页面</span><br><span class="line">    1. 通过计算签名的方式，判断请求是否合法，如果合法则显示，否则返回错误信息</span><br><span class="line">- Refer方法：Nginx模块ngx_http_refer_module用于阻挡来源非法的域名请求，Nginx指令valid_referers 全局变量$invaild_referer</span><br><span class="line"></span><br><span class="line">## 减少http请求</span><br><span class="line">- 图片地图：将 5 个图片合并为一张图片，然后以位置定位超链接。把 HTTP 请求减少为一个</span><br><span class="line">- CSS Sprites：CSS 精灵，通过合并图片，指定 css 的 background-image 和 background-position 来显示元素 </span><br><span class="line">- 合并脚本和样式表</span><br><span class="line">- 图片使用 Base64编码</span><br><span class="line"></span><br><span class="line">## 浏览器缓存</span><br><span class="line"></span><br><span class="line">### 缓存分类</span><br><span class="line">[浏览器缓存 200(from cache) 和 304](https:&#x2F;&#x2F;shaoshilei.com&#x2F;2014-08&#x2F;re-note-browser-cache-200-from-cache-and-304-summary.html)</span><br><span class="line">- 200 from cache：本地缓存（强制缓存），最快速，最省流量，因为根本没有向服务器发送请求。</span><br><span class="line">    相关 Header</span><br><span class="line">    - Pragma：HTTP 1.0 时代的遗留产物，该字段被设置为 no-cacche 时，会告知浏览器禁用本地缓存</span><br><span class="line">    - Expires：HTTP 1.0 时代来启用本地缓存的字段，值是一个格林威治时间，告诉浏览器缓存实现的时刻，如果还没到该时刻，则缓存有效，浏览器与服务器时间无法保持一致，如果时间差距大，就会影响缓存结果。</span><br><span class="line">    - Cache-Control：HTTP 1.1 针对 Expires 时间不一致的解决方案，告知的是过期时间间隔，不是时刻。</span><br><span class="line">        - no-store：禁止浏览器缓存相应</span><br><span class="line">        - no-cache：不允许直接使用本地缓存，先发起请求和服务器协商</span><br><span class="line">        - max-age&#x3D;delta-seconds：告知浏览器该响应本地缓存有效的最长期限，以秒为单位，如果和 Last-Modified 一起使用，优先级较高</span><br><span class="line">    - 优先级：Pragma &gt; Cache-Control &gt; Expires</span><br><span class="line">- 304 Not Modified：协商缓存，浏览器在本地缓存没有命中的情况下请求头中发送一定的校验数据到服务端，如果服务端数据没有改变浏览器从本地缓存响应，返回 304。只返回一些响应头信息，不发送相应实体</span><br><span class="line">    相关 Header</span><br><span class="line">    - Last-Modified（响应头）：通知浏览器资源的最后修改时间</span><br><span class="line">    - If-Modified-Since（请求头）：得到资源的最后修改时间后，会将这个信息通过 If-Modified-Since（里面的值就是  Last-Modified） 提交到服务器做检查，如果没有修改，返回 304。</span><br><span class="line">    - ETag：HTTP 1.1 推出，文件的指纹标识符，如果文件内容修改，值会改变。</span><br><span class="line">    - If-None-Match：本地缓存失效，会携带 ETag 的值去请求服务端，服务端判断该资源是否改变，如果没有改变，直接使用本地缓存，返回 304。</span><br><span class="line"></span><br><span class="line">### 缓存策略的选择</span><br><span class="line"></span><br><span class="line">#### 本地缓存</span><br><span class="line">- 不变的图像：如 Logo</span><br><span class="line">- js，css 静态文件</span><br><span class="line">- 可下载的内容，媒体文件</span><br><span class="line"></span><br><span class="line">#### 协商缓存</span><br><span class="line">- HTML 文件</span><br><span class="line">- 经常替换的图片</span><br><span class="line">- 经常修改的 js，css：可以加入文件的签名来拒绝缓存，index.css?签名</span><br><span class="line"></span><br><span class="line">#### 不建议缓存的数据</span><br><span class="line">- 用户隐私等敏感信息</span><br><span class="line">- 经常改变的 api 数据接口</span><br><span class="line"></span><br><span class="line">### Nginx 配置写法</span><br><span class="line">&#96;&#96;&#96;conf</span><br><span class="line">gzip on|off; #是否开启gzip</span><br><span class="line">gzip_buffers 32 4K| 16 8K #缓冲(压缩在内存中缓冲几块? 每块多大?)</span><br><span class="line">gzip_comp_level [1-9] #推荐6 压缩级别(级别越高,压的越小,越浪费CPU计算资源)</span><br><span class="line">gzip_types text&#x2F;plain application&#x2F;xml # 对哪些类型的文件用压缩 如txt,xml,html ,css</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="前端代码和资源压缩"><a href="#前端代码和资源压缩" class="headerlink" title="前端代码和资源压缩"></a>前端代码和资源压缩</h2><ul>
<li>js 代码压缩工具：UglifyJS，YUI Compressor，Closure</li>
<li>css 压缩工具：YUI Compressor，CSS Compressor</li>
<li>使用 Gzip 压缩</li>
<li>图片压缩：tinypng，JpegMini，ImageOptim<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gzip on|off;</span><br><span class="line">gzip_buffers 32 4k|16 8k;&#x2F;&#x2F;缓冲（在内存中缓冲几块？每块多大）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="web服务器的负载均衡"><a href="#web服务器的负载均衡" class="headerlink" title="web服务器的负载均衡"></a>web服务器的负载均衡</h2><ul>
<li><p>七层负载均衡的实现</p>
<ul>
<li>功能强大，性能卓越，运行稳定</li>
<li>配置简单灵活</li>
<li>能够自动剔除工作不正常的后端服务器</li>
<li>上传文件使用异步模式</li>
<li>指出多种分配策略，可以分配权重，分配方式灵活</li>
</ul>
</li>
<li><p>四层负载均衡的实现</p>
</li>
<li><p>Nginx的负载均衡</p>
<ul>
<li>内置策略：IP Hash、加权轮询</li>
<li>扩展策略：fair策略，通用hash、一致性hash</li>
</ul>
<h2 id="CDN-加速"><a href="#CDN-加速" class="headerlink" title="CDN 加速"></a>CDN 加速</h2><p>CDN 的全称是 Content Delivery Network，即内容分发网络。在网络各处放置节点服务器所构成的在现有的互联网基础上的一层只能虚拟网络。</p>
</li>
</ul>
<p>CDN 系统能够实时地根据网络流量和个节点的连接，负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。</p>
<h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul>
<li>本地 Cache 加速，提高了企业站点（尤其含有大量图片和静态页面站点）的访问速度</li>
<li>跨运营商的网络加速，保证不同网络的用户都得到良好的访问质量</li>
<li>远程访问用户根据 DNS 负载均衡技术自动选择 Cache 服务器</li>
<li>自动生成服务器的远程 Mirror（镜像）cache 服务器，减轻远程访问的带宽，分担网络流量， 减轻原站点 WEB 服务器负载</li>
<li>广泛分布的 CDN 节点加上节点之间的智能冗余机制，可以有效地预防黑客入侵</li>
</ul>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p><img src="en-resource://database/759:1" alt="39fe06f111d2f55b8ed33653a6a3fe7e.svg+xml"><br><img src="en-resource://database/761:1" alt="3ab1a8b733d13e36e00a9e2f7a237438.png"></p>
<h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><ul>
<li>站点或者应用中大量静态资源加速分发</li>
<li>大文件下载</li>
<li>直播网站</li>
</ul>
<h3 id="CDN-的实现"><a href="#CDN-的实现" class="headerlink" title="CDN 的实现"></a>CDN 的实现</h3><ul>
<li>使用现成的</li>
<li>用 LVS 做 4 层负载均衡</li>
<li>可用 Nginx，Varnish，Squid，Apache TrafficServer做 7 层负载均衡</li>
<li>使用 squid 做反向代理，或者 Nginx 等做反向代理</li>
</ul>
<h2 id="建立独立的图片服务器"><a href="#建立独立的图片服务器" class="headerlink" title="建立独立的图片服务器"></a>建立独立的图片服务器</h2><h3 id="必要性"><a href="#必要性" class="headerlink" title="必要性"></a>必要性</h3><ul>
<li>分担 Web 服务器的 I/O 负载，将耗费资源的图片服务分离出来，题搞服务器的性能和稳定性</li>
<li>能够专门对图片服务器进行优化，为图片服务设置有针对性的缓存方案每减少带宽成本，提高访问速度</li>
<li>提高网站的可扩展性，通过增加图片服务器，提高图片吞吐力</li>
</ul>
<h3 id="采用独立域名"><a href="#采用独立域名" class="headerlink" title="采用独立域名"></a>采用独立域名</h3><ul>
<li>同一域名下浏览器的并发链接数有限制，突破浏览器并发限制</li>
<li>由于 cookie 的原因，对缓存不利，大部分 web cache都只缓存不带 cookie 的请求，导致每次的图片请求都不能命中 cache</li>
</ul>
<h2 id="如何进行图片上传和同步"><a href="#如何进行图片上传和同步" class="headerlink" title="如何进行图片上传和同步"></a>如何进行图片上传和同步</h2><ul>
<li>NFS 共享方式</li>
<li>利用 FTP 同步</li>
</ul>
<h2 id="动态语言静态化"><a href="#动态语言静态化" class="headerlink" title="动态语言静态化"></a>动态语言静态化</h2><p>将现有 PHP 等动态语言的逻辑代码生成为静态 HTML 文件，用户访问动态脚本重定向到静态 HTML 文件的过程。<br>动态脚本通常会做逻辑和数据查询，访问量越大，服务器压力越大，CPU 负载过高，数据库服务器压力大。</p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><ul>
<li>使用模板引擎</li>
<li>使用 ob 系列函数<ul>
<li>ob_start()：打开输出控制缓冲</li>
<li>ob_get_contents()：返回输出缓冲区的内容</li>
<li>ob_clean()：清空输出缓冲区</li>
<li>ob_end_flush()：冲刷出输出缓冲区内容并关闭缓冲</li>
</ul>
</li>
</ul>
<h2 id="动态语言层的并发处理"><a href="#动态语言层的并发处理" class="headerlink" title="动态语言层的并发处理"></a>动态语言层的并发处理</h2><ul>
<li>就绪状态：线程具备运行的所有条件，逻辑上可以运行，在等待处理机</li>
<li>运行状态：线程占有处理机正在运行</li>
<li>阻塞状态：线程在等待一个事件（如某个信号量），逻辑上不可执行</li>
</ul>
<h3 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h3><p>协程是一种用户态的轻量级线程，写成的调度完全由用户控制。协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其他地方，再切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快。</p>
<h3 id="线程和进程的区别"><a href="#线程和进程的区别" class="headerlink" title="线程和进程的区别"></a>线程和进程的区别</h3><ol>
<li>线程是进程内的一个执行单元，进程内至少有一个线程，他们共享进程的地址空间，而进程有自己独立的地址空间</li>
<li>进程是资源分配的基本单位，同一个进程内的线程共享进程的资源</li>
<li>线程是处理器调度的基本单位</li>
</ol>
<h3 id="线程与协程的区别"><a href="#线程与协程的区别" class="headerlink" title="线程与协程的区别"></a>线程与协程的区别</h3><ol>
<li>一个线程可以有多个协程，一个进程也可以单独拥有多个线程</li>
<li>线程进程都是同步机制，而协程是异步</li>
<li>协程能保留上一次调用时的状态，每次过程重入时，就相当于进入上一次调用的状态</li>
</ol>
<h2 id="数据库缓存层优化"><a href="#数据库缓存层优化" class="headerlink" title="数据库缓存层优化"></a>数据库缓存层优化</h2><h2 id="MySQL-数据层优化"><a href="#MySQL-数据层优化" class="headerlink" title="MySQL 数据层优化"></a>MySQL 数据层优化</h2><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651961829&idx=1&sn=6992d6e36abf3c2918fc3e743b96abed&chksm=bd2d0c398a5a852f97a4fd6cd078486a27311e71d825073003d06969440337f32ef6a856c9f0&scene=21#wechat_redirect" target="_blank" rel="noopener">“反向代理层”绝不能替代“DNS轮询”！</a></li>
</ul>

  </article>
  <div class="random-toc-area">
  <button class="btn-hide-toc btn-hide-toc-show" style="display: none" onclick="TOCToggle()">Show TOC</button>
  <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">Hide TOC</button>
  <div class="random-toc">
    <h2>Table of Content</h2>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#大型网站架构演化发展历程"><span class="toc-text">大型网站架构演化发展历程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#高并发系统设计的三大目标"><span class="toc-text">高并发系统设计的三大目标</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#高性能"><span class="toc-text">高性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#性能的度量指标"><span class="toc-text">性能的度量指标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#高并发下的优化"><span class="toc-text">高并发下的优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高可用"><span class="toc-text">高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#可用性的度量"><span class="toc-text">可用性的度量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前端代码和资源压缩"><span class="toc-text">前端代码和资源压缩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#web服务器的负载均衡"><span class="toc-text">web服务器的负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CDN-加速"><span class="toc-text">CDN 加速</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#优势"><span class="toc-text">优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工作原理"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#场景"><span class="toc-text">场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CDN-的实现"><span class="toc-text">CDN 的实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立独立的图片服务器"><span class="toc-text">建立独立的图片服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#必要性"><span class="toc-text">必要性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#采用独立域名"><span class="toc-text">采用独立域名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何进行图片上传和同步"><span class="toc-text">如何进行图片上传和同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态语言静态化"><span class="toc-text">动态语言静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实现方式"><span class="toc-text">实现方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态语言层的并发处理"><span class="toc-text">动态语言层的并发处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#协程"><span class="toc-text">协程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程和进程的区别"><span class="toc-text">线程和进程的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程与协程的区别"><span class="toc-text">线程与协程的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库缓存层优化"><span class="toc-text">数据库缓存层优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL-数据层优化"><span class="toc-text">MySQL 数据层优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文章"><span class="toc-text">参考文章</span></a>
  </div>
</div>

  
  
<nav id="pagination">
  
    <a href="/2019/06/22/Linux-%E5%91%BD%E4%BB%A4/" class="prev">&larr; Prev post linux 命令</a>
  

  

  
    <a href="/2019/06/10/%E5%89%91%E6%8C%87Offer-%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%81%E6%95%B0%E7%BB%84/" class="next">Next post 剑指Offer-字符串、数组相关 &rarr;</a>
  
</nav>

  <!-- JiaThis Button BEGIN -->

<!-- JiaThis Button END -->


      
      
    </div>
  </div>

  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Cellophane using
      <a href="http://hexo.io" target="_blank" rel="noopener">Hexo</a> & <a href="https://github.com/stiekel/hexo-theme-random" target="_blank" rel="noopener">Random</a>
      <br>
      
    </div>
  </div>
</div>

</div>


<div id="user-card">
  <div class="center-field">
    <img class="avatar" src="https://i.loli.net/2020/07/27/qrXwW2ghKUdkG9x.png">
    <p id="description"></p>
    <ul class="social-icon">
  
  
    <li>
      <a href="https://github.com/liuyuqi21" target="_blank" rel="noopener">
        
          <i class="icon iconfont github">&#xe606;</i>
        
      </a>
    </li>
  
    <li>
      <a href="823458299@qq.com">
        
          M
        
      </a>
    </li>
  
</ul>
  </div>
</div>


<div id="btn-view">Hide</div>

<script>
// is trigger analytics / tongji script
var isIgnoreHost = false;

if(window && window.location && window.location.host) {
  isIgnoreHost = ["localhost","127.0.0.1"].some(function(address){
    return 0 === window.location.host.indexOf(address);
  });
}

var isTriggerAnalytics = !( true && isIgnoreHost );

</script>




  
  
    <script src="/js/jquery-2.2.3.min.js"></script>
  
    <script src="/js/vegas.min.js"></script>
  
    <script src="/js/random.js"></script>
  
    <script src="/js/highlight.pack.js"></script>
  
    <script src="/js/jquery.mousewheel.pack.js"></script>
  
    <script src="/js/jquery.fancybox.pack.js"></script>
  
    <script src="/js/jquery.fancybox-thumbs.js"></script>
  
    <script src="/js/plyr.js"></script>
  

<script>

  // fancybox
  var backgroundImages = [];
  
  $('#post').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox') || $(this).parent().hasClass('fancybox-thumb')) return;
      var alt = this.alt || this.title;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'post' + i);
    });
  });
  $(".fancybox").fancybox();

var vegasConfig = {"preload­Image":true,"transition":["flash"],"timer":true,"delay":1500000,"shuffle":true,"count":12};
var unsplashConfig = {"gravity":"center"};
// is show background images
var turnoffBackgroundImage = false;




var backgroundColor = "34495E";

$(".fancybox-thumb").fancybox({
  prevEffect: 'none',
  nextEffect: 'none',
  helpers: {
    title: {
      type: 'outside'
    },
    thumbs: {
      width: 50,
      height: 50
    }
  }
});

// show video with plyr
$(".video-container iframe").each(function(i){
  var url = $(this).attr('src');
  var id = url.split('/').pop();
  var plyrContainer = document.createElement('div');
  plyrContainer.className = 'plyr';
  var plyrElement = document.createElement('div');
  plyrElement.dataset.videoId = id;
  switch(true) {
    case url.search('youtube.com') >= 0:
      plyrElement.dataset.type = 'youtube';
      break;
    case url.search('vimeo.com') >= 0:
      plyrElement.dataset.type = 'vimeo';
      break;
    default:
      return;
  };
  plyrContainer.appendChild(plyrElement);
  $(this).parent().html(plyrContainer);
});
plyr.setup('.plyr', {iconUrl: '/css/sprite.svg'});
</script>
</body>
</html>

