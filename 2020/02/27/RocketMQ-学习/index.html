






<!doctype html>
<html lang="zh-CN">
<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="author" content="Cellophane">
  
  
  
  
    <meta name="description" content="RocketMQ 优势目前主流的 MQ 主要是 RocketMQ、kafka、RabbitMQ，RocketMQ 相比于 RabbitMQ、kafka 具有主要优势特性有：

支持事务型消息（消息发送和 DB 操作保持两方的最终一致性，RabbitMQ、kafka 和 kafka 不支持）
支持结合 RocketMQ 的多个系统之间数据最终一致性（多方事务，二方事务是前提）
支持 18 个级...">
  
  <title>RocketMQ 学习 [ Cellophane ]</title>
  
  
    <link rel="shortcut icon" href="/Blinky.ico">
  
  
  <link rel="stylesheet" href="/css/random.css">
<link rel="stylesheet" href="/css/vegas.min.css">
<link rel="stylesheet" href="/css/styles/railscasts.css">
<link rel="stylesheet" href="/css/jquery.fancybox.css">
<link rel="stylesheet" href="/css/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/jquery.fancybox-thumbs.css">
<link rel="stylesheet" href="/css/plyr.css">
<link rel="stylesheet" href="/css/prism.css">
  
</head>

<body>
<div class="side-navigate hide-area">
  
  
    <div class="item next">
      <a href="/2020/02/19/Head First设计模式阅读笔记/">
        <div class="item-icon"></div>
      </a>
      <div class="item-title">
        Head First设计模式阅读笔记
      </div>
    </div>
  
</div>
<div id="outer-container" class="hide-area">
<div id="container">
  <div id="menu-outer" class="slide-down">
    <div id="menu-inner">
      <div id="brand">
        
        <a onClick="openUserCard()">
          <img id="avatar" src="/images/me3.jpg"/>
          <div id="homelink">Cellophane</div>
        </a>
      </div>
      <div id="menu-list">
        <ul>
        
        
          
            <li>
          
            <a href="/index.html">首页</a>
            
          </li>
        
          
            <li>
          
            <a href="/archives">文章</a>
            
          </li>
        
          
            <li>
          
            <a href="/tags">标签</a>
            
          </li>
        
          
            <li>
          
            <a href="/categories">分类</a>
            
          </li>
        
        </ul>
      </div>
      <div id="show-menu">
        <button>Menu</button>
      </div>
    </div>
  </div>

  <div id="content-outer">
    <div id="content-inner">
      
      
  

  <article id="post">
    <h1>RocketMQ 学习</h1>
    <p class="page-title-sub">
      <span id = "post-title-date">撰写于 2020-02-27</span>
      
      
      
      <span id = "post-title-tags">
      标签
      
      
        
        
        <a href="/tags/消息队列/">消息队列</a>
      
        
          /
        
        
        <a href="/tags/RocketMQ/">RocketMQ</a>
      
      </span>
      
    </p>
    
    <h1 id="RocketMQ-优势"><a href="#RocketMQ-优势" class="headerlink" title="RocketMQ 优势"></a>RocketMQ 优势</h1><p>目前主流的 MQ 主要是 RocketMQ、kafka、RabbitMQ，RocketMQ 相比于 RabbitMQ、kafka 具有主要优势特性有：</p>
<ul>
<li>支持事务型消息（消息发送和 DB 操作保持两方的最终一致性，RabbitMQ、kafka 和 kafka 不支持）</li>
<li>支持结合 RocketMQ 的多个系统之间数据最终一致性（多方事务，二方事务是前提）</li>
<li>支持 18 个级别的延迟消息（RabbitMQ 和 kafka 不支持）</li>
<li>支持指定次数和时间间隔的失败消息重发（kafka 不支持，RabbitMQ 需要手动确认）</li>
<li>支持 consumer 端 tag 过滤，减少不必要的网络传输（RabbitMQ 和 kafka 不支持）</li>
<li>支持重复消费（RabbitMQ 不支持，kafka 支持）</li>
</ul>
<h1 id="消息中间件的组成"><a href="#消息中间件的组成" class="headerlink" title="消息中间件的组成"></a>消息中间件的组成</h1><p>整个 RocketMQ 消息系统主要由如下 4 个部分组成：</p>
<p>从中间件服务角度来看整个 RocketMQ 消息系统（服务端）主要分为：NameSrv 和 Broker 两个部分。</p>
<h2 id="Name-Server"><a href="#Name-Server" class="headerlink" title="Name Server"></a>Name Server</h2><p>提供服务发现和注册，这里主要是管理 Broker，NameSrv 接受来自 Broker 的注册，并通过心跳机制来检测Broker服务的健康性。</p>
<p>提供路由功能，集群(这里是指以集群方式部署的 NameSrv)中的每个 NameSrv 都保存了 Broke r集群(这里是指以集群方式部署的 Broker)中整个的路由信息和队列信息。这里需要注意，在 NameSrv 集群中，每个 NameSrv 都是相互独立的，所以每个 Broker 需要连接所有的 NameSrv，每创建一个新的 topic  都要同步到所的 NameSrv 上</p>
<p>Name Server 是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。</p>
<h2 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h2><p>主要是负责消息的存储、传递、查询以及高可用(HA)保证等。其由如下几个子模块（源码总体上也是这么拆分的）构成：</p>
<ul>
<li>remoting：是 Broker 的服务入口，负责客户端的接入（Producer 和 Consumer）和请求处理。</li>
<li>client：管理客户端和维护消费者对于 Topic 的订阅。</li>
<li>store：提供针对存储和消息查询的简单的API（数据存储在物理磁盘）。</li>
<li>HA：提供数据在主从节点间同步的功能特性。</li>
<li>Index：通过特定的 key 构建消息索引，并提供快速的索引查询服务。</li>
</ul>
<h2 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h2><p>消息的生产者，由用户进行分布式部署，消息由 Producer 通过多种负载均衡模式发送到 Broker 集群，发送低延时，支持快速失败。</p>
<p>支持生产者的 synchronous, asynchronous and one-way（同步，异步，单向发送）</p>
<h2 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h2><p>消息的消费者，也由用户部署，支持 PUSH 和 PULL 两种消费模式，支持集群消费和广播消息，提供实时的消息订阅机制，满足大多数消费场景。</p>
<p><img src="/images/rmq-liucheng.jpg" alt="信息流转"></p>
<h2 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h2><p>主题，发布订阅模式下的消息统一汇集地，不同生产者向 topic 发送消息，由 MQ 服务器分发到不同的订阅者，实现消息的广播。</p>
<h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><p>队列，PTP 模式下，特定生产者向特定 queue 发送消息，消费者订阅特定的 queue 完成指定消息的接收</p>
<h2 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h2><p>消息体，根据不同通信协议定义的固定格式进行编码的数据包，来封装业务数据，实现消息的传输</p>
<h1 id="消息中间件模式分类"><a href="#消息中间件模式分类" class="headerlink" title="消息中间件模式分类"></a>消息中间件模式分类</h1><h2 id="点对点"><a href="#点对点" class="headerlink" title="点对点"></a>点对点</h2><p>PTP 点对点:使用 queue 作为通信载体</p>
<p>消息生产者生产消息发送到 queue 中，然后消息消费者从 queue 中取出并且消费消息。</p>
<p>消息被消费以后，queue 中不再存储，所以消息消费者不可能消费到已经被消费的消息。Queue 支持存在多个消费者，但是对一个消息而言，只会有一个消费者可以消费。</p>
<h2 id="发布-订阅"><a href="#发布-订阅" class="headerlink" title="发布/订阅"></a>发布/订阅</h2><p>Pub/Sub 发布订阅（广播）：使用 topic 作为通信载体</p>
<p>消息生产者（发布）将消息发布到 topic 中，同时有多个消息消费者（订阅）消费该消息。和点对点方式不同，发布到 topic 的消息会被所有订阅者消费。</p>
<p>queue 实现了负载均衡，将 producer 生产的消息发送到消息队列中，由多个消费者消费。但一个消息只能被一个消费者接受，当没有消费者可用时，这个消息会被保存直到有一个可用的消费者。</p>
<p>topic 实现了发布和订阅，当你发布一个消息，所有订阅这个 topic 的服务都能得到这个消息，所以从 1 到 N 个订阅者都能得到一个消息的拷贝。</p>
<p>RocketMQ-nameSrv 用于管理所有 broker 的信息，以便于 Producer 和 Consumer 能够获取到正确的 Broker 信息，进行业务处理；</p>
<p>可以看到 NameSrv 的主要管理内容如下：</p>
<ol>
<li><p>接收 Broker 的注册，注销请求</p>
</li>
<li><p>Producer 获取 topic 下的所有 BrokerQueue，put 消息</p>
</li>
<li><p>Consumer 获取 topic 下所有的 BrokerQueue，get 消息</p>
</li>
</ol>
<p>所以可以看到 NameSrv 主要是维护了 Broker 相关的内容，进行存取。</p>
<h1 id="消息可靠性"><a href="#消息可靠性" class="headerlink" title="消息可靠性"></a>消息可靠性</h1><ol>
<li>Broker 异常 Crash</li>
<li>OS Crash</li>
<li>机器掉电，但是能立即恢复供电情况。</li>
<li>机器无法开机（可能是 cpu、主板、内存等关键设备损坏）</li>
<li>磁盘设备损坏。</li>
</ol>
<p>前面三种 RockerMQ 可以保证消息不丢，或者丢失少量数据（依赖刷盘方式是同步还是异步）。<br>后面两种属于单点故障，无法恢复。RocketMQ 在这两种情况下，通过异步复制，保证 99% 的消息不丢，同步双鞋可以完全避免单点，但是会影响性能。</p>
<h1 id="回溯消费"><a href="#回溯消费" class="headerlink" title="回溯消费"></a>回溯消费</h1><p>回溯消费是指 Consumer 已经消费成功的消息，由于业务上需求需要重新消费，要支持此功能，Broker 在向 Consumer 投递成功消息后，消息仍然需要保留。并且重新消费一般是按照时间维度，例如由于 Consumer 系统故障，恢复后需要重新消费 1 小时前的数据，那么 Broker 要提供一种机制，可以按照时间维度来回退消费进度。<br>RocketMQ 支持按照时间回溯消费，时间维度精确到毫秒，可以向前回溯，也可以向后回溯。</p>
<h1 id="RocketMQ-集群模式"><a href="#RocketMQ-集群模式" class="headerlink" title="RocketMQ 集群模式"></a>RocketMQ 集群模式</h1><p>RocketMQ 集群部署有多种模式，对于 NameSrv 来说可以同时部署多个节点，并且这些节点间也不需要有任何的信息同步，这里因为每个 NameSrv 节点都会存储全量路由信息，在 NameSrv 集群模式下，每个 Broker 都需要同时向集群中的每个 NameSrv 节点发送注册信息，所以这里对于 NameSrv 的集群部署来说并不需要做什么额外的设置。</p>
<p>而对于Broker集群来说就有多种模式了，下面先绍下这几种模式，然后再来看看生产级的部署方式是什么</p>
<ul>
<li>单个Master模式<br>一个 Broker 作为主服务，不设置任何 Slave，很显然这种方式风险比较大，存在单节点故障会导致整个基于消息的服务挂掉，所以生产环境不可能采用这种模式。</li>
<li>多 Master 模式<br>这种模式的 Broker 集群，全是 Master，没有 Slave 节点。这种方式的优缺点如下：</li>
</ul>
<p>优点：配置会比较简单一些，如果单个 Master 挂掉或重启维护的话对应用是没有什么影响的。如果磁盘配置为 RAID10（服务器的磁盘阵列模式）的话，即使在机器宕机不可恢复的情况下，由于 RAID10 磁盘本身的可靠性，消息也不会丢失（异步刷盘丢失少量消息，同步刷盘一条不丢），这种 Broker 的集群模式性能相对来说是最高的。</p>
<p>缺点：就是在单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前是不可以进行消息订阅的，这对消息的实时性会有一些影响。</p>
<ul>
<li>多 Master 多 Slave 模式（异步复制）<br>在这种模式下 Broker 集群存在多个 Master 节点，并且每个 Master 节点都会对应一个 Slave 节点，有多对 Master-Slave，HA(高可用)之间采用异步复制的方式进行信息同步，在这种方式下主从之间会有短暂的毫秒级的消息延迟。</li>
</ul>
<p>优点：在这种模式下即便磁盘损坏了，消息丢失的情况也非常少，因为主从之间有信息备份；并且，在这种模式下消息的实时性也不会受影响，因为 Master 宕机后 Slave 可以自动切换为 Master 模式，这样 Consumer 仍然可以通过Slave进行消息消费，而这个过程对应用来说则是完全透明的，并不需要人工干预。另外，这种模式的性能与多 Master 模式几乎差不多。</p>
<p>缺点：如果 Master 宕机，并且在磁盘损坏的情况下，会丢失少量的消息。</p>
<ul>
<li>多 Master 多 Slave 模式（同步复制）<br>这种上一个模式差不多，只是 HA 采用的是同步双写的方式，即主备都写成功后，才会向应用返回成功。</li>
</ul>
<p>优点：在这种模式下数据与服务都不存在单点的情况，在 Master 宕机的情况下，消息也没有延迟，服务的可用性以及数据的可用性都非常高。</p>
<p>缺点：性能相比于异步复制来说略低一些（大约10%）。另外一个缺点就是相比于异步复制，目前 Slave 备机还暂时不能实现自动切换为 Master，可能后续的版本会支持 Master-Slave 的自动切换功能。</p>
<p>综合考虑以上集群模式的优缺点，在实际生产环境中目前基于 RocketMQ 消息集群的部署方式基本都是采用多 Master 多 Slave（异步复制）这种模式。<br><img src="/images/rocketmq.png" alt="RocketMQ 集群部署结构"></p>
<h1 id="下游服务如果处理完成后但是通知-Brocker-的过程中挂掉了怎么办"><a href="#下游服务如果处理完成后但是通知-Brocker-的过程中挂掉了怎么办" class="headerlink" title="下游服务如果处理完成后但是通知 Brocker 的过程中挂掉了怎么办"></a>下游服务如果处理完成后但是通知 Brocker 的过程中挂掉了怎么办</h1><p>在正常的流程中，下游服务等待消费 Topic 的消息并进行自身本地数据库事务的处理，如果处理成功则会主动通知可靠消息服务，可靠消息服务此时就会将消息的状态更新为“已完成”；反之，处理失败下游服务就无法再主动向可靠消息服务发送通知消息了。</p>
<p>可靠消息服务会启动相应的后台线程，轮询一直处于“已发送”状态的消息，判断状态持续时间是否超过了规定时间，如果超时，可靠消息服务就会再次向 MQ 服务投递此消息，从而确保消息能被再次消费处理。（注意，也可能出现下游服务处理成功，但是通知消息发送失败的情况，所以为了确保幂等，下游服务也需要在业务逻辑上做好相应的防重处理）。</p>
<h1 id="启动源码分析"><a href="#启动源码分析" class="headerlink" title="启动源码分析"></a>启动源码分析</h1><p>下面是一个很简单的服务端启动的两行源码</p>
<pre class="line-numbers language-java"><code class="language-java">MQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动源码的逻辑主要集中在start方法里面</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. 设置生产组信息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span><span class="token function">withNamespace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>producerGroup<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 2. 重点，生产者进行启动</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducerImpl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> traceDispatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 3. RocketMQ在4.4.0 Release 版本中支持了消息轨迹特性，这一特性的增加能够让我们对消息从生产到存储到消费这一整个流程有一个清晰的掌握，配合上 console1.0.1 以上版本的图形化界面，对于错误排查及日常运维是一个很有用处的 feature</span>
            traceDispatcher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"trace dispatcher start failed "</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>DefaultMQProducerImpl start方法</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 调用真正的初始化方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>真正的 start 方法上拥有这个 startFactory 参数 ， 一个 boolean 参数，用来标识是否启动 <strong>mQClientFactory</strong></p>
<p>下面看一下这个方法</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 生产者初始化
 *
 * @param startFactory 用来表示，是否初始化mQClientFactory
 * @throws MQClientException
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> startFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 首次调用该方法时serviceState = CREATE_JUST ， 等待创建</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> CREATE_JUST<span class="token operator">:</span>
            <span class="token comment" spellcheck="true">// 1. 一进来，就默认状态为失败，主要是为了防止重复执行</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> ServiceState<span class="token punctuation">.</span>START_FAILED<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 2. 检查生产组名称配置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 3. 如果生产组名称不等于 CLIENT_INNER_PRODUCER ， 则需要吧instanceName修改一下</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                    <span class="token function">equals</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>CLIENT_INNER_PRODUCER_GROUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">changeInstanceNameToPID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 4. 创建一个和broker交互的MQ实例</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory <span class="token operator">=</span> MQClientManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAndCreateMQClientInstance</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">,</span> rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 5. 注册生产组信息，到本地的MAP里面去</span>
            <span class="token keyword">boolean</span> registerOK <span class="token operator">=</span> mQClientFactory<span class="token punctuation">.</span><span class="token function">registerProducer</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registerOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果注册不成功，那么需要把服务的启动状态设置为CREATE_JUST，</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> ServiceState<span class="token punctuation">.</span>CREATE_JUST<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">"The producer group["</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span>
                        <span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] has been created before, specify another name please."</span> <span class="token operator">+</span> FAQUrl<span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span>FAQUrl<span class="token punctuation">.</span>GROUP_NAME_DUPLICATE_URL<span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 生产者启动是，默认的 topic = TBW102 , 放入到本地的topic的ConcurrentHashMap中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>topicPublishInfoTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getCreateTopicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TopicPublishInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 启动一个生产组时，只有一次startFactory = true, 因为在mQClientFactory.start();方法中也会调用start方法，只不过startFactory = false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>startFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 6. 启动MQ实例</span>
                mQClientFactory<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"the producer [{}] start OK. sendMessageWithVIPChannel={}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">isSendMessageWithVIPChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 启动成功</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> ServiceState<span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> RUNNING<span class="token operator">:</span>
        <span class="token keyword">case</span> START_FAILED<span class="token operator">:</span>
        <span class="token keyword">case</span> SHUTDOWN_ALREADY<span class="token operator">:</span>
            <span class="token comment" spellcheck="true">// 正在运行， 启动失败，准备关闭，这3个状态下，如果还有人调用start方法，那么就会直接报错了</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">"The producer service state not OK, maybe started once, "</span>
                    <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState
                    <span class="token operator">+</span> FAQUrl<span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span>FAQUrl<span class="token punctuation">.</span>CLIENT_SERVICE_NOT_OK<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 7. 设置发送心跳给broker</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">sendHeartbeatToAllBrokerWithLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在一开始的状态量为 CREAT_JUST,可以顺利进入具体的开始实现，同时立马将状态修改为失败，主要是为了防止重复执行</p>
<p>对生产者的 group 名称做校验</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
    Validators<span class="token punctuation">.</span><span class="token function">checkGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 生产组名称不能为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">"producerGroup is null"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 生产组名称不能 等于 DEFAULT_PRODUCER</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>
            DEFAULT_PRODUCER_GROUP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">"producerGroup can not equal "</span> <span class="token operator">+</span> MixAll<span class="token punctuation">.</span>DEFAULT_PRODUCER_GROUP <span class="token operator">+</span> <span class="token string">", please specify another one."</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果生产组名称不等于 CLIENT_INNER_PRODUCER （mQClientFactory作为和broker交互的实例里面初始化的名称就是这个） ， 则需要把instanceName修改一下 ，因为, 执行changeInstanceNameToPID方法</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//instanceName如果不设置的话就是DEFAULT</span>
<span class="token keyword">private</span> String instanceName <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"rocketmq.client.name"</span><span class="token punctuation">,</span> <span class="token string">"DEFAULT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeInstanceNameToPID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>instanceName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"DEFAULT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 更新DEFAULT = 当前JVM的进程PID</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>instanceName <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>UtilAll<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建一个和broker交互的MQ实例 ， 通过MQClientManager这个类创建MQClient</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> MQClientInstance <span class="token function">getAndCreateMQClientInstance</span><span class="token punctuation">(</span><span class="token keyword">final</span> ClientConfig clientConfig<span class="token punctuation">,</span> RPCHook rpcHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 构建MQClientId， 这个ID很重要，在MQ多个集群的时候，这个如果不注意会出现问题。</span>
    String clientId <span class="token operator">=</span> clientConfig<span class="token punctuation">.</span><span class="token function">buildMQClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 通过clientId从factoryTable中获取是否已经被创建过，如果已经被创建过，则直接复用</span>
    MQClientInstance instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 为空，则继续创建MQClientInstance ，</span>
        instance <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MQClientInstance</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">.</span><span class="token function">cloneClientConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>factoryIndexGenerator<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientId<span class="token punctuation">,</span> rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        MQClientInstance prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>clientId<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> prev<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Returned Previous MQClientInstance for clientId:[{}]"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Created new MQClientInstance for clientId:[{}]"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// org.apache.rocketmq.client.ClientConfig</span>
<span class="token keyword">public</span> String <span class="token function">buildMQClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 本机IP</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClientIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 实例名称</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInstanceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>UtilAll<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unitName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册生产组信息，到本地的 MAP 里面去，启动 MQ 实例 ，MQClientInstance.start 方法</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> CREATE_JUST<span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> ServiceState<span class="token punctuation">.</span>START_FAILED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// If not specified,looking address from name server</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 负责网络通信的接口调用启动</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 初始化各类定时任务</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startScheduledTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 开启pullService , 针对consumer，到讲解consumer时再做详细说明</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 启动RebalanceService服务，针对consumer，到讲解consumer时再做详细说明</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 启动一个groupName为CLIENT_INNER_PRODUCER的DefaultMQProducer，</span>
                <span class="token comment" spellcheck="true">// 用于将消费失败的消息发回broker,消息的topic格式为%RETRY%ConsumerGroupName。</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getDefaultMQProducerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"the client factory [{}] start OK"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> ServiceState<span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RUNNING<span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SHUTDOWN_ALREADY<span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> START_FAILED<span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">"The Factory object["</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] has been created before, and failed."</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="问题定位方法"><a href="#问题定位方法" class="headerlink" title="问题定位方法"></a>问题定位方法</h1><p>什么情况下需要查看 mq 的 log 定位问题：当出现 mq 消费丢失时。</p>
<p>如贷出时，产品系统更新产品数据成功后，是通过发送通知消息到 mq，再由 mq 推送消费请求到列表系统，列表系统写入数据库，我们才能在借入列表页看到这个待借标的的数据更新。如果对一个标贷出之后经过了一段时间（不应超过几分钟）仍旧无法在列表页看到该标的相关变化（前提要确保页面确实刷新且返回了数据），而产品系统已成功入库更新了该产品，我们就可通过产品系统日志查看最后是否有推送相关 topic 给 mq。如果日志显示推送了且 mq 返回成功，就有很大可能是 mq 消费丢失导致了列表系统没有获取到更新信息，此时如果列表系统没有相关日志如消费处理失败等记录，且数据库没有更新，那基本可以确定就是 mq 消费过程中出现了丢失。</p>
<p>为什么会出现 mq 消费丢失:mq 同其他系统间调用一样有可能出现各种情况的调用失败，因此我们需要通过查看 mq 日志定位具体问题。</p>
<ul>
<li>最常见的，容器组内没有拉 RocketMQ 容器，导致错误消费。</li>
<li>如容器组内只有消费者，则消费者（前例中的列表系统）会注册到基准的 mq，但消费者没有外网，或代码有问题／不够新（不是 master 分支或很久没有重启更新代码），基准 mq 随机选择一个消费者推送时有一定可能会推送到该机器，此时消费失败。</li>
<li>如容器组内只有生产者，则生产者（前例中的产品系统）会推送到基准的 mq，而基准的消费者（前例中的列表系统）没有新的代码去消费该 mq。</li>
<li>配置错误，如 mq 没有回调到消费者正确的路径</li>
<li>环境问题，如 mq 容器启动失败</li>
<li>网络问题，如 mq 和消费者之间网络不同导致调用失败等</li>
</ul>
<h2 id="RocketMQ-基本配置："><a href="#RocketMQ-基本配置：" class="headerlink" title="RocketMQ 基本配置："></a>RocketMQ 基本配置：</h2><p>RocketMQ 虽然包含很多知识点，但我们 debug 时主要关注 <code>nameserver</code>（负责关联请求中topic和消费者的关系）和 <code>broker</code>（负责处理具体的消费）。业务系统在启动后，会通过自己系统内的配置找到 mq 的 <code>nameserver</code> 得到 <code>broker</code> 的地址（然后针对 java 的业务系统会跟 <code>broker</code> 建立长链接，针对 php 的业务系统 mq 会将该对应关系保存在数据）。<code>nameserver</code> 上会记录一个 <code>topic</code> 已经有多少个消费者连接了，<code>broker</code> 上会记录最后是哪个消费者消费了一个具体的信息。</p>
<p>如何查看 <code>topic</code> 的注册消费者：</p>
<ul>
<li>登陆 nameserver 机器，cd 到命令目录</li>
</ul>
<pre class="line-numbers language-sh"><code class="language-sh">sh mqadmin topicList -n 100.73.41.56:9876 -c |grep T_CONTRACT_EVENT（topic名字）
sh mqadmin consumerConnection -n 100.73.41.56:9876 -g S_JIAOYI_CG_T_JDB_CONTRACT_EVENT（上个步骤搜到的）
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如何查看某个消息具体被谁（哪个容器）消费了：<br>在业务系统 log 里找到该 topic 对应的 msgIG，如：topic:T_CONTRACT_EVENT, key:T_CONTRACT_EVENT_661321962570698890, orderID:661321962570698891, msgID:6449293900002A9F000000001564A2B4。</p>
<p>查看 mq 日志：登陆 broker 机器，cd 到日志目录，grep msgID pullmsgLive.log<br>消费方式的区别：消费者是 php 的系统是 mq 回调消费者（dba 在 mqagent 配置一个回调路径），消费者是 java 的系统是主动去 mq 消费（轮询）。暂时都是这样的，以后可能会改。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://www.jianshu.com/p/2838890f3284" target="_blank" rel="external">Rocketmq原理&amp;最佳实践</a></li>
<li><a href="http://blog.csdn.net/xxxxxx91116/article/details/50353146" target="_blank" rel="external">《RocketMq》三、NameServer</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzU3NDY4NzQwNQ==&amp;mid=2247484461&amp;idx=1&amp;sn=72794d12ffe3c8ec3520fdba1c87c3b3&amp;chksm=fd2fd5efca585cf955d240bbabd99b24262d255a3880454297f10a84e4c38445bc7b9d3ba339&amp;scene=21#wechat_redirect" target="_blank" rel="external">【分布式事务】基于RocketMQ搭建生产级消息集群？</a></li>
<li><a href="http://jm.taobao.org/2017/01/12/rocketmq-quick-start-in-10-minutes/" target="_blank" rel="external">十分钟入门RocketMQ</a></li>
<li><a href="https://www.cnblogs.com/rjzheng/p/8994962.html" target="_blank" rel="external">【原创】分布式之消息队列复习精讲</a></li>
<li><a href="https://www.javazhiyin.com/31853.html" target="_blank" rel="external">分布式事务之如何基于RocketMQ的事务消息特性实现分布式系统的最终一致性？</a></li>
</ul>

  </article>
  <div class="random-toc-area">
  <button class="btn-hide-toc btn-hide-toc-show" style="display: none" onclick="TOCToggle()">显示目录</button>
  <button class="btn-hide-toc btn-hide-toc-hide" onclick="TOCToggle()">隐藏目录</button>
  <div class="random-toc">
    <h2>目录</h2>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-优势"><span class="toc-text">RocketMQ 优势</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息中间件的组成"><span class="toc-text">消息中间件的组成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Name-Server"><span class="toc-text">Name Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Broker"><span class="toc-text">Broker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Producer"><span class="toc-text">Producer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer"><span class="toc-text">Consumer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Topic"><span class="toc-text">Topic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Queue"><span class="toc-text">Queue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Message"><span class="toc-text">Message</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息中间件模式分类"><span class="toc-text">消息中间件模式分类</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#点对点"><span class="toc-text">点对点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发布-订阅"><span class="toc-text">发布/订阅</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#消息可靠性"><span class="toc-text">消息可靠性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#回溯消费"><span class="toc-text">回溯消费</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RocketMQ-集群模式"><span class="toc-text">RocketMQ 集群模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#下游服务如果处理完成后但是通知-Brocker-的过程中挂掉了怎么办"><span class="toc-text">下游服务如果处理完成后但是通知 Brocker 的过程中挂掉了怎么办</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#启动源码分析"><span class="toc-text">启动源码分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#问题定位方法"><span class="toc-text">问题定位方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RocketMQ-基本配置："><span class="toc-text">RocketMQ 基本配置：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文章"><span class="toc-text">参考文章</span></a></li></ol>
  </div>
</div>

  
<nav id="pagination">
  

  

  
    <a href="/2020/02/19/Head First设计模式阅读笔记/" class="next">下一篇 Head First设计模式阅读笔记 &rarr;</a>
  
</nav>

  <!-- JiaThis Button BEGIN -->

<!-- JiaThis Button END -->


      
      
    </div>
  </div>

  <div id="bottom-outer">
    <div id="bottom-inner">
      Site by Cellophane using
      <a href="http://hexo.io">Hexo</a> & <a href="https://github.com/stiekel/hexo-theme-random">Random</a>
      <br>
      
    </div>
  </div>
</div>

</div>


<div id="user-card">
  <div class="center-field">
    <img class="avatar" src="/images/me3.jpg">
    <p id="description"></p>
    <ul class="social-icon">
  
  
    <li>
      <a href="https://github.com/liuyuqi21">
        
          <i class="icon iconfont github">&#xe606;</i>
        
      </a>
    </li>
  
    <li>
      <a href="https://www.zhihu.com/people/ding-wei-33-1/activities">
        
          <i class="icon iconfont zhihu">&#xe60b;</i>
        
      </a>
    </li>
  
    <li>
      <a href="http://chensd.com">
        
          <i class="icon iconfont rss">&#xe60e;</i>
        
      </a>
    </li>
  
</ul>
  </div>
</div>


<div id="btn-view">Hide</div>

<script>
// is trigger analytics / tongji script
var isIgnoreHost = false;

if(window && window.location && window.location.host) {
  isIgnoreHost = ["localhost","127.0.0.1"].some(function(address){
    return 0 === window.location.host.indexOf(address);
  });
}

var isTriggerAnalytics = !( true && isIgnoreHost );

</script>




  
  
    <script src="/js/jquery-2.2.3.min.js"></script>
  
    <script src="/js/vegas.min.js"></script>
  
    <script src="/js/random.js"></script>
  
    <script src="/js/highlight.pack.js"></script>
  
    <script src="/js/jquery.mousewheel.pack.js"></script>
  
    <script src="/js/jquery.fancybox.pack.js"></script>
  
    <script src="/js/jquery.fancybox-thumbs.js"></script>
  
    <script src="/js/plyr.js"></script>
  
    <script src="/js/prism.js"></script>
  

<script>

  // fancybox
  var backgroundImages = [];
  
  $('#post').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox') || $(this).parent().hasClass('fancybox-thumb')) return;
      var alt = this.alt || this.title;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'post' + i);
    });
  });
  $(".fancybox").fancybox();

var vegasConfig = {"preload­Image":true,"transition":["flash"],"timer":true,"delay":1500000,"shuffle":true,"count":12};
var unsplashConfig = {"gravity":"center"};
// is show background images
var turnoffBackgroundImage = false;




var backgroundColor = "34495E";

$(".fancybox-thumb").fancybox({
  prevEffect: 'none',
  nextEffect: 'none',
  helpers: {
    title: {
      type: 'outside'
    },
    thumbs: {
      width: 50,
      height: 50
    }
  }
});

// show video with plyr
$(".video-container iframe").each(function(i){
  var url = $(this).attr('src');
  var id = url.split('/').pop();
  var plyrContainer = document.createElement('div');
  plyrContainer.className = 'plyr';
  var plyrElement = document.createElement('div');
  plyrElement.dataset.videoId = id;
  switch(true) {
    case url.search('youtube.com') >= 0:
      plyrElement.dataset.type = 'youtube';
      break;
    case url.search('vimeo.com') >= 0:
      plyrElement.dataset.type = 'vimeo';
      break;
    default:
      return;
  };
  plyrContainer.appendChild(plyrElement);
  $(this).parent().html(plyrContainer);
});
plyr.setup('.plyr', {iconUrl: '/css/sprite.svg'});
</script>
</body>
</html>

